!function(a){a.fn.oldReady=a.fn.ready,a.fn.ready=function(b){return a.fn.oldReady(function(){try{b&&b.apply(a,arguments)}catch(a){console.error(a)}})}}(jQuery);var jquery_topics={},spillboxAdSlots=[];jQuery.Topic=function(a){var b,c=a&&jquery_topics[a];return c||(b=jQuery.Callbacks(),c={publish:b.fire,subscribe:b.add,unsubscribe:b.remove},a&&(jquery_topics[a]=c)),c};var MPPUserManage=function(){function a(a){$.extend(Ea,a),Ea.force_login&&$(".not-optional",Ea.lightbox_div).hide(),Ea.allow_remind_me||$(".V4-ask-later",Ea.lightbox_div).hide(),c(),$(Ea.login_wrapper).show(),$(Ea.lightbox_div).show()}function b(){$("div",Ea.lightbox_div).show(),$(Ea.lightbox_div).show()}function c(){d(),$(Ea.skip_link,Ea.manage_user).on("click",function(){ga("send","event","PDC Register","User Manage","Skip")}),$(Ea.help_link).on("click",function(){x(Ea.help_message);var a=!1;$(this).hasClass("from-profile")&&(a="profile"),_(a),ga("send","event","PDC Logins","Help Link")}),$(Ea.forgot_password_link).on("click",function(){x(Ea.forgot_password),I()}),$(Ea.change_password_link).on("click",function(){x(Ea.change_password),la()}),$(Ea.login_link).on("click",function(){x(Ea.login_area),O()}),$(Ea.register_link).on("click",function(){x(Ea.register_new),X(),ga("send","event","PDC Register","Register Display","Login Create Link")}),$(Ea.manage_user_link).on("click",function(){x(Ea.register_new),X()}),$(Ea.close_link).on("click",function(){this!=$(Ea.redirect_home_link)[0]&&y()}),$(Ea.remind_me_link).on("click",function(){k(),ga("send","event","PDC Logins","Ask Next Week")}),$(Ea.redirect_home_link).on("click",function(){ga("send","event","PDC Logins","Login Close"),Ea.force_login?window.location.hostname.indexOf("passages")<0?z("Please create a free account or login to continue reading. Thank you for your support.",Ea.home_page,1500):y(Ea.home_page):y()}),$("input",Ea.lightbox_div).on("change",function(){oa(this)}),Ba(),w(),f()}function d(){$(Ea.button_selector,Ea.lightbox_div).on("click",function(){switch(na(this),Ea.current_state){case Ea.login_area:ga("send","event","PDC Logins","Login Continue")}})}function e(){$(Ea.button_selector,Ea.lightbox_div).unbind("click")}function f(){$(document).keypress(function(a){"13"==a.which&&(a.preventDefault(),na())})}function g(){$(document).unbind("keypress")}function h(a){a&&m("temp_url",a,!1,1)}function i(){var a=cookiejar.fetch("temp_url");return!!a&&a}function j(a){n("temp_url"),window.location.href=a}function k(){var a=new Date,b=a.getTime(),c=b+6048e5,d=new Date(c);m("remind_me",d),z("We'll remind you soon!")}function l(a){$.jStorage.flush(),a.click_user&&o(a.click_user),a.mpp_user&&p(a.mpp_user),a.session_id&&m("session_id",a.session_id)}function m(a,b,c,d){var e=d?d:Ea.cookie_time;c?subcookiejar.bake(a,b,e,"/",Ea.cookie_domain):cookiejar.bake(a,b,e,"/",Ea.cookie_domain)}function n(a){cookiejar.bake(a,"",-1,"/",Ea.cookie_domain)}function o(a){r(),m("at",a.pluck),m("recorded","true"),m("curUserInfo",a,!0),m("UID",a.UID)}function p(a){q(),m("v4_token",a.v4_token),m("v4_clientuserid",a.clientuserid)}function q(){n("v4_token"),n("v4_clientuserid")}function r(){n("curUserInfo"),n("at"),n("UID")}function s(){q(),r(),WFPUser.logUserOut()}function t(){var a={};for(var b in Ea.legacy_cookie_params){var c=Ea.legacy_cookie_params[b],d=subcookiejar.fetch("curUserInfo",c);d&&(a[c]=d)}return a.account_state=subcookiejar.fetch("v4_user_state","account_state"),a}function u(){var a=subcookiejar.fetch("v4_user_state","account_state");return!!a&&!("PayAsYouGo"==a||"Trial"==a||"SATURDAY"==a)}function v(a){return subcookiejar.fetch("curUserInfo",a)?subcookiejar.fetch("curUserInfo",a):""}function w(){var a=$('input[name="recaptchaPublicKey"]',Ea.lightbox_div).val();"object"==typeof grecaptcha&&"function"==typeof grecaptcha.render?(grecaptcha.render("v4-recaptcha-new",{sitekey:a,callback:MPPUserManage.clearCaptchaErrorMessage}),grecaptcha.render("v4-recaptcha-migrate",{sitekey:a,callback:MPPUserManage.clearCaptchaErrorMessage}),grecaptcha.render("v4-recaptcha-messages",{sitekey:a,callback:MPPUserManage.clearCaptchaErrorMessage})):setTimeout(function(){MPPUserManage.handleRecaptchaLoad()},1e3)}function x(a){pa(),$(Ea.current_state).hide(),Ea.current_state=a,$(Ea.current_state).show(),Ea.form_invalid=null,$(Ea.error_message).hide(),$(Ea.success_message).hide()}function y(a){Ea.form_invalid=null,$(Ea.current_state).hide(),$(Ea.login_wrapper).hide(),pa(),Ea.current_state=null,Ea.form_invalid=null,WFPModal.close();var b=i();a&&a!=window.location.href?j(a):b?j(b):Ea.hard_redirect&&j(Ea.hard_redirect)}function z(a,b,c){a&&va(a),c=c||750,setTimeout(function(){y(b),null!==Ga&&"pending"===Ga.state()&&(Ha?(WFPApp.v2Init(),Ha=!1,Ga.resolve()):Ga.reject())},c)}function A(a){var b={};if(a.email.length&&a.name.length&&a.feedback.length){var c=/^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;return!c.test(a.email)&&(b.email="Please enter a valid e-mail address",b)}return a.email||(b.email="Please enter your e-mail address"),a.name||(b.name="Please enter your name"),a.feedback||(b.feedback="Please provide some feedback"),b}function B(a){var b={};if(a.email.length&&a.password.length){var c=/^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;return!c.test(a.email)&&(b.email="Please enter a valid e-mail address",b)}return a.email||(b.email="Please enter your e-mail address"),a.password||(b.password="Please enter a valid password"),b}function C(a){var b=D(a),c=a.password.length;if(!b&&c)return!1;var d={};return c||(d.password="Please enter your current password"),b&&(d=$.extend(d,b)),d}function D(a){if(a.new_password.length&&a.confirm_password.length&&a.new_password===a.confirm_password)return!1;var b={};return a.new_password.length?a.confirm_password.length?b.confirm_password="Password and confirmation password do not match":b.confirm_password="Missing confirmation password":b.new_password="Please enter a valid password",b}function E(a){if(a.password.length&&a.confirm_password.length&&a.password===a.confirm_password)return!1;var b={};return a.password.length?a.confirm_password.length?b.confirm_password="Password and Confirmation Password do not match":b.confirm_password="Missing confirmation password":b.password="Please enter a valid password",b}function F(a){if(a.userName.length)return!1;var b={userName:"Please enter a username"};return b}function G(a){var b=[],c={},d=B(a),e=E(a);$.extend(c,d),$.extend(c,e),d.validation_message&&b.push(d.validation_message),e.validation_message&&b.push(e.validation_message),a.agreeTerms&&"yes"==a.agreeTerms||(c.agreeTerms=!1,Ea.terms_error_show++,ga("send","event","PDC Register","Terms Error ",Ea.terms_error_show)),a.CASLconsent&&"yes"==a.CASLconsent||(c.CASLconsent=!1,Ea.casl_error_show++,ga("send","event","PDC Register","CASL Error",Ea.casl_error_show));var f=$('textarea[name="g-recaptcha-response"]',Ea.current_state).val();if(""!==f&&void 0!==f||(c.reCAPTCHA=!1,Ea.recaptcha_error_show++,ga("send","event","PDC Register","reCaptcha Error",Ea.recaptcha_error_show)),b.length>0){var g="";for(var h in b)g=g+b[h]+"<br />";c.validation_message=g}var i=0;for(var j in c)Object.prototype.hasOwnProperty.call(c,j)&&i++;return!!i&&c}function H(a,b){var c=document.createElement("input");$(c).attr("type","hidden"),$(c).attr("name",a),$(c).attr("value",b),$("form",Ea.current_state).append(c)}function I(a){$(Ea.forgot_password).show();var b=$('input[name="email"]',Ea.forgot_password).get();$(b).focus(),a&&$(b).val(a),Ea.current_state=Ea.forgot_password,Ea.form_invalid=function(a){return!a.email.length&&{email:"Please enter your e-mail address"}}}function J(a){switch(a.loginState){case"forgot-password-sent":x(Ea.login_area),O("Check your email for instructions");var b="";b=null!==Ea.hard_redirect?Ea.hard_redirect:window.location.href,h(b);break;case"missing-credentials":ua("Please enter an e-mail address");break;case"unknown-account":var c=$('input[name="email"]',Ea.current_state).val();x(Ea.register_new);var d=!0;X(d,c);break;case"account-locked":ua("Account locked, please try again in 10 minutes")}}function K(a,b){$(Ea.confirm_forgot_password).show();var c=$('input[name="password"]',Ea.confirm_forgot_password).get();$(c).focus(),Ea.current_state=Ea.confirm_forgot_password,Ea.form_invalid=D,H("verify",a),H("email",b)}function L(a){switch(a.loginState){case"verification-complete":l(a),z("Password updated!");break;case"password-too-weak":case"invalid-credentials":wa(a);break;case"verification-code-mismatch":ua("Please copy and paste the URL from the e-mail and try again.")}}function M(){var a=cookiejar.fetch("v4_token"),b=cookiejar.fetch("v4_clientuserid");return a&&b}function N(a,b){return Ga=$.Deferred(),O(a,b),Ga.promise()}function O(a,b){$(Ea.login_area).show();var c=$('input[name="email"]',Ea.login_area).get();$('input[name="password"]',Ea.login_area).get(),$(c).focus(),Ea.current_state=Ea.login_area,Ea.form_invalid=B,a&&va(a),b&&h(b)}function P(a){var b=$('input[name="email"]',Ea.login_area).val();switch(a.loginState){case"valid-account":"yes"==a.click_user.emailVerified?(l(a),Q(),Ha=!0):(x(Ea.email_verification_waiting),$(".activated-email",Ea.email_verification_waiting).html(a.click_user.email),ga("send","event","PDC Logins","Login Fail Requires Email Verify"));break;case"unknown-account":x(Ea.register_new);var c=!0;X(c,b);break;case"server-fault":case"missing-credentials":wa(a);break;case"invalid-credentials":Fa.hasOwnProperty(b)?Fa[b]++:Fa[b]=1,Fa[b]>=Ea.max_login_attempts?(x(Ea.forgot_password),I(b),ua("You've entered the wrong password "+Fa[b]+" times, please reset it")):wa(a);break;case"account-locked":wa(a);break;case"migrate-click-account":o(a.click_user),x(Ea.register_existing),Y()}}function Q(){ga("send","event","PDC Logins","Login Successful"),z("Logged in Successfully!")}function R(){$(".loggedout").show(),$(".loggedin").hide(),T(".loggedin","hide"),T(".loggedout","show"),T(".isNotSbscrbr","show"),T(".isSbscrbr","hide"),T(".pluck-comm-input-content","hide"),T(".pluck-comm-reply-button","hide"),T(".pluck-comm-rate-controls","hide"),T(".pmobile-comments-submit-wrap","hide"),T(".pmobile-comments-comment","hide"),T(".pmobile-comments-vote-up","hide"),T(".pmobile-comments-vote-down","hide")}function S(a){if($(".loggedout").hide(),$(".loggedin").show(),T(".loggedin","show"),T(".loggedout","hide"),a){if(T(".isSbscrbr","show"),T(".isNotSbscrbr","hide"),T(".pluck-comm-input-content","show"),T(".pluck-comm-reply-button","show"),T(".pluck-comm-rate-controls","show"),T(".pmobile-comments-submit-wrap","show"),T(".pmobile-comments-comment","show"),T(".pmobile-comments-vote-up","show"),T(".pmobile-comments-vote-down","show"),$("#comments_container").hasClass("plck-app-container-loaded")){var b=!!$("#comments_container div:first-child").hasClass("pmobile-app");$("#comments_container").removeClass("plck-app-container-loaded"),$("#comments_container").html(""),b?pluckAppProxy.embedApp("mobile_comments",{plckCommentOnKeyType:"article",plckCommentOnKey:contentId,plckDiscoverySection:pluckSection},{elem:"comments_container"}):pluckAppProxy.embedApp("pluck/comments",{plckCommentOnKeyType:"article",plckCommentOnKey:cid,plckDiscoverySection:pluckSection},{elem:"comments_container"}),pluckAppProxy.registerActivityCallback("CommentsRendered",function(){jQuery(".comments_subscribe").show()})}}else T(".isNotSbscrbr","show"),T(".isSbscrbr","hide"),T(".pluck-comm-input-content","hide"),T(".pluck-comm-reply-button","hide"),T(".pluck-comm-rate-controls","hide"),T(".pmobile-comments-submit-wrap","hide"),T(".pmobile-comments-comment","hide"),T(".pmobile-comments-vote-up","hide"),T(".pmobile-comments-vote-down","hide")}function T(a,b){if(b="show"==b?"display:block;":"display:none;",document.styleSheets)for(var c=0;c<document.styleSheets.length;c++)if("style_pluck_comments"===document.styleSheets[c].title){for(var d=document.styleSheets[c],e=d.cssRules?d.cssRules:d.rules,f=0;f<e.length;f++)e[f].selectorText==a&&(e[f].style.cssText=b);break}}function U(a){if($(a).is(":checked")){var b=$(".casl-wording",Ea.current_state).text().replace(/\s+/g," ").trim();$('input[name="CASLWording"]',Ea.current_state).get().length?$('input[name="CASLWording"]',Ea.current_state).val(b):H("CASLWording",b)}else $('input[name="CASLWording"]',Ea.current_state).get().length?$('input[name="CASLWording"]',Ea.current_state).val("blank"):H("CASLWording","blank")}function V(){$('input[type="checkbox"][name="CASLconsent"]',Ea.current_state).click(function(){U(this)})}function W(){var a={},b=cookiejar.fetch("UID");void 0!==b&&(a.action="edit_account",a.UID=b,ra(a))}function X(a,b,c){a||$(".hide-new",Ea.register_new).hide(),$(Ea.register_new).show(),Ea.current_state=Ea.register_new,Ea.form_invalid=G;var d=$('input[name="email"]',Ea.current_state).get();$(d).focus(),b&&$(d).val(b),c&&$('input[name="password"]',Ea.current_state).val(c),V(),xa(),ga("send","event","PDC Register","Register Display","Clickability Account not found")}function Y(a){$(Ea.register_existing).show(),Ea.current_state=Ea.register_existing,Ea.form_invalid=G;var b=$('input[name="email"]',Ea.current_state).get();$(b).focus();var c=t();c.userID&&(c.forEach(function(a,b){"email"!==b&&a&&H(b,a)}),c.email&&$(b).val(c.email)),V(),xa(),ga("send","event","PDC Register","Register Display","Reset Clickability Password")}function Z(a){switch($('input[name="email"]',Ea.current_state).get(),a.loginState){case"failed-recaptcha":case"server-fault":case"password-too-weak":case"account-already-exists":case"missing-credentials":case"missing-casl":wa(a),Ea.current_state===Ea.register_new?grecaptcha.reset(widgetId1):Ea.current_state===Ea.register_existing&&grecaptcha.reset(widgetId2);break;case"valid-account-username-unavailable":case"valid-account":var b=i();b||(b=Ea.hard_redirect?Ea.hard_redirect:window.location.href),h(b),Ea.casl_error_show>0?ga("send","event","PDC Register","CASL Error Shown"):ga("send","event","PDC Register","No CASL Errors"),x(Ea.email_verification),$(".activated-email",Ea.email_verification).html(a.click_user.email)}}function _(a){g(),a&&"profile"==a&&($(".login-back-btn",Ea.current_context).unbind("click"),$(".login-back-btn",Ea.current_context).click(function(){x(Ea.manage_user),da()})),WFPUser.fetchInfo(),Ea.current_state=Ea.help_message,$(Ea.current_state).show(),Ea.form_invalid=A,$(".accordion h5.active").removeClass("active").click()}function aa(){va("Message sent, thanks for your feedback"),$("input[name=name], input[name=email], textarea[name=feedback]",Ea.current_state).val(""),pa("Send")}function ba(){va("Form sent, thank you!"),setTimeout(function(){y()},3500)}function ca(a,b){if(""!==a){var c=b+" has successfully been unsubscribed from "+a+" email notification";va(c)}da(),setTimeout(function(){$(".profile-accordion .email-alerts").prev().click()},0)}function da(a){if(void 0!==a){$(".V4-close-link",Ea.manage_user).hide(),$(".redirect-url",Ea.manage_user).show(),va("Email Verified!");var b=i();$(".redirect-url",Ea.manage_user).attr("href",b)}else $(".V4-close-link",Ea.manage_user).show(),$(".redirect-url",Ea.manage_user).hide();if(M()){var c=v("userID"),d=Ea.commenting_profile_url.replace(/_USERID_/g,c);$(Ea.commenting_profile_link).attr("href",d);var e=t();$(Ea.subscribe_all_link).click(function(){return ya("on"),!1}),$(Ea.unsubscribe_all_link).click(function(){var a="";return $("#email_pref_list strong").each(function(b,c){a=a+"\n"+$(c).text()}),confirm("You will be removed from the following mailing lists:"+a)&&ya("off"),!1}),$.when($.ajax({url:Ea.sso_url+Ea.email_prefs_url,data:{action:"get_email_prefs",email:e.email},dataType:"jsonp",crossDomain:!0,cache:!1,timeout:2e3})).done(function(a){Ca(a)}),Ea.default_to_payment&&$(".profile-accordion .payment-info h5").removeClass("active").click(),$(Ea.manage_user).show(),Ea.current_state=Ea.manage_user;for(var f in e)if(e[f]){var g=e[f];if(("firstName"==f||"lastName"==f)&&"-"==g||"CASLconsent"==f)continue;"year"==f&&parseInt(g,10)<1900&&(g=1900+parseInt(g,10)),"month"==f||"state"==f?(g.length<2&&(g="0"+g),$('select[name="'+f+'"]',Ea.current_state).val(g)):"email"==f?$("#V4-email").text(g):$('input[name="'+f+'"]',Ea.current_state).val(g)}u()?($(Ea.is_subscriber_selector).show(),$(Ea.is_not_subscriber_selector).hide()):($(Ea.is_subscriber_selector).hide(),$(Ea.is_not_subscriber_selector).show()),H("userID",e.userID),xa(),Ea.form_invalid=F}else x(Ea.login_area)}function ea(a){switch(a.loginState){case"valid-account-username-unavailable":case"valid-account-too-many-additional-emails":case"valid-account-pin-not-found":l(a),wa(a);break;case"valid-account":l(a),pa(),ga("send","event","PDC Register","User Manage","Personal Info Entered"),z("Account updated!");break;default:wa(a)}}function fa(){$(Ea.logout).show(),Ea.current_state=Ea.logout,na()}function ha(a){s(),window.location.href=Ea.home_page}function ia(a,b){$(Ea.activation_check).show(),Ea.current_state=Ea.activation_check,H("verify",a),H("email",b),na()}function ja(a){switch(a.loginState){case"server-fault":case"missing-required-parameters":case"verification-code-mismatch":case"invalid-credentials":wa(a);break;case"unknown-account":x(Ea.register_new),wa(a),X();break;case"verification-complete":l(a),x(Ea.manage_user),da(!0),"undefined"!=typeof _bt&&ka()}}function ka(){var a=t();if(a.email){var b={email:a.email};a.firstName&&a.firstName.length>1&&(b.first_name=a.firstName),a.lastName&&a.lastName.length>1&&(b.last_name=a.lastName),_bt.person.set(b)}}function la(){var a=t();if(a.email){$(Ea.change_password).show(),Ea.current_state=Ea.change_password;var b=$('input[name="password"]',Ea.change_password).get();$(b).focus(),Ea.form_invalid=C,H("email",a.email)}else x(Ea.login_area),O("Please login first")}function ma(a){switch(a.loginState){case"verification-complete":x(Ea.login_area),z("Password changed!");break;case"verification-code-mismatch":case"invalid-credentials":case"password-too-weak":case"missing-parameter":wa(a);break;default:wa(a)}}function na(a){var b=$("form",Ea.current_state).serializeArray(),c={};for(var d in b){var e=b[d];c[e.name]=e.value}var f=!1;null!==Ea.form_invalid&&(f=Ea.form_invalid(c)),$(Ea.error_selector,Ea.current_state).hide(),!f&&c.action?(qa(a),ra(c)):wa(c.action?f:{loginStateMessage:"An unspecified error has occurred, please try again later."})}function oa(a){var b=$(a).attr("name");$(".error-"+b,Ea.current_state).hide()}function pa(a){a||(a="Continue"),$(Ea.button_selector,Ea.current_state).prop("disabled",!1),$(Ea.button_selector,Ea.current_state).each(function(){if("yes"==$(this).attr("data-clicked")){var b=$(this).val();$(this).val($(this).attr("data-message")),$(this).attr("data-message",b),$(this).removeAttr("data-clicked")}else $(this).val(a)})}function qa(a){var b="Submitting...";a&&$(a).attr("data-message")?(b=$(a).attr("data-message"),$(a).attr("data-message",$(a).val()),$(a).attr("data-clicked","yes"),$(a).val(b)):$(Ea.button_selector,Ea.current_state).val(b),$(Ea.button_selector,Ea.current_state).prop("disabled",!0)}function ra(a){e();var b=Ea.sso_link,c=a;c.jsonp="true";var d=c.action;b=WFPUtils.convertAPIUrl(b,d),$.ajax({url:b,data:c,dataType:"jsonp",cache:!1,type:"GET",success:function(a,b){!function(b){sa(a,b)}(d)},error:function(a,b,e){!function(a){c.loginStateMessage="Sorry something went wrong. Please refresh this page and try again",ta(c,a)}(d)}})}function sa(a,b){if(d(),a.loginState)switch(b){case"login":P(a);break;case"login_messages":ba(a);break;case"register":Z(a);break;case"forgot_password":J(a);break;case"change_password":ma(a);break;case"edit_account":ea(a);break;case"verify_email":ja(a);break;case"confirm_forgot_password":L(a);break;case"feedback":aa(a);break;case"logout":ha(a)}else wa(a,b)}function ta(a,b){d(),wa(a)}function ua(a){$(Ea.success_message).hide(),$(Ea.error_message).html("<p>"+a+"</p>").show()}function va(a){$(Ea.error_message).hide(),$(Ea.success_message).html("<p>"+a+"</p>").show()}function wa(a){if(a.validation_message)ua(a.validation_message);else if(a.loginStateMessage)ua(a.loginStateMessage);else{$(Ea.error_message).hide();for(var b in a)za(b,a[b])}pa()}function xa(){$("input,select",Ea.current_state).each(function(){var a=$(this),b=a.val();""!==b?a.parent().addClass("floater"):a.parent().removeClass("floater")})}function ya(a){var b=t(),c=$("#email_pref_list input"),d=$(".email-casl-wording").text().replace(/\s+/g," ").trim();$.ajax({url:Ea.sso_url+Ea.email_prefs_url,data:{action:"toggle_subscribe_all",email:b.email,toggle:a,casl_content:d},dataType:"jsonp",crossDomain:!0,cache:!1,timeout:2e3,error:function(a,b){}}),"on"==a?$(c).prop("checked",!0):"off"==a&&($(c).prop("checked",!1),$("#email_pref_list .epref-unsubscribe").remove())}function za(a,b){if($(".error-"+a,Ea.current_state).length){var c=$(".error-"+a,Ea.current_state).get(0);b&&$(c).html(b),$(c).css("display","block")}}function Aa(){x(Ea.login_messages),pa("Send"),Ea.form_invalid=MPPUserManage.validateloginMessages}function Ba(){function a(a){var b=$(this);setTimeout(function(){var a=b.val();""!==a?b.parent().addClass("floater"):b.parent().removeClass("floater")},0)}var b=$("[rel~=tooltip]",Ea.lightbox_div),c=!1,d=!1;b.bind("mouseenter",function(){c=$(this);var a=c.attr("title");if(d=$('<div class="V4-tooltip"></div>'),!a||""===a)return!1;c.removeAttr("title"),d.css("opacity",0).html(a).appendTo("body");var b=function(){$(window).width()>1e3?d.css("max-width",450):$(window).width()<1.5*d.outerWidth()?d.css("max-width",$(window).width()/2):d.css("max-width",340);var a=c.offset().left+c.outerWidth()/2-d.outerWidth()/2,b=c.offset().top-d.outerHeight()-20;a<0?(a=c.offset().left+c.outerWidth()/2-20,d.addClass("left")):d.removeClass("left"),a+d.outerWidth()>$(window).width()?(a=c.offset().left-d.outerWidth()+c.outerWidth()/2+20,d.addClass("right")):d.removeClass("right"),b<0?(b=c.offset().top+c.outerHeight(),d.addClass("top")):d.removeClass("top"),d.css({left:a,top:b}).animate({top:"+=10",opacity:1},50)};b(),$(window).resize(b);var e=function(){d.animate({top:"-=10",opacity:0},50,function(){$(this).remove()}),c.attr("title",a)};c.bind("mouseleave",e),d.bind("click",e)}),$(".V4-input-wrap input").keydown(a),$(".V4-input-wrap input").change(a),$(".V4-input-wrap textarea").change(a),$(".V4-input-wrap textarea").keydown(a),$(".V4-input-wrap select").change(a),setTimeout(function(){$(".V4-input-wrap input, .V4-input-wrap select, .V4-input-wrap textarea").each(function(){var a=$(this),b=a.val();""!==b?a.parent().addClass("floater"):a.parent().removeClass("floater")})},0);var e=$(".accordion div");e.hide(),$(".accordion h5").click(function(){if(!$(this).hasClass("active"))return e.slideUp(),$(".accordion h5 i.icon-caret-down").removeClass("icon-caret-down").addClass("icon-caret-right"),$(this).next().slideDown(),$(".accordion h5.active").removeClass("active"),$(this).addClass("active"),$(this).children(".icon-caret-right").removeClass("icon-caret-right").addClass("icon-caret-down"),!1});var f=$(".accordion-panel");$(window).height()<600&&(f.slideUp(),$(".profile-accordion h5 .icon-caret-down").removeClass("icon-caret-down").addClass("icon-caret-right"),$(".profile-accordion h5.active").removeClass("active")),$(".profile-accordion h5").click(function(){if(!$(this).hasClass("active"))return f.slideUp(),$(".profile-accordion h5 i.icon-caret-down").removeClass("icon-caret-down").addClass("icon-caret-right"),$(this).next().slideDown(),$(".profile-accordion h5.active").removeClass("active"),$(this).addClass("active"),$(this).children(".icon-caret-right").removeClass("icon-caret-right").addClass("icon-caret-down"),!1})}function Ca(a){var b=t();$("#email_pref_list").empty();var c="";$(a.sites).each(function(a,b){if(c!=b.category&&($("#email_pref_list").append("<h4>"+b.category+"</h4>"),c=b.category),null!==b.offsite_url&&$("#email_pref_list").append('<p><a href="'+b.offsite_url+'" class="fr"><i class="icon-signup"></i> Add New</a><strong>'+b.site_name+" Alerts</strong></p>"),"0"===b.offsite){var d=b.rows.length>0?' checked="CHECKED" ':"";$("#email_pref_list").append('<p><label><input type="checkbox" value="'+b.id+'"'+d+"><strong>"+b.site_name+'</strong><em class="sub-label">'+b.description+"</em></label></p>")}else $(b.rows).each(function(a,b){$("#email_pref_list").append('<p class="epref-unsubscribe"><a href="#" email_pref_id="'+b.id+'" class="a-unsubscribe fr"><i class="icon-close"></i> Unsubscribe</a><em>'+b.description+"</em></p>")})}),$("#email_pref_list .a-unsubscribe").click(function(){confirm("Are you sure you want to remove yourself from this mail list?")&&($.ajax({url:Ea.sso_url+Ea.email_prefs_url,data:{action:"update_email_pref",email:b.email,email_pref_id:$(this).attr("email_pref_id"),toggle:"remove"},dataType:"jsonp",crossDomain:!0,cache:!1,timeout:2e3,error:function(a,b){}}),$(this).parent().remove())}),$("#email_pref_list input").click(function(){var a=$(".email-casl-wording").text().replace(/\s+/g," ").trim();$.ajax({url:Ea.sso_url+Ea.email_prefs_url,data:{action:"update_email_pref",email:b.email,site_id:this.value,toggle:this.checked?"add":"remove",casl_content:a},dataType:"jsonp",crossDomain:!0,cache:!1,timeout:2e3,error:function(a,b){}})})}var Da={init:a,checkLoggedIn:M,showLogin:O,showHelp:_,showManageUser:da,showRegister:Y,showRegisterNew:X,show_noAccess:Aa,showEmailPrefs:ca,showVerifyEmail:ia,showForgotPassword:I,showLoginWithPromise:N,showConfirmForgotPassword:K,showChangePassword:la,handleRecaptchaLoad:w,handleEmailPrefs:Ca,handleSCLogin:W,renderWebsiteLoggedIn:S,renderWebsiteLoggedOut:R,remindMeNextWeek:k,debugCSS:b,getCookieInfo:t,logout:fa,close:y},Ea={lightbox_div:".V4-login-container",login_area:".V4-login",register_new:".V4-no-email",register_existing:".V4-activated-account",email_verification:".V4-activation-email",email_verification_waiting:".V4-activation-waiting",email_confirmed:".V4-activation-confirmation",error_message:".error-message",success_message:".success-message",login_wrapper:".V4-login-wrapper",help_message:".V4-login-help",help_link:".V4-help-link",email_subscribe_form:".V4-email-subscribe",activation_check:".V4-activation-checking",activation_confirmation:".V4-activation-confirmation",forgot_password:".V4-forgot-password",forgot_password_continue:".V4-forgot-password-continue",confirm_forgot_password:".V4-confirm-forgot-password",change_password:".V4-change-password",manage_user:".V4-manage-user",logout:".V4-logout",sso_link:"/sso/?c=n",current_state:null,form_invalid:null,home_page:"/",email_prefs_url:"/email.php",sso_url:"http://sso.winnipegfreepress.com",unsubscribe_all_link:"#unsubscribe_all",subscribe_all_link:"#subscribe_all",cookie_domain:".winnipegfreepress.com",cookie_time:3650,button_selector:"input[type=button]",casl_selector:".casl-wording",casl_error_show:0,recaptcha_error_show:0,terms_error_show:0,error_selector:".V4-error",forgot_password_link:".V4-forgot-password-link",change_password_link:".V4-change-password-link",login_link:".V4-login-link",register_link:".V4-register-link",manage_user_link:".V4-manage-user-link",close_link:".V4-close-link",redirect_home_link:".V4-redirect-home",remind_me_link:".V4-ask-later",skip_link:".redirect-url",submitting_replacement:"submitting-dialog",legacy_cookie_params:["pluck","userName","email","firstName","lastName","fullname","birthdate","day","month","year","address1","address2","streetAddress","city","state","country","location","zipcode","phone","mobile_phone","userID","regConfStatus","brandonSub","wfpSub","loginDate","pbsaccount","CASLconsent","wfpSub"],hard_redirect:null,force_login:!0,allow_remind_me:!1,wrapper_css:".mfp-wrap",bg_overlay:".mfp-bg",login_messages:".V4-login-messages",max_login_attempts:4,is_subscriber_selector:".is-subscriber",is_not_subscriber_selector:".is-not-subscriber",commenting_profile_url:"http://www.winnipegfreepress.com/community/persona.html?userId=_USERID_&plckUserId=_USERID_",commenting_profile_link:".commenting-profile-link",default_to_payment:!1},Fa={},Ga=null,Ha=!1;return Da}(),WFPUtils=function(a,b){function c(){var a=b.Deferred();return b(document).ready(function(){a.resolve()}),a.promise()}function d(a,c){var d=b(window).scrollTop(),e=d+b(window).height(),f=b(a).offset().top,g=f+b(a).height();return c===!0?d<f&&e>g:e>=f-500}function e(){var a=b.Deferred();return function(a){var c=document.createElement("div");c.innerHTML="&nbsp;",c.className="adsbox",document.body.appendChild(c),window.setTimeout(function(){0===c.offsetHeight?a.resolve("blocked"):a.resolve("not blocked"),b(c).remove()},100)}(a),a}function f(a){var b,c="{Mon} {d} {h}:{mm} {TT}";return a?(a=Date.create(a),a&&a.isValid()?(a.isToday()?c="{h}:{mm} {TT}":a.isThisYear()||(c="{Mon} {d}, {yyyy} {h}:{mm} {TT}"),b=a.format(c)):""):""}function g(a,b){var c,d,e,f,g={width:0,height:0,image_type:"noimage"};if(a&&a.match(/[0-9].*x[0-9].*/)){e=a.split("x"),c=e[0],d=e[1];var h=d/c;f=h<1?b&&"nocrop"==b||c==z.MAX_WIDTH?"landscape_no_crop":"landscape":h>z.image_full_ratio?"portrait_tall":"portrait",g.width=c,g.height=d,g.image_type=f}return g}function h(a){var b=[];switch(a.image_type){case"landscape":b.push("landscape");break;case"portrait":b.push("portrait");break;case"landscape_no_crop":b.push("landscape-nocrop")}return b}function i(a){var b=[];if(Array.isArray(a))b=a;else if(a)if(a.items||a.read_articles||a.saved_articles)b=a.items?a.items:a.read_articles?a.read_articles:a.saved_articles;else if(a.sections)for(var c in a.sections)for(var d in a.sections[c].articles)b.push(a.sections[c].articles[d]);else b=[a];return b}function j(a){console.log(a)}function k(a){var b=window.location.host;"wfppaiddigital.localhost"===b&&(b="www.winnipegfreepress.com");var c="",d=["autos.winnipegfreepress.com"];if(!a)return"";try{var e=a.split(/[\/?#]/);c=d.indexOf(e[2])<0?a.replace(e[2],b):a}catch(b){c=a,WFPUtils.error("Issue with urls "+a)}return z.appendUrlString&&(c=c.indexOf("?")>-1?c+"&"+z.appendUrlString:c+"?"+z.appendUrlString),c}function l(a,b){j(a),j(b)}function m(a,b){a&&j(a),b&&console.error(b.stack)}function n(){for(var a,b,c=!1;!c;){for(b=(new Date).getTime().toString(36);b.length<16;)b+=Math.round(2147483647*Math.random()).toString(36);var a=b.substr(0,16);document.getElementById(a)||(c=!0)}return a}function o(a,d,e,f,g){var h=b.Deferred();return b.when(c()).done(function(){var c,i=!1;e||(e=".big-box-ad-top"),f||(f=""),g||(g="");var j=b(e).length;c=1==b(e).length?"top":2==b(e).length?"mid":"bot",app_config.hasOwnProperty("article")&&(i="story/index"),a?b(window).width()<800?cX.callQueue.push(["invoke",function(){googletag.cmd.push(function(){var a=googletag.defineSlot(mobileadunit,[[320,50],[300,50]],d).setTargeting("loc",c).setTargeting("pos",j).setTargeting("tile",g).addService(googletag.pubads());i&&a.setTargeting("page",i),googletag.display(d),googletag.pubads().refresh([a]),h.resolve()})}]):cX.callQueue.push(["invoke",function(){googletag.cmd.push(function(){var a=googletag.defineSlot(gptadunit,[728,90],d).setTargeting("loc",c).setTargeting("pos",j).setTargeting("tile",g).addService(googletag.pubads());i&&a.setTargeting("page",i),googletag.display(d),googletag.pubads().refresh([a]),h.resolve()})}]):b(window).width()<800?cX.callQueue.push(["invoke",function(){googletag.cmd.push(function(){var a=googletag.defineSlot(mobileadunit,[[300,250],[320,50],[300,50]],d);a.setTargeting("loc",c).setTargeting("pos",j).setTargeting("tile",g).addService(googletag.pubads()),i&&a.setTargeting("page",i),googletag.display(d),googletag.pubads().refresh([a]),h.resolve()})}]):(cX.callQueue.push(["invoke",function(){googletag.cmd.push(function(){var a=googletag.defineSlot(gptadunit,[300,250],d).setTargeting("loc",c).setTargeting("pos",j).setTargeting("tile",g).addService(googletag.pubads());i&&a.setTargeting("page",i),googletag.display(d),googletag.pubads().refresh([a])})}]),h.resolve())}),h.promise()}function p(a,d,e,f,g,h,i){var j=b.Deferred();return b.when(c()).done(function(){
var c,k=!1;d||(d="no"),g||(g=".spillbox-big-box-ad"),h||(h=""),i||(i="");var l=parseInt(a)+1;c=1==l?"top":2==l?"mid":"bot",app_config.hasOwnProperty("article")&&(k="story/index"),e?b(window).width()<800?cX.callQueue.push(["invoke",function(){googletag.cmd.push(function(){spillboxAdSlots[a]=googletag.defineSlot(mobileadunit,[[320,50],[300,50]],f).setTargeting("loc",c).setTargeting("pos",l).setTargeting("tile",i).addService(googletag.pubads()),k&&spillboxAdSlots[a].setTargeting("page",k),googletag.display(f),"yes"==d&&googletag.pubads().refresh([spillboxAdSlots[a]]),j.resolve()})}]):cX.callQueue.push(["invoke",function(){googletag.cmd.push(function(){spillboxAdSlots[a]=googletag.defineSlot(gptadunit,[728,90],f).setTargeting("loc",c).setTargeting("pos",l).setTargeting("tile",i).addService(googletag.pubads()),k&&spillboxAdSlots[a].setTargeting("page",k),googletag.display(f),"yes"==d&&googletag.pubads().refresh([spillboxAdSlots[a]]),j.resolve()})}]):b(window).width()<800?cX.callQueue.push(["invoke",function(){googletag.cmd.push(function(){spillboxAdSlots[a]=googletag.defineSlot(mobileadunit,[[320,50],[300,250],[300,50]],f),spillboxAdSlots[a].setTargeting("loc",c).setTargeting("pos",l).setTargeting("tile",i).addService(googletag.pubads()),k&&spillboxAdSlots[a].setTargeting("page",k),googletag.display(f),"yes"==d&&googletag.pubads().refresh([spillboxAdSlots[a]]),j.resolve()})}]):cX.callQueue.push(["invoke",function(){googletag.cmd.push(function(){spillboxAdSlots[a]=googletag.defineSlot(gptadunit,[300,250],f).setTargeting("loc",c).setTargeting("pos",l).setTargeting("tile",i).addService(googletag.pubads()),k&&spillboxAdSlots[a].setTargeting("page",k),googletag.display(f),"yes"==d&&googletag.pubads().refresh([spillboxAdSlots[a]]),j.resolve()})}])}),j.promise()}function q(){if(!b("#wallpaper-link").hasClass("removeInit")){b("#wallpaper-link").addClass("removeInit");var a=b(window).scrollTop(),c=b("#wallpaper-link").attr("href");b("#wallpaper-link").attr("oldhref",c);var d,e=!1,f=!0;b(window).scroll(function(){e=!0}),d=setInterval(function(){e&&(e=!1,b(window).scrollTop()<a&&!f?(f=!0,b("#wallpaper-link").attr("href",c),b("#wallpaper-link").css("cursor","pointer"),b("#wallpaper-link").fadeOut(400,function(){b("#wallpaper-link").css("background-color",""),b("#wallpaper-link").css("display","block")})):b(window).scrollTop()>a&&f&&(f=!1,b("#wallpaper-link").removeAttr("href"),b("#wallpaper-link").css("cursor","default"),b("#wallpaper-link").css("display","none"),b("#wallpaper-link").css("background-color","white"),b("#wallpaper-link").fadeIn()))},250)}}function r(a,b){var c=document.createElement(a);for(var d in b)b.hasOwnProperty(d)&&c.setAttribute(d,b[d]);return c}function s(a,d,e){b.when(c()).done(function(){"function"==typeof ga&&(e||(e="Tile Event"),d?ga("send","event",e,a,d):ga("send","event",e,a))})}function t(a,b){ga("send",{hitType:"event",eventCategory:"Subscribe Category",eventAction:b,hitCallback:function(){window.location.href=a}})}function u(){b.when(c()).done(function(){b(".subscribe-buttons .iservices").each(function(){var a=b(this).attr("href"),c=b(this).attr("data-type");b(this).removeAttr("href"),function(a,c,d){b(d).click(function(){WFPUser.isLoggedIn()?t(c,a):b.when(WFPUser.openLoginPromise({force_login:!1})).done(function(){t(c,a)})})}(c,a,this)}),b(".subscribe-buttons .rnpl-payment-page").each(function(){var a=b(this).attr("data-type");WFPUser.applyPaymentLink(this,{force_login:!1,click_type:"Subscribe Category",click_value:a})})})}function v(a,b){var c="";switch(b){case"register":c="/user/create";break;case"login":c="/user/login";break;case"login_from_session":c="/user/login_from_session";break;case"logout":c="/user/logout";break;case"edit_account":c="/user/edit";break;case"user_info":c="/user/info";break;case"member_info":c="/user/member_info";break;case"forgot_password":c="/password/forgot_password";break;case"change_password":c="/password/change_password";break;case"confirm_forgot_password":c="/password/confirm_forgot_password";break;case"verify_email":c="/password/verify_email";break;case"login_messages":c="/messages/login_messages";break;case"feedback":c="/messages/feedback";break;case"update_payment":c="/payment/update";break;case"micropayment_session":c="/payment/micropayment_session";break;case"session_login":c="/payment/session_login";break;case"finalize_account":c="/payment/finalize_account";break;case"app_identify":c="/auth/identify"}return a+c}function w(a){window.news_config.stCount=a.total}function x(a){var b,c,d,e,f=[b,null,!1,0,"","0"];for(d=0,e=f.length;d<e;d++)if(a===f[d])return!0;if("object"==typeof a){for(c in a)if(a.hasOwnProperty(c))return!1;return!0}return!1}function y(a){var b=0;return a.forEach(function(a,c){a.position.hasOwnProperty("size")?b+=parseInt(a.position.size):b++}),b}a=a||{};var z={image_full_ratio:1.61,MAX_WIDTH:480,MAX_HEIGHT:432,apiKey:"36749a9c-cc10-4042-8c29-84e0c435a633",shareUrl:"http://wd.sharethis.com/api/getCount2.php",appendUrlString:""};b.extend(z,a);var A={getReady:c,formatDate:f,determinePhotoType:g,dataToArray:i,log:j,error:m,xhrError:l,overrideUrls:k,getImageStyle:h,buildElement:r,stCallBack:w,shareThisConfig:function(){return{apiKey:z.apiKey,url:z.shareUrl}},generateUniqueId:n,setupGoogleAd:o,setupSpillboxAd:p,removeWallpaperAds:q,applySubscribeEvents:u,gaEvent:s,convertAPIUrl:v,detectAdBlock:e,isElementInView:d,isEmpty:x,countTilesSize:y};return A}(news_config,$),WFPModal=function(){function a(a){var c=$.Deferred(),d={wide_body:a},e={deferred:c,options:d};return f.push(e),1==f.length&&b(e),c.progress()}function b(a){$("html").css("margin-right","15px"),$("html").css("overflow","hidden"),$("body").prepend(g),a.wide_body&&$(".mfp-content").addClass("wide-modal"),a.deferred.resolve($(".mfp-content"))}function c(){if(f.shift(),f.length>0){var a=f[0];b(a)}}function d(){$(document).unbind("keypress"),$(".mfp-ready").remove(),$("html").css("margin-right",""),$("html").css("overflow",""),c();var a=$.Deferred();return a.resolve(),a.progress()}var e={open:a,close:d},f=[],g='<div class="mfp-bg mfp-ready"></div><div class="mfp-wrap mfp-auto-cursor mfp-ready" tabindex="-1" style="overflow-x: hidden; overflow-y: auto;"><div class="mfp-container mfp-ajax-holder mfp-s-ready"><div class="mfp-content "></div></div></div>';return e}(),WFPWidgetConfig=function(){return{widgets:{v4_tile_article_image:{mixins:["v4_date","v4_hover_summary","v4_comments","v4_sharethis","v4_photo_caption"]},v4_tile_article_full_image:{mixins:["v4_date","v4_hover_summary","v4_comments","v4_sharethis","v4_photo_caption"]},v4_tile_article_no_image:{mixins:["v4_date","v4_comments","v4_sharethis","v4_read_later"]},v4_tile_article_list:{mixins:["v4_date","v4_hover_summary","v4_comments","v4_sharethis"]},v4_tile_ad_filler_news:{mixins:["v4_date","v4_hover_summary","v4_comments","v4_sharethis"]},v4_tile_ad_autos_news:{mixins:["v4_date","v4_hover_summary","v4_comments","v4_sharethis"]},v4_tile_ad_homes_news:{mixins:["v4_date","v4_hover_summary","v4_comments","v4_sharethis"]},v4_tile_video:{mixins:["v4_date","v4_comments","v4_sharethis"]},v4_tile_video_photo:{mixins:["v4_date","v4_comments","v4_sharethis"]},v4_tile_featured_photo:{mixins:["v4_photo_caption"]},v4_tile_spillbox:{mixins:["v4_date","v4_comments","v4_sharethis"]},v4_tile_doublewide:{mixins:["v4_date","v4_comments","v4_sharethis","v4_photo_caption","v4_read_later"]},v4_tile_doubletop:{mixins:["v4_date","v4_comments","v4_sharethis"]}},getInstances:function(a){var b,c=[];for(b=0;b<a.length;b++)c.push(WFPMixin.get(a[b]));return c}}}(),WFPWidget=function(a,b){function c(a,b,c){var d=WFPWidget.get(a);d.postinit(),d.runPreRenders&&d.runPreRenders(b);var e=$(d.render(b));d.runPostRenders&&d.runPostRenders(e);var f=c(e);d.attach($(f).get(0))}function d(a,b,c){var d;"undefined"==typeof b&&(b={}),"undefined"==typeof c&&(c=[],d=WFPWidgetConfig.widgets[a],d&&(c=WFPWidgetConfig.getInstances(d.mixins))),"undefined"==typeof b.init&&(b.init=function(){this._super(a)}),i[a]=j.extend(b),i[a].mixins=c}function e(a,b){var c;for(a.mixins=b,c=0;c<b.length;c++)WFPMixinFactory(b[c],a)}function f(a){"undefined"==typeof i[a]&&d(a);var b=new i[a];return e(b,i[a].mixins),b}var g={get:f,add:d,display:c},h={};WFPUtils.getReady().then(function(){$("[data-partial]").each(function(a,b){var c=$(b);h[c.attr("id")]=c.html()})});var i={},j=b.extend({widget_name:null,widget_template:null,widget_node:null,widget_data:null,init:function(a){this.widget_name=a,document.getElementById(a)?this.widget_template=document.getElementById(a).innerHTML:(WFPUtils.log("trying to find "+a),this.widget_template=""),this.post_renders=[],this.pre_renders=[]},postinit:function(){},debug:function(){console.log("i am a "+j.widget_name+" on "+j.widget_node)},render:function(b){return this.data=b,a.render(this.widget_template,this.data,h)},attach:function(a,b){this.widget_node=a,"undefined"!=typeof b&&b.call(this,this.widget_node)},addInit:function(a){this.init_functions.push(a)},runInits:function(){var a,b=this.init_functions;if(b.length>0)for(a=0;a<b.length;a++)b[a].call(this)},addPostRender:function(a){this.post_renders.push(a)},runPostRenders:function(a){var b,c=this.post_renders;if(c.length>0)for(b=0;b<c.length;b++)c[b].call(this,a)},addPreRender:function(a){this.pre_renders.push(a)},runPreRenders:function(a){var b,c=this.pre_renders;if(c.length>0)for(b=0;b<c.length;b++)c[b].call(this,a)}});return g}(Mustache,Class),user_config=user_config||{},WFPUser=function(a,b,c,d){function e(b,d,e){oa.disable_check_user_state=!!d,oa.page_requires_login=!!b,oa.free_with_valid_account=!!e,c.when(WFPUtils.getReady()).done(function(c){if(q())if(a.renderWebsiteLoggedIn(),oa.commenting_profile_url=oa.commenting_profile_url.replace(/_USERID_/g,K("userID")),oa.disable_check_user_state)a.renderWebsiteLoggedIn();else{var d=WFPUser.getUser("user_type");a.renderWebsiteLoggedIn(1==d.comment_access),X(b,e)}else a.renderWebsiteLoggedOut(),B();y()}),S(),h()}function f(){oa.commenting_profile_url=oa.commenting_profile_url.replace(/_USERID_/g,K("userID"))}function g(){return oa}function h(){if(la("curUserInfo")&&!L("curUserInfo")){var a={};for(var b in qa)a[qa[b]]=ta.fetch("curUserInfo",qa[b]);ja("curUserInfo",a),oa.keep_subcookie||c.removeCookie("curUserInfo",{path:"/",domain:oa.cookie_domain})}}function i(){c.jStorage.flush(),localStorage.clear();for(var a in pa)ka(pa[a]);c.removeCookie("curUserInfo",{path:"/",domain:oa.cookie_domain})}function j(){var a=c.Deferred();return!function(a){var b=new IdentityModule;b.detectPrivateMode(function(b){a.resolve(b)})}(a),k(),a.promise()}function k(){var a=new IdentityModule;return a.GenerateIdentity("v4_private_mode"),la("v4_private_mode")}function l(){var b=new IdentityModule;b.detectPrivateMode(function(a){if(a){var b={force_login:!0,allow_remind_me:!1};t(b)}}),k(),a.renderWebsiteLoggedOut()}function m(a,b){b.action=a,b.site=oa.site_name,L("session_id")&&(b.session_id=L("session_id"));var d=c.Deferred(),e=c.ajax({url:oa.sso_url,data:b,dataType:"jsonp"});return c.when(e).done(function(a){a&&a.session_id&&ja("session_id",a.session_id),d.resolve({response:a})}).fail(function(a){d.reject(a)}),d.promise()}function n(a){var b=parseFloat(oa.read_article_cache_timer/1440);ja("read_articles",a,b)}function o(a){var b=oa.read_article_cache_timer/1440;ja("saved_articles",a,b)}function p(){var a=!1;if(q()){var b=L("read_articles"),c=L("saved_articles");null===b&&null===c||(a={},a.read_articles=b||[],a.saved_articles=c||[])}return a}function q(){var a=L("v4_clientuserid"),b=L("v4_token");return!(!a||!b)&&a}function r(){var a=L("v4_clientuserid");return!!a&&d.MD5(a).toString()}function s(a){var b=c.Deferred();return oa.maintenance_mode?(D(),b.reject()):(a=c.extend({sso_link:oa.sso_link,sso_url:oa.sso_url},a),c.when(!0).done(function(a){app_config.is_article_page,c.when(a).done(function(){q()?(b.resolve(),app_config.is_article_page&&location.reload()):b.reject()})})),b.promise()}function t(a){s(a)}function u(){var a=c.Deferred();return function(a){var b={action:"user_info",jsonp:"true",c:"n"},d=WFPUtils.convertAPIUrl(oa.sso_link,b.action),e=c.ajax({url:d,data:b,dataType:"jsonp"});c.when(e).done(function(b){b&&"false"==b.error&&"valid-account"==b.loginState&&(ja("curUserInfo",b.click_user),a.resolve())}).fail(function(b){a.reject()})}(a),a.promise()}function v(b,d){var e;d?(e=c(d).closest("ul"),c(e).addClass(oa.loading_gif_class)):e=!1,function(d){c.when(u()).done(function(){E(a.showManageUser,b),d&&c(d).removeClass(oa.loading_gif_class)}).fail(function(){E(a.showManageUser,b),d&&c(d).removeClass(oa.loading_gif_class)})}(e)}function w(b){b=c.extend({sso_link:oa.sso_link},b),E(a.showRegister,b)}function x(b){b=c.extend({sso_link:oa.sso_link},b),E(a.showHelp,b,"profile")}function y(){var b=oa;c(oa.login_buttons).each(function(){c(this).hasClass("type-login")?(c(this).unbind("click"),c(this).removeAttr("href"),c(this).css("pointer","cursor"),function(a){c(a).on("click",function(){if(oa.maintenance_mode)D();else{var a={force_login:!1};s(a),ga("send","event","PDC Logins","Login display","Header Link")}})}(this)):c(this).hasClass("type-register")?(c(this).unbind("click"),c(this).removeAttr("href"),c(this).css("pointer","cursor"),c(this).on("click",function(){oa.maintenance_mode?D():(E(a.showRegisterNew,b),ga("send","event","PDC Register","Register Display","Header Link"))})):c(this).hasClass("type-logout")?(c(this).unbind("click"),c(this).removeAttr("href"),c(this).css("pointer","cursor"),c(this).on("click",function(){E(a.logout,b)})):c(this).hasClass("type-profile")?(c(this).unbind("click"),c(this).removeAttr("href"),c(this).css("pointer","cursor"),c(this).on("click",function(){v(b,this)})):c(this).hasClass("type-help")?(c(this).unbind("click"),c(this).removeAttr("href"),c(this).css("pointer","cursor"),c(this).on("click",function(){E(a.showHelp,b,"profile")})):c(this).hasClass("type-decline-beta")?(c(this).unbind("click"),c(this).removeAttr("href"),c(this).css("pointer","cursor"),c(this).on("click",function(){ga("send","event","v5 Homepage Beta","Reverted to Current from Cog Menu"),ma("homepage_beta","revert"),window.location.href="/"})):c(this).hasClass("type-accept-beta")?(c(this).unbind("click"),c(this).removeAttr("href"),c(this).css("pointer","cursor"),c(this).on("click",function(){ga("send","event","v5 Homepage Beta","Previewed from Cog Menu"),ma("homepage_beta","accepted"),window.location.href="/newhomepage?initial"})):c(this).hasClass("type-change-password")?(c(this).unbind("click"),c(this).removeAttr("href"),c(this).css("pointer","cursor"),c(this).on("click",function(){E(a.showChangePassword,b)})):c(this).hasClass("type-persona")&&c(this).attr("href",oa.commenting_profile_url)}),c("a.type-iservices").each(function(){C(this)}),z(),F(document,!0)}function z(){B(L("user_type"))}function A(a){var b=c.Deferred();return function(b){data={c:"n",action:"finalize_account",jsonp:"true",payment_type:a};var d=WFPUtils.convertAPIUrl(oa.sso_link,data.action),e=c.ajax({url:d,data:data,dataType:"jsonp"});c.when(e).done(function(a){a&&"false"==a.error&&"authorized-payment"==a.loginState?(WFPUser.setUser("v4_payment_added_notification",!0),b.resolve({paymentFinalized:!0})):b.reject({paymentFinalized:!1})}).fail(function(a){b.reject({paymentFinalized:!1})})}(b),b.promise()}function B(a){var b="not-logged";switch(a){case"Trial":b="trial";break;case"PayAsYouGo":case"SATURDAY":b="pay-as-you-go";break;case"6DAY":case"MON-FRI":case"3DAY":case"Whitelist":b="subscriber";break;case"NotLogged":b="not-logged";break;default:b="not-logged"}c(".changed-state-element").each(function(){c(this).removeClass("changed-state-element"),c(this).addClass("account-state-element")}),c(".account-state-element").each(function(){c(this).hasClass(b)&&(c(this).removeClass("account-state-element"),c(this).addClass("changed-state-element"))})}function C(a){c(a).removeAttr("href"),c(a).css("pointer","cursor"),c(a).unbind("click"),c(a).on("click",function(){ka("v4_user_state"),window.location.href=oa.iservices_link})}function D(){c.when(WFPModal.open()).then(function(a){WFPWidget.display("v4_modal_maintenance_mode",{},function(b){return c(a).append(b),a})})}function E(b,d,e){var f=c.Deferred();return c.when(WFPModal.open()).then(function(g){c(g).load(oa.login_template,function(){F(g,!1),oa.suppress_payment_links&&c(".payment-info",g).hide(),d||(d={}),d.cookie_domain||(d.cookie_domain=oa.cookie_domain),d.sso_url=oa.sso_url,a.init(d);var h=b(e);f.resolve(h)})}),f.promise()}function F(a,b){c("a.payment-page",a).each(function(){var a={click_type:"payment from settings",click_value:"yes"};J(this,a)}),c("a.profile-prefs-page",a).each(function(){settings={sso_link:oa.sso_link,sso_url:oa.sso_url,force_login:!1},c(this).removeAttr("href"),c(this).css("pointer","cursor"),c(this).unbind("click"),function(a,b){c(a).click(function(){q()?v(b,a):!function(a,b){c.when(WFPUser.openLoginPromise(b)).done(function(){v(b,a)})}(a,b)})}(this,settings)}),c("a.email-subscribe-link",a).each(function(){settings={sso_link:oa.sso_link,sso_url:oa.sso_url,force_login:!1},c(this).removeAttr("href"),c(this).css("pointer","cursor"),c(this).unbind("click"),function(a,b){c(a).click(function(){q()?H(b,this):!function(a,b){c.when(WFPUser.openLoginPromise(b)).done(function(){H(b,a)})}(this,b)})}(this,settings)}),q()&&G(oa.sso_url),c("a.link-account",a).each(function(){c(this).removeAttr("href"),c(this).css("pointer","cursor"),c(this).unbind("click"),function(a){c(a).click(function(){c.when(WFPModal.close()).then(function(a){q()?ea(!1):c.when(s()).done(function(a){ea(!1)})})})}(this)})}function G(a){c("a.email-subscribe-link").length&&setTimeout(function(){var b=K("email"),d={url:a+"/email.php",data:{action:"get_email_prefs",email:b},dataType:"jsonp",crossDomain:!0,cache:!1,timeout:2e3},e=c.ajax(d);c.when(e).done(function(a){c(a.sites).each(function(a,b){0==b.offsite&&b.rows.length>0&&c("a.email-subscribe-link").each(function(){c(this).attr("data-site-id")==b.id&&(c(this).text("You are currently subscribed to this email!"),c(this).addClass("subscription-added"),c(this).unbind("click"))})})})},500)}function H(a,b){var d=(K("email"),c(b).attr("data-site-id")),e=c(".email-casl-wording").first().text().replace(/\s+/g," ").trim(),f={url:a.sso_url+"/email.php",data:{action:"update_email_pref",email:K("email"),site_id:d,toggle:"add",json:"true",casl_content:e},dataType:"jsonp",crossDomain:!0,cache:!1,timeout:2e3},g=c.ajax(f);!function(a){c.when(g).done(function(b){c(a).html("Email subscription added!").addClass("subscription-added").unbind("click")}).fail(function(b){c(a).html("Something went wrong, please try again").addClass("subscription-error")})}(b)}function I(a,b){b.click_type&&ga("send","event",b.click_type,b.click_value),c.when(WFPModal.close()).then(function(a){return WFPModal.open()}).done(function(a){data={sso_link:oa.sso_link,email:K("email"),show_paypal_button:oa.show_paypal_button,environment:oa.environment},c.extend(data,b),WFPWidget.display("v4_modal_payment_page",data,function(b){return c(a).append(b),a})})}function J(a,b){c(a).removeAttr("href"),c(a).css("pointer","cursor"),c(a).unbind("click"),function(a,b){c(b).click(function(){q()?I(b,a):!function(a,b){c.when(WFPUser.openLoginPromise(b)).done(function(){I(a,b)})}(b,a)})}(b,a)}function K(a){var b,c=L("curUserInfo");return b=!(!c||!c.hasOwnProperty(a))&&c[a]}function L(a,b){if("undefined"==typeof a){var d,e={},f=c.jStorage.index();for(d in f)e[f[d]]=c.jStorage.get(f[d]);for(d in pa)e[pa[d]]=la(pa[d]);return e}return pa.indexOf(a)>-1?la(a):("undefined"==b&&(b=null),c.jStorage.get(a,b))}function M(a){var b=L("v4_user_state");if(WFPUtils.isEmpty(b))return!1;var c=JSON.parse(b.account_settings);return"undefined"==typeof a?c:c[a]}function N(a,b){var d=c.Deferred(),e=L("v4_user_state"),f=JSON.parse("{}");if(WFPUtils.isEmpty(e.account_settings)||(f=JSON.parse(e.account_settings)),WFPUtils.isEmpty(a))return!1;var g={};g[a]=b;var h={};return h.settings=JSON.stringify(g),c.when(WFPUser.accessUserDB("update_account_settings",h)).done(function(c){f[a]=b,e.account_settings=JSON.stringify(f),W(e),d.resolve(c)}).fail(function(a){d.reject(a)}),d.promise()}function O(){var a={};L("session_id")&&(a.session_id=L("session_id"));var d=c.Deferred(),e=WFPUtils.convertAPIUrl(b.sso_link,"member_info"),f=c.ajax({url:e,data:a});return c.when(f).done(function(a){a&&a.session_id&&ja("session_id",a.session_id),d.resolve(a)}).fail(function(a){d.reject(a)}),d.promise()}function P(a){var b={};if(a){for(var c in ra){var d=ra[c];a.hasOwnProperty(d)&&(b[d]=a[d])}b.account_balance=parseInt(b.account_balance,10)}else b.account_balance=0;return b}function Q(a){c.when(WFPModal.open()).done(function(b){a.alert_type="membership_welcome",WFPWidget.display("v4_modal_trial_alerts",a,function(a){c(b).append(a),c.when(WFPUser.setUserAccountSetting("showed_membership_welcome",!0)).done(function(a){return a})})})}function R(a){var b;b={alert_type:a||"trial_welcome",ajax_link:oa.sso_link},b.suppress_payment_links=oa.suppress_payment_links,b.user=L("curUserInfo"),c.when(WFPModal.open()).done(function(a){WFPWidget.display("v4_modal_trial_alerts",b,function(b){return c(a).append(b),a})})}function S(a){c.when(WFPUtils.getReady()).done(function(){var a=L("v4_user_state");a&&a.hasOwnProperty("account_balance")&&c(".account-balance").text("$"+(a.account_balance/100).toFixed(2))}),c.jStorage.listenKeyChange("v4_user_state",function(a,b){var d=L("v4_user_state");d&&d.hasOwnProperty("account_balance")&&c(".account-balance").text("$"+(d.account_balance/100).toFixed(2))})}function T(a){if(a){var b=L("v4_user_state");if(b){var c=0;b.account_balance&&(c=parseInt(b.account_balance,10)),c+=parseInt(a,10),c=c<0?0:c,b.account_balance=c,W(b)}}}function U(a){if(a){var b=29.8/1440;ja("guid",a,b)}}function V(a){var b=a?a:c.Deferred();return L("guid")?b.resolve(L("guid")):!function(a){var b={c:"n",action:"micropayment_session",jsonp:"true"},d=WFPUtils.convertAPIUrl(oa.sso_link,b.action),e=c.ajax({url:d,data:b,dataType:"jsonp"});c.when(e).done(function(b){if(b&&"false"==b.error&&"valid-account"==b.loginState)U(b.guid),a.resolve(b.guid);else if("false"==b.error){var d={force_login:!0,allow_remind_me:!1};c.when(WFPUser.openLoginPromise(d)).done(function(){V(a)}).fail(function(){a.reject()})}}).fail(function(b){a.reject(b)})}(b),b.promise()}function W(a){var b=1/24,d=c.jStorage.getTTL("v4_user_state"),e=WFPUser.getUser("v4_user_state");WFPUser.setUser("v4_user_state",a),e&&!d||!e?c.jStorage.setTTL("v4_user_state",24*b*60*60*1e3):c.jStorage.setTTL("v4_user_state",d)}function X(a,b){var d;if(d={alert_type:"trial_welcome",ajax_link:oa.sso_link},d.suppress_payment_links=oa.suppress_payment_links,d.user=L("curUserInfo"),oa.activate_trial){var e=L("v4_user_state"),f=c.jStorage.getTTL("v4_user_state");null==e||0==f?(ka("v4_user_state"),c.when(WFPUser.accessUserDB("get_current_account_info",{})).done(function(c){var e=P(c.response.account);d.account_state=e.account_state,"undefined"!=typeof e.article_count?d.article_count=e.article_count:d.article_count=!1,c.response.error?(i(),Y(a)):(WFPUser.setUser("user_type",e.account_state),W(e),c.response.trial_initialized?_(d):c.response.account_initialized?$(d):c.response.trial_ended_with_payment?da(e,d):c.response.trial_expiring&&null==WFPUser.getUser("v4_trial_expiry_shown")?aa(d,c):WFPUser.getUser("v4_payment_added_notification")?(WFPUser.deleteUser("v4_payment_added_notification"),Z(d)):c.response.trial_account_expired&&!e.payment_methods.length&&"Whitelist"!=e.account_state&&ca(e,d,c,WFPArticle.requirePaywall()&&a,b)),sa.resolve(e)})):("PayAsYouGo"!==e.account_state&&"Saturday"!==e.account_state||e.hasOwnProperty("payment_methods")&&0!==e.payment_methods.length||!WFPArticle.requirePaywall()||!a?("PayAsYouGo"==e.account_state||"Saturday"==e.account_state)&&e.hasOwnProperty("trial_expired_data")&&a&&!function(a){c.when(WFPModal.open()).done(function(b){ga("send","event","Trial End "+a.alert_type,"display"),a.redirect_on_close=!0,WFPWidget.display("v4_modal_trial_alerts",a,function(a){return c(b).append(a),b})})}(e.trial_expired_data):ba(d,b),sa.resolve(e))}}function Y(a){var b={force_login:!0,allow_remind_me:!1};a&&c.when(s(b)).done(function(){X(a,oa.free_with_valid_account)}).fail(function(){a&&(window.location.href="/")})}function Z(a){c.when(WFPModal.open()).done(function(b){a.alert_type="trial_initialized_with_payment",WFPWidget.display("v4_modal_trial_alerts",a,function(a){return c(b).append(a),b})})}function $(a){c.when(WFPModal.open()).done(function(b){(WFPArticle.requirePaywall()||a&&a.require_paywall)&&(a.redirect_on_close=!0),a.alert_type="account_initialized_no_payment",WFPWidget.display("v4_modal_trial_alerts",a,function(a){return c(b).append(a),b})})}function _(a){c.when(WFPModal.open()).done(function(b){a.alert_type="trial_welcome",WFPWidget.display("v4_modal_trial_alerts",a,function(a){return c(b).append(a),b})})}function aa(a,b){!function(a,b){setTimeout(function(){c.when(WFPModal.open()).done(function(d){b.alert_type="trial_warning_"+a.response.recommended_account_type,WFPWidget.display("v4_modal_trial_alerts",b,function(a){return c(d).append(a),d}),WFPUser.setUser("v4_trial_expiry_shown",!0,3)})},oa.trial_open_delay)}(b,a)}function ba(a,b){a.alert_type="account_no_payment",a.free_with_valid_account=!!b,a.redirect_on_close=!0,c.when(WFPModal.open()).done(function(b){ga("send","event","Account End "+a.alert_type,"display"),WFPWidget.display("v4_modal_trial_alerts",a,function(a){return c(b).append(a),b})})}function ca(a,b,d,e,f){b.alert_type="trial_end_"+d.response.recommended_account_type,b.article_count=d.response.article_count,b.free_with_valid_account=!!f,e&&(b.redirect_on_close=!0),a.trial_expired_data=b,W(a),c.when(WFPModal.open()).done(function(a){ga("send","event","Trial End "+b.alert_type,"display"),WFPWidget.display("v4_modal_trial_alerts",b,function(b){return c(a).append(b),a})})}function da(a,b){!function(a,b){setTimeout(function(){b.alert_type="trial_end_with_payment",a&&W(a),c.when(WFPModal.open()).done(function(a){ga("send","event","Trial End with Payment","display"),WFPWidget.display("v4_modal_trial_alerts",b,function(b){return c(a).append(b),a})})},oa.trial_open_delay)}(a,b)}function ea(a){c.when(WFPModal.open()).done(function(b){var d={alert_type:"link_account_form"};d.redirect_on_close=a,d.account_state="UNKNOWN",d.user=WFPUser.getUser("curUserInfo"),d.ajax_link=oa.sso_link,WFPWidget.display("v4_modal_trial_alerts",d,function(a){return c(b).append(a),b})})}function fa(){var a;if(window.location.href.indexOf("newhomepage")!=-1?(a="accepted",ma("homepage_beta","accepted")):a=la("homepage_beta"),"accepted"==a){c("#inner-wrap > header").addClass("newhomepage"),c("#inner-wrap > header a.header-logo img").attr("src","http://media.winnipegfreepress.com/binary/freepress_white.svg");var b="<li><hr /></li><li><a class='type-decline-beta' href='javascript://'>Restore Current Design</a>";0===c(".type-decline-beta").size()&&(c("ul.slide-menu-inner a.translate-anchor").size()>0?c("ul.slide-menu-inner a.translate-anchor").after(b):c("ul.slide-menu-inner a.text-size-anchor").size()>0?c("ul.slide-menu-inner a.text-size-anchor").after(b):c("ul.slide-menu-inner").append(b))}else{var d="<li><hr /></li><li><a class='type-accept-beta' href='javascript://'>Try New Design</a>";0===c(".type-accept-beta").size()&&(c("ul.slide-menu-inner a.translate-anchor").size()>0?c("ul.slide-menu-inner a.translate-anchor").after(d):c("ul.slide-menu-inner a.text-size-anchor").size()>0?c("ul.slide-menu-inner a.text-size-anchor").after(d):c("ul.slide-menu-inner").append(d))}}function ha(){var a=la("tls_version");if(0==a)console.log("checking tls version with howsmyssl.com"),c.ajax({url:"https://www.howsmyssl.com/a/check"}).done(function(a){ma("tls_version",a.tls_version),ha()});else if("TLS 1.0"==a||"TLS 1.1"==a||window.location.search.indexOf("warnTls")!=-1){var b='<div class="tls-warning-container">';b+='<span class="icon-close login-close-btn V4-close-link V4-redirect-home"></span>',b+="<h3>Your browser does not support the latest security standards</h3>",b+="<p>The Winnipeg Free Press recommends using a browser that supports TLS 1.2. Please upgrade your browser to ensure that your information is kept secure.</p>",b+='<p><a href="https://www.encryptyourself.com/" target="_blank">View more information on upgrading your browser</a></p>',b+="</div>",c(".tile-container").prepend(b),jQuery(".nav-btn-mobile").is(":visible")&&jQuery(".tls-warning-container").addClass("use-mobile"),c(".tls-warning-container .icon-close").click(function(){c(".tls-warning-container").slideUp()})}}function ia(){var a="update_message_shown_new_homepage",b=la(a);if("true"!=b){ma(a,"true");var d='<div class="update-message-container">';d+='<span class="icon-close login-close-btn V4-close-link V4-redirect-home"></span>';var e=la("homepage_beta");"accepted"==e?(d+="<h1>The New Design is Now Live for Everyone</h1>",d+="<p>Thanks to your help and feedback, we are now rolling out our new design to all Winnipeg Free Press users.</p>",d+="<p>We'd still appreciate hearing about any comments or issues you have. Thank you again for your support of the Winnipeg Free Press.</p>"):(d+="<h1>Here is the New Winnipeg Free Press Homepage</h1>",d+="<p>Our new homepage is designed to serve you better.</p>",d+="<p>You'll now find this page separated into sections for Top News, Sports, Arts &amp; Life, Opinion, Local and Business. Not interested in a particular section? Minimize it to get it out of the way.</p>"),d+="</div>",c(".tile-container").prepend(d),jQuery(".nav-btn-mobile").is(":visible")&&jQuery(".update-message-container").addClass("use-mobile"),c(".update-message-container .icon-close").click(function(){c(".update-message-container").slideUp()})}}function ja(a,b,d,e,f){if(pa.indexOf(a)>-1)ma(a,b,d,e,f);else{var g=0;"undefined"!=typeof d&&(g=parseInt(1e3*d*60*60*24,10)),c.jStorage.set(a,b,{TTL:g})}}function ka(a){pa.indexOf(a)>-1?c.removeCookie(a,{path:"/",domain:oa.cookie_domain}):c.jStorage.deleteKey(a)}function la(a){var b=c.cookie(a);return"undefined"==typeof b&&(b=!1),b}function ma(a,b,d,e,f){"undefined"==typeof d&&(d=1e3),e=e||"/";var g={expires:d,path:e};return f?g.domain=f:g.domain=oa.cookie_domain,c.cookie(a,b,g),b}var na={getId:function(){return L("v4_clientuserid")},getIdHash:function(){return r()},getUser:L,getUserAccountSettings:M,setUserAccountSetting:N,requestMemberInfo:O,getArticles:p,saveReadArticles:n,saveSavedArticles:o,setUser:ja,getCookie:la,setCookie:ma,isLoggedIn:q,accessUserDB:m,openLogin:t,openRegister:w,openHelp:x,logUserOut:i,init:e,checkUserState:X,handlePrivateBrowser:l,testPopups:R,updateBalance:T,getMicropaymentSession:V,setMicropaymentSession:U,isPrivateBrowser:j,openLoginPromise:s,createMPPIdentity:k,finalizePayment:A,setupAccountStateElements:z,deleteUser:ka,applyPaymentLink:J,openManageWithFetchInfo:v,fetchInfo:u,openAccountLinkTrial:ea,showAccountNoPaymentPaywalled:ba,showTrialEndWithPayment:da,showAccountInitialized:$,showMembershipWelcome:Q,handleAccountStateElements:B,setupLinks:y,getUserInfo:K,keepBalanceFresh:S,setCommentingProfile:f,getConfig:g,setupHomepageBeta:fa,checkTlsVersion:ha,checkUpdateMessageContainer:ia},oa={login_template:"/templates/FP-login-ajax?c=n",login_buttons:".header-links a",loading_gif_class:"loading",profile_class:"type-profile",keep_subcookie:!1,sso_link:"/sso/?c=n",sso_url:"https://apidev.winnipegfreepress.com",site_name:"WFP News",read_article_cache_timer:5,cookie_domain:".winnipegfreepress.com",commenting_profile_url:"http://www.winnipegfreepress.com/community/persona.html?userId=_USERID_&plckUserId=_USERID_",trial_open_delay:6e3,activate_trial:!0,iservices_link:"https://selfservice.winnipegfreepress.com/cgi-bin/cmo_cmo.sh/custservice/web/login.html?siteid=WFP&prog=payment",page_requires_login:!1,suppress_payment_links:!1,show_paypal_button:!1,environment:"dev.",free_with_valid_account:!1,maintenance_mode:!1,disable_check_user_state:!1};c.extend(oa,b);var pa=["v4_clientuserid","v4_token","at","UID","temp_url","paymentRedirect","session_id"],qa=["pluck","userName","email","firstName","lastName","fullname","birthdate","day","month","year","address1","address2","streetAddress","city","state","country","location","zipcode","phone","mobile_phone","userID","regConfStatus","brandonSub","loginDate","pbsaccount","CASLconsent","wfpSub"],ra=["account_balance","account_settings","account_state","account_state_id","article_access","comment_access","trial_expiry","payment_methods"],sa=c.Deferred(),ta={
nameValueSeparator:"$$:$$",subcookieSeparator:"$$/$$",fetch:function(a,b){var d=c.cookie(a);if(!d)return null;for(var e=d.split(ta.subcookieSeparator),f={},g=0,h=e.length;g<h;g++){var i=e[g].split(ta.nameValueSeparator);f[i[0]]=i[1]}return"undefined"!==b?b in f?f[b]:null:f}};return na}(MPPUserManage,user_config,$,CryptoJS),cookiejar={bake:function(a,b,c,d,e){WFPUser.setUser(a,b,c,d,e)},fetch:function(a){return WFPUser.getUser(a)},crumble:function(a){WFPUser.deleteUser(a)}},subcookiejar={bake:function(a,b,c,d,e){WFPUser.setUser(a,b,c,d,e)},fetch:function(a,b){var c=WFPUser.getUser(a);return!(!c||!c.hasOwnProperty(b))&&c[b]},crumble:function(a,b){var c=WFPUser.getUser(a);c&&c.hasOwnProperty(b)&&delete c.key,WFPUser.setUser(a,c)}},WFPAuth=function(){function a(a,e){var f=e?e:$.Deferred(),g=WFPUser.getConfig(),h=!1;return $.when(i(a,g)).done(function(e){!function(e,f){$.when(WFPUtils.getReady()).done(function(){WFPUser.checkTlsVersion(),WFPUser.checkUpdateMessageContainer(),a.disable_check_user_state||"user_timeout_failed"===e.action||(h=d(e));var g=!1,i=!1;switch(e.action){case"show_login":i=!0,function(a){$.when(WFPUser.openLoginPromise()).done(function(){a.reject()}).fail(function(){c(),a.resolve({url_type:e.url_type,charge_for_article:!1})})}(f);break;case"show_payment_required":e.messages&&e.messages.action&&"account_initialized"==e.messages.action?(WFPUser.showAccountInitialized({require_paywall:!0}),delete e.messages):WFPUser.showAccountNoPaymentPaywalled({},!0);break;case"charge_page":g=!0;break;case"show_page":case"user_timeout_failed":case"disable_check_user_state":}e.messages&&b(e.messages),c(),i||f.resolve({url_type:e.url_type,charge_for_article:g,previous_purchase:h,action:e.action})})}(e,f)}),f.promise()}function b(a){switch(a.action){case"trial_expired":WFPUser.showTrialEndWithPayment(!1,{});break;case"account_initialized":WFPUser.showAccountInitialized({});break;case"show_membership_welcome":"/insider/"===window.location.pathname&&WFPUser.showMembershipWelcome({})}}function c(){e()?(WFPUser.setCommentingProfile(),f()?MPPUserManage.renderWebsiteLoggedIn(!0):MPPUserManage.renderWebsiteLoggedIn(),WFPUser.keepBalanceFresh()):MPPUserManage.renderWebsiteLoggedOut(),WFPUser.handleAccountStateElements(WFPUser.getUser("user_type")),WFPUser.setupLinks(),WFPMyNews.init()}function d(a){var b=!1;if(a.user_info){WFPUser.setUser("curUserInfo",a.user_info.click_user),WFPUser.setUser("UID",a.user_info.click_user.UID),WFPUser.setUser("at",a.user_info.click_user.pluck),WFPUser.setUser("user_type",a.account_state),WFPUser.setUser("v4_clientuserid",a.user_info.mpp_user.clientuserid),WFPUser.setUser("v4_token",a.user_info.mpp_user.v4_token);var c={account_balance:a.account_balance,account_settings:a.account_settings,account_state:a.account_state,article_access:1,comment_access:a.comment_access,trial_expiry:a.trial_expiry};a.payment_method&&(c.payment_methods=[{payment_method:a.payment_method}]),a.previous_purchase&&(b=a.previous_purchase),WFPUser.setUser("v4_user_state",c)}else{var d=WFPUser.getUser();for(var e in d)WFPUser.deleteUser(e);WFPUser.setUser("user_type","NotLogged")}return a.session_id&&WFPUser.setUser("session_id",a.session_id),b}function e(){return WFPUser.getUser("session_id")&&"NotLogged"!=WFPUser.getUser("user_type")}function f(){var a=WFPUser.getUser("v4_user_state");return!!a&&WFPUser.getUser("session_id")&&1==a.comment_access}function g(){var a=$.Deferred();return function(a){$.when(WFPUtils.getReady()).then(function(){return WFPUtils.detectAdBlock()}).done(function(b){WFPUser.setUser("adblock_enabled","blocked"==b),WFPUser.setUser("cxense_disabled",!WFPApp.checkCxenseAvailable()),a.resolve()})}(a),a.promise()}function h(){var a=$.Deferred(),b=WFPUser.getUser("adblock_enabled"),c=WFPUser.getUser("cxense_disabled");return null===b||null===c?!function(a){$.when(g()).done(function(){var b=WFPUser.getUser("adblock_enabled"),c=WFPUser.getUser("cxense_disabled");a.resolve({adblock_enabled:b,cxense_disabled:c})})}(a):(a.resolve({adblock_enabled:b,cxense_disabled:c}),g()),a.promise()}function i(a,b){var c=$.Deferred(),d="landing",e=0;return a.is_article_page&&a.article&&(d=0===parseInt(a.article.cost,10)||a.override_free_articles||a.maintenance_mode?"free":"paid",e=a.article.id),a.disable_check_user_state||a.maintenance_mode?(c.resolve({action:"disable_check_user_state",url_type:d}),c.promise()):(function(c){$.when(h()).done(function(f){var g=new IdentityModule,h={url:window.location.href,site:a.site_name,url_type:d,identity:g.CreateFingerprint(),jsonp:"true",article_id:e,adblock_enabled:f.adblock_enabled,cxense_disabled:f.cxense_disabled},i=WFPUtils.convertAPIUrl(b.sso_link,"app_identify"),j=$.ajax({url:i,data:h,dataType:"jsonp",timeout:a.identity_test_delay});$.when(j).done(function(a){a.url_type=d,c.resolve(a)}).fail(function(a){var b=!1;WFPUser.getUser("user_info")&&(b=WFPUser.getUser("user_info")),c.resolve({action:"user_timeout_failed",user_info:b,url_type:d})})})}(c),c.promise())}var j={init:a,isAuthenticated:e};return j}(),mynews_config=mynews_config||{},WFPMyNews=function(a,b,c,d,e,f){function g(){b.when(f.getReady()).done(function(){e.display("v4_top_my_news",{},o)})}function h(){b.when(f.getReady()).done(function(){e.display("v4_top_my_news",{},o),e.display("v4_page_my_news",{},p)})}function i(){b.when(f.getReady()).done(function(){if(c.isLoggedIn()){var a=!1,d=c.getUser("v4_user_state").account_state;b.inArray(d,user_config.membership_group)!==-1&&(a=!0),e.display("v4_tile_insider_message",{is_member:a},m),e.display("v4_tile_member_activities",{is_member:a},l),e.display("v4_tile_perks_discounts",b.extend(wfp_config.widget_data.v4_perks_discounts,{is_member:a}),k),e.display("v4_tile_ebooks",{is_member:a},n),e.display("v4_tile_exclusive_events",b.extend(wfp_config.widget_data.v4_exclusive_events,{is_member:a}),j),e.display("v4_page_my_news",{is_member:a},p)}else c.openLogin()})}function j(a){return b.when(f.getReady()).done(function(){var c="."+D.events_container_class;b(c).append(a)}),a}function k(a){return b.when(f.getReady()).done(function(){var c="."+D.perks_container_class;b(c).append(a)}),a}function l(a){return b.when(f.getReady()).done(function(){var c="."+D.member_container_class;b(c).append(a)}),a}function m(a){return b.when(f.getReady()).done(function(){var c="."+D.insider_message_class;b(c).append(a)}),a}function n(a){return b.when(f.getReady()).done(function(){var c="."+D.ebooks_container_class;b(c).append(a)}),a}function o(a){return b.when(f.getReady()).done(function(){var c="#"+D.my_news_id+" ."+D.widget_container_class;b(c).append(a)}),a}function p(a){var c="."+D.my_news_page_class;return b.when(f.getReady()).done(function(){b(c).append(a)}),a}function q(a){!function(){b.jStorage.listenKeyChange("read_articles",function(b,d){var e=c.getArticles();e&&e.read_articles&&e.read_articles.length&&a(e)})}(a),function(){b.jStorage.listenKeyChange("saved_articles",function(b,d){var e=c.getArticles();e&&e.saved_articles&&e.saved_articles.length&&a(e)})}(a)}function r(a){var d,e=b.Deferred();if(c.isLoggedIn())if(d=c.getArticles(),d&&!a)e.resolve(d);else{var f=0;c.getUser("session_id")||(f=500),setTimeout(function(){b.when(c.accessUserDB("get_read_and_unread_articles",{})).done(function(a){if(!a.response.error){d={read_articles:[],saved_articles:[]};var b;if(a.response.read_articles)for(b=0;b<a.response.read_articles.length;b++)d.read_articles.push(B(a.response.read_articles[b]));if(a.response.saved_articles)for(b=0;b<a.response.saved_articles.length;b++)d.saved_articles.push(B(a.response.saved_articles[b]));y(d.read_articles),x(d.saved_articles)}e.resolve(c.getArticles())})},f)}else e.resolve(!1);return e.promise()}function s(a){a&&(a.is_saved=1,u(a,!1))}function t(a){var d=b.Deferred();return E===!1||E?d.resolve(E):(!function(a){b.Topic("readArticleFetched").subscribe(function(b){a.resolve(b)})}(d),F||(F=!0,function(a){var d=c.getUser("v4_user_state");a=A(a,d),b.when(c.accessUserDB("is_article_read",a)).done(function(a){a&&a.response&&a.response.hasOwnProperty("error")&&!a.response.error?a.response.hasOwnProperty("article")?(E=a.response.article,b.Topic("readArticleFetched").publish(E)):(E=!1,b.Topic("readArticleFetched").publish(!1)):E=!1})}(a))),d.promise()}function u(a,d){var e=b.Deferred();return function(a,d,e){var f=c.getUser("v4_user_state");a=A(a,f),a.update_balance=e,b.when(c.accessUserDB("save_article",a)).done(function(b){a=B(a),a.is_saved?v(a):w(a),d.resolve({response:b,article:a})}).fail(function(b){a.is_saved?v(a):w(a),d.fail(b),WFPUtil.xhrError("saveArticle fail",b)})}(a,e,d),e.promise()}function v(a){var d=b.Deferred();return a?b.when(r()).done(function(b){b?x([a],b.saved_articles):x([a]),d.resolve(c.getArticles())}):WFPUtil.log("missing articles"),d.promise()}function w(a){var d=b.Deferred();return a?b.when(r()).done(function(b){b?y([a],b.read_articles):y([a]),d.resolve(c.getArticles())}):WFPUtil.log("missing articles"),d.promise()}function x(a,b){var d,e,f,g,h;if(b=b?b:[],a){for(f=a.length-1;f>=0;f--){d=a[f],e=!1;for(g in b)if(h=b[g],h.id==d.id){b[g]=d,e=!0;break}e||b.unshift(d)}for(f=0;f<b.length;f++)b[f].updated_since_read=!1}c.saveSavedArticles(b)}function y(a,b){var d,e,f,g,h;if(b=b?b:[],a){for(f=a.length-1;f>=0;f--){d=a[f],e=!1;for(g in b)if(h=b[g],h.id==d.id){b[g]=d,e=!0;break}e||b.unshift(d),z(d)}for(f=0;f<b.length;f++)d=b[f],Date.create(d.article_last_updated)>Date.create(d.date_added)?b[f].updated_since_read=!0:b[f].updated_since_read=!1}c.saveReadArticles(b)}function z(a){if(c.getArticles()){for(var b=c.getArticles().saved_articles,d=0;d<b.length;d++){var e=b[d];e.id==a.id&&b.splice(d,1)}c.saveSavedArticles(b)}}function A(a,b){var c="Free";if(!f.isEmpty(b))switch(b.account_state){case"PayAsYouGo":case"Saturday":case"Daily":c="Paid";break;case"6DAY":case"MON-FRI":case"3DAY":case"Whitelist":c="All Access";break;case"Trial":c="Free"}a.hasOwnProperty("cost")||(a.cost=0),0===a.cost&&(c="Free"),a.hasOwnProperty("is_saved")||(a.is_saved=0),1==a.is_saved&&(c="Free");var d={article_id:a.id,title:a.title,article_title:a.title,url:a.url,article_url:a.url,type:c,article_created:a.publish_time,article_last_updated:a.last_updated,cost:a.cost,is_saved:a.is_saved};return d}function B(a){var c=WFPNewsHandler.emptyNewsItem(),d=new c;return b.extend(d,a),d.title=a.article_title,d.id=a.article_id,d.updated_time=a.article_last_updated,d.url=a.article_url,d.click_url=a.article_url,d}var C={init:g,myNewsPage:h,insiderPage:i,getUserArticles:r,updateArticles:q,readArticleLater:s,saveArticle:u,isArticleRead:t},D={my_news_id:"myNews",widget_container_class:"widget-container",insider_message_class:"v4_tile_insider_message",member_container_class:"member-activities",perks_container_class:"perks-discounts",events_container_class:"member-events",ebooks_container_class:"member-ebooks",my_news_page_class:"mynews-container"},E=null,F=!1;return b.extend(D,a),C}(mynews_config,$,WFPUser,WFPArticle,WFPWidget,WFPUtils),news_config=news_config||{path:"/",cxense_news_sources:[{type:"widget",id:"07e77f459f8f2ecf8d76e132053df92628159df6"},{type:"search",url:"https://api.cxense.com/document/search"}],cxense_persisted_search_id:"18af7a295a1a1df72a15c51b1878a7130e0d4b5e",cxense_search_url:"https://api.cxense.com/document/search"},WFPNewsHandler=function(a){function b(a){$.extend(M,a)}function c(a){D=[],a&&(E[a]=[])}function d(a,b,d){var e,f,g,h=window.wfp_config.section_name;if(C[h]={},c(h),d&&d.length)for(e in d)f=d[e],!WFPUtils.isEmpty(C[h])&&C[h].hasOwnProperty(f)?C[h][f]++:C[h][f]=1;var i=[];if(b&&b.length){for(e in b)g=b[e],g.ignore_triples=!0,i.push(l(g));var j=s(i,h);D=WFPUtils.isEmpty(E[h])?[]:E[h],Array.prototype.push.apply(D,j.news_items),window.wfp_config.widget_data.breaking_news=j.news_items,E[h]=D}if(a&&a.length)for(e in a)f=a[e],!WFPUtils.isEmpty(C[h])&&C[h].hasOwnProperty(f)?C[h][f]++:C[h][f]=1}function e(a,b,c){var d,e,f;if(c&&c.length)for(d in c)e=c[d],B.hasOwnProperty(e)?B[e]++:B[e]=1;var g=[];if(b&&b.length){for(d in b)f=b[d],f.ignore_triples=!0,g.push(l(f));var h=s(g);Array.prototype.push.apply(D,h.news_items)}if(a&&a.length)for(d in a)e=a[d],B.hasOwnProperty(e)?B[e]++:B[e]=1}function f(){var a=function(){return{title:"",image:"",image_info:{},description:"",click_url:"",url:"",teaser:"",path:"",section:"",id:"",publish_time:"",updated_time:"",no_comments:!1,news_source:"",image_caption:"",alt_tag:"",media_type:"",cost:!1,ignore_triples:!1,image_credit:""}};return a}function g(a,b,c,d){var e,f={},g=d.start.format("{yyyy}-{MM}-{d}")+"T00:00:00"+d.timezone;return e=0===d.end?"-1m":d.end.format("{yyyy}-{MM}-{d}")+"T00:00:00"+d.timezone,f.persisted=a,f.json=JSON.stringify({start:b||0,count:c||20,filter:'filter(recs-publishtime:range(time("'+g+'"), time("'+e+'")])'}),f}function h(a,b,c){var d={};d.persisted=M.cxense_search_id;var e,f,g;if(M.name_search.length)f='query(author:"'+M.name_search+'")';else{"/"!=a?(a=a.replace(/^\//,"").replace(/\/$/,""),f='query(wfp-categories:"'+a+'")'):f='query(recs-custom1:"*")';for(g in M.suppress_sections)f+=' AND NOT query(wfp-categories:"'+M.suppress_sections[g]+'")'}return f+=' AND NOT query(url:"dev.www.winnipegfreepress.com")',e=M.minimum_content_date?'filter(recs-publishtime > time("'+M.minimum_content_date+'"))':'filter(recs-publishtime > time("1950-01-01T00:00:00.000Z"))',d.json=JSON.stringify({start:b||0,count:c||20,query:f,filter:e}),d}function i(a,b){if(M.cxense_persisted_search=!1,"cxense"==a||"click"==a)M.news_source=a;else if("cxense_columnist_search"==a){M.news_source="cxense",M.name_search=b;for(var c in M.cxense_news_sources){var d=M.cxense_news_sources[c];"search"==d.type&&(G=c)}}else"cxense_persisted"==a&&(M.news_source="cxense",M.cxense_persisted_search=!0,WFPUtils.isEmpty(M.persisted_id)&&(M.persisted_id=M.cxense_persisted_search_id));return M.news_source}function j(a){var b=new K;a.hasOwnProperty("recs-wfp-titleshort")?a.short_title=a["recs-wfp-titleshort"]:a.title.indexOf(" - Winnipeg Free Press")!=-1&&(a.title=a.title.replace(" - Winnipeg Free Press","")),a.hasOwnProperty("recs-image")&&"noimage"==a["recs-image"]?b.image=!1:b.image="http://media.winnipegfreepress.com/designimages/fb-og-image.png"!=a.dominantimage&&a.dominantimage,b.dimensions=a.dominantimagedimensions;var c=a.hasOwnProperty("recs-image")?a["recs-image"]:"normal";if(b.image_info=WFPUtils.determinePhotoType(b.dimensions,c),b.description=a.description,b.click_url=a.click_url||a.url,b.url=a.url,b.path=a["recs-custom1"],b.section=a["recs-custom2"],b.publish_time=a["recs-publishtime"],b.original_publish_time=b.publish_time,a.hasOwnProperty("recs-wfp-updatedtime")?(b.updated_time=a["recs-wfp-updatedtime"],b.publish_time=b.updated_time):b.updated_time=a["recs-publishtime"],b.id=a["recs-articleid"],a.hasOwnProperty("recs-custom3")){var d=a["recs-custom3"].split("|");b.media_type=d[0],a.media_type=b.media_type,b.no_comments="no_comments"==d[1],a.cost=d[2]}return a.hasOwnProperty("recs-custom0")?a.news_source=a["recs-custom0"]:a.news_source="wfp-circle",a.hasOwnProperty("recs-wfp-imagecaption")&&(a.image_caption=a["recs-wfp-imagecaption"]),a.hasOwnProperty("og-article-author")&&(a.author=a["og-article-author"]),a.ignore_triples&&(b.ignore_triples=!0),b=$.extend(b,n(a))}function k(a){return a?a.toLowerCase().replace(/[^a-zA-Z0-9]/,"-"):"story"}function l(a){var b=new K;b.image=!!(a.hasOwnProperty("image")&&a.image.length>0)&&a.image,b.dimensions=a.hasOwnProperty("image_dimensions")?a.image_dimensions:"";var c=a.hasOwnProperty("image_type")?a.image_type:"noimage";return b.image_info=WFPUtils.determinePhotoType(b.dimensions,c),b.click_url=a.url,b.url=a.url,b.path=a.path,b.section=a.section&&"false"!=a.section.toLowerCase()?a.section:"",b.publish_time=a.last_updated,b.original_publish_time=a.publish_time,b.updated_time=a.last_updated,b.id=a.id,b.no_comments="no_comments"==a.allow_comments,b.media_type=a.media_type,a.news_source=a.source,a.ignore_triples&&(b.ignore_triples=!0),"WFP Poll"==a.content_type&&(b.content_type=a.content_type,a.is_multivalue&&(b.is_multivalue=!0),b.customer_id=a.customer_id,b.mr=a.mr,b.message=a.message,b.total_votes=a.total_votes,b.related_url=a.related_url,b.answers=a.answers),b.image_credit=a.image_credit&&a.image_credit.length>0?a.image_credit:"",b=$.extend(b,n(a))}function m(a){var b;if(a.indexOf(" | ")!=-1){var c=a.split(" | ");b=c}else b=[a];return b}function n(b){var c={};b.hasOwnProperty("short_title")&&b.short_title.length?c.title=b.short_title:c.title=b.title,c.ogtitle=b.title,c.teaser=b.teaser&&"string"==typeof b.teaser?m(b.teaser):"",c.description=b.teaser&&"string"==typeof b.teaser?b.teaser.replace("|",""):"";var d="";return b.image_caption?(c.image_caption=b.image_caption,c.image_caption.length>160&&(c.image_caption=c.image_caption.slice(0,160)+"..."),"false"==c.image_caption&&(c.image_caption=""),d=""+c.image_caption):d=""+c.description,d=d.replace('"',""),d.length>125&&(d=d.slice(0,120)+"..."),c.alt_tag=d,b.author?c.author=b.author:"cp-flag"==b.news_source?c.author="The Canadian Press":"wfp-bang"==b.news_source?c.author="Bang Showbiz":"bs-square"==b.news_source?c.author="The Brandon Sun":"wave"==b.news_source?c.author="The Wave":"healthday"==b.news_source?c.author="Health Day":"canstar-star"==b.news_source?c.author="Canstar Community News":c.author="Winnipeg Free Press",c.news_source=b.news_source,"0"==b.cost||a.display_as_free?c.cost=!1:c.cost=b.cost,b.media_type&&(c.media_type=k(b.media_type)),b.hasOwnProperty("image_dimensions")?c.dimensions=b.image_dimensions:b.hasOwnProperty("dimensions")&&(c.image_dimensions=b.dimensions),c}function o(a){var b=M.cxense_news_sources[G];if("widget"==b.type){var c={};if("/"!=M.path){var d=M.path.replace(/^\//,"").replace(/\/$/,"");c={user:{likes:{categories:[d]}}}}cX.insertWidget({widgetId:b.id,renderFunction:function(c){try{r(c,a,b.type)}catch(a){WFPUtils.error("Error on handling CXense Data",a)}}},c)}else{var e;window.wfp_config.section_render&&(e=window.wfp_config.section_name,H=WFPUtils.isEmpty(I[e])?0:I[e]);var f=h(M.path,H,M.cxense_search_articles_per_page);H+=M.articles_per_page,window.wfp_config.section_render&&(I[e]=H);var g=$.ajax({url:b.url,dataType:"jsonp",data:f});$.when(g).done(function(c){r(c.response,a,b.type)})}}function p(a){var b=window.wfp_config.section_name;H=WFPUtils.isEmpty(I[b])?0:I[b];var c=q(L),d=g(M.persisted_id,H,M.cxense_search_articles_per_page,c);H+=M.articles_per_page,window.wfp_config.section_render&&(I[b]=H);var e=$.ajax({url:M.cxense_search_url,dataType:"jsonp",data:d});$.when(e).done(function(b){r(b.response,a,"persisted")})}function q(a){var b=Date.create(M.current_time),c=new Date,d=new Date;0===a?(c.setDate(b.getDate()),d=0):(c.setDate(b.getDate()-a),d.setDate(b.getDate()-(a-1)));var e=M.current_timezone;return{start:c,end:d,timezone:e}}function r(a,b,c){var d=[];if("widget"==c)a.hasOwnProperty("response")&&a.response.items.length>0&&a.response.items.forEach(function(a){d.push(j(a))});else if("persisted"==c)if(M.cxense_persisted_search=!0,a.hasOwnProperty("matches")&&a.matches.length>0)a.matches.forEach(function(a){var b={};a.fields.forEach(function(a){b[a.field]=a.value}),d.push(j(b))});else{WFPSections.resetBottomScroll(),L++,H=0,I.bottom=0;var e=q(L),f={weekday:"long",year:"numeric",month:"long",day:"numeric"};WFPSections.setBottomWords("Click to Load News On "+e.start.toLocaleDateString("en-CA",f))}else a.hasOwnProperty("matches")&&a.matches.length>0&&a.matches.forEach(function(a){var b={};a.fields.forEach(function(a){b[a.field]=a.value}),d.push(j(b))});var g={};g=window.wfp_config.section_render?s(d,window.wfp_config.section_name):s(d);var h=Math.floor(d.length*(M.dedupe_threshold_percent/100));(h<g.dedupe_count||0===d.length)&&G<M.cxense_news_sources.length-1&&"persisted"!==c&&G++,v(g.news_items,b)}function s(a,b){var c=[],d=0;return WFPUtils.isEmpty(b)?a.forEach(function(a){B.hasOwnProperty(a.id)?(B[a.id]++,d++):(B[a.id]=1,c.push(a))}):("breakingnews"!==b&&"local"!==b||(C.local=$.extend(C.breakingnews,C.local)),a.forEach(function(a){!WFPUtils.isEmpty(C[b])&&C[b].hasOwnProperty(a.id)?(C[b][a.id]++,d++):(WFPUtils.isEmpty(C[b])&&(C[b]={}),C[b][a.id]=1,c.push(a))})),{news_items:c,dedupe_count:d}}function t(a,b){var c=[];for(var d in a.results){var e=a.results[d];c.push(l(e))}var f={};f=window.wfp_config.section_render?s(c,window.wfp_config.section_name):s(c),v(f.news_items,b)}function u(a){var b={page:F,limit:M.articles_per_page};"/"!=M.path&&(b.path="/"+M.path);var c=$.ajax({url:M.wfp_backup,cache:!1,type:"POST",dataType:"jsonp",data:b});$.when(c).done(function(b){t(b,a)}),F++}function v(a,b){var c;window.wfp_config.section_render?(c=window.wfp_config.section_name,D=WFPUtils.isEmpty(E[c])?[]:E[c]):c=window.news_config.path.replace("/",""),Array.prototype.push.apply(D,a);var d=D.slice(0,M.articles_per_page);D=D.slice(M.articles_per_page),window.wfp_config.section_render&&(E[c]=D),d.length<M.articles_per_page&&J<M.max_attempts?(J++,Array.prototype.push.apply(D,d),window.wfp_config.section_render&&(E[c]=D),y(b)):(w(c),clearTimeout(z),b.resolve(d))}function w(a){var b=window.wfp_config.widget_data.v4_spillbox;if("undefined"!=typeof b){var c=[],d=$.inArray(a,["breakingnews","local"])>-1?"Latest News":"Recommended",e={};window.wfp_config.section_render?window.wfp_config.section_render_loadmore!==!1||WFPUtils.isEmpty(window.wfp_config.widget_data.v4_spillbox)||(WFPUtils.isEmpty(D)||(c=D.splice(0,7)),c.length>6&&(e={id:"section_id_"+a,title:d,articles:c},b.sections.unshift(e)),E[a]=D):!WFPUtils.isEmpty(window.wfp_config.widget_data.v4_spillbox)&&WFPUtils.isEmpty(window.wfp_config.spillbox_inited)&&(WFPUtils.isEmpty(D)||(c=D.splice(0,7)),c.length>6&&(e={id:"section_id_"+a,title:d,articles:c},b.sections.unshift(e)),window.wfp_config.spillbox_inited=!0)}}function x(a){J=0;var b=$.Deferred();M.articles_per_page=a;var c,d=M.articles_per_page;if(window.wfp_config.section_render){var e=window.wfp_config.section_name;D=WFPUtils.isEmpty(E[e])?[]:E[e],window.wfp_config.section_render_loadmore!==!1||WFPUtils.isEmpty(window.wfp_config.widget_data.v4_spillbox)||(c=7-(D.length-M.articles_per_page),c>-1&&(d+=c))}else!WFPUtils.isEmpty(window.wfp_config.widget_data.v4_spillbox)&&WFPUtils.isEmpty(window.wfp_config.spillbox_inited)&&(c=7-(D.length-M.articles_per_page),c>-1&&(d+=c));return D.length<d?y(b):v([],b),b.promise()}function y(a){"cxense"==M.news_source?(z=setTimeout(function(){"pending"==a.state()&&u(a)},M.cxense_timeout),M.cxense_persisted_search?p(a):o(a)):u(a)}var z,A={setNewsSource:i,getNews:x,receiveCxenseNews:r,emptyNewsItem:f,convertMultiParagraphs:m,convertNewsDataForSite:n,mergeClickNews:l,init:e,sectionInit:d,setConfig:b,clearNewsPipeline:c},B={},C={},D=[],E={},F=1,G=0,H=0,I={},J=0,K=f(),L=0,M={path:"/",news_source:"cxense",dedupe_threshold_percent:70,cx_site_id:"9222350621649330874",cxense_timeout:5e3,wfp_backup:"http://www.winnipegfreepress.com/templates/V4_News_Feed.json",articles_per_page:20,cxense_search_articles_per_page:20,max_attempts:3,name_search:"",cxense_persisted_search:!1,persisted_id:"",suppress_sections:["arts-and-life/events","special/fringe/reviews"],minimum_content_date:!1,display_as_free:!1};return $.extend(M,a),A}(news_config),WFPPlinkoLogic=function(){function a(a){n=a,m=d(n.non_news_widgets)}function b(){l={}}function c(a){var b=[],c=[],d={};for(var e in a){var f=a[e];if(!d.hasOwnProperty(f.id)){var g="v4_tile_article_no_image";f.image&&(g="portrait_tall"==f.image_info.image_type?"v4_tile_article_full_image":"v4_tile_article_image"),"WFP Poll"==f.content_type&&(g="v4_tile_poll"),b.push({type:g,data:f})}}return Array.prototype.push.apply(b,c),b}function d(a){var b=[];for(var c in a)for(var d=0;d<a[c].weight;d++)b.push(c);return b}function e(a){var b,c,d,e,h,k,l,o={},p=[],q=[],r=0;for(c in n.non_news_widgets)q.push(c),r++;if(0===r)return[];q=j(q);for(l in q){if(c=q[l],b=n.non_news_widgets[c],b.min&&g(c)<b.min)for(h=b.min-g(c),d=0;d<h;d++)p.push({type:c,data:b.data}),i(c);f(c)&&(e=f(c)-g(c),e=e<0?0:e,o[c]=e)}for(k=0;p.length<a&&k<100;)k++,c=m[Math.floor(Math.random()*m.length)],b=n.non_news_widgets[c],(!o.hasOwnProperty(c)||o[c]>0)&&(p.push({type:c,data:b.data}),k=0,o.hasOwnProperty(c)&&o[c]--);if(p.length<a)for(d=p.length;d<a;d++)c=m[Math.floor(Math.random()*m.length)],b=n.non_news_widgets[c],p.push({type:c,data:b.data});return j(p).slice(0,a)}function f(a){var b=n.non_news_widgets[a],c=0;if(n.non_news_widgets[a].hasOwnProperty("count_group")){var d=n.non_news_widgets[a].count_group;c=n.count_groups[d].max}else b.max&&(c=b.max);return c}function g(a){var b,c,d=0;if(n.non_news_widgets[a].hasOwnProperty("count_group")){var e=n.non_news_widgets[a].count_group,f=n.count_groups[e]?n.count_groups[e].types:[a];for(b in f)c=f[b],l.hasOwnProperty(c)&&(d+=l[c])}else l.hasOwnProperty(a)&&(d=l[a]);return d}function h(a){for(var b in a){var c=a[b];i(c)}}function i(a){l.hasOwnProperty(a)?l[a]++:l[a]=1}function j(a){for(var b=a.length-1;b>0;b--){var c=Math.floor(Math.random()*(b+1)),d=a[b];a[b]=a[c],a[c]=d}return a}var k={createNonNewsWidgetBatch:e,startBatch:b,initLogic:a,addArrayToBatchCount:h,createNewsWidgetBatch:c},l={},m=[],n={};return k}(),wfp_config=wfp_config||{},news_config=news_config||{path:"/"},WFPPlinko=function(a,b,c,d,e,f,g,h){function i(a){h.extend(P,a)}function j(a){a||(a=[]);var b,e,f,i;for(b in P.non_news_widgets)e=P.non_news_widgets[b],e.hasOwnProperty("count_group")&&P.count_groups[e.count_group]&&(group=e.count_group,P.count_groups[group].hasOwnProperty("types")?P.count_groups[group].types.push(b):P.count_groups[group].types=[b]);N={top:{items:[],randoms:[]},loadmore:{items:[],randoms:[]}};try{var j={};if(!g.isEmpty(history.state.sections)&&!g.isEmpty(history.state.sections[P.section_name])&&(j=history.state.sections[P.section_name],j&&(j.top.items.length||j.loadmore.items.length)&&2===window.performance.navigation.type&&!navigator.userAgent.match("CriOS"))){N=j,M=!0;for(f in N.top.items)e=N.top.items[f],e.data&&e.data.id&&a.push(e.data.id);for(f in N.loadmore.items)e=N.loadmore.items[f],e.data&&e.data.id&&a.push(e.data.id)}}catch(a){g.log("History State Not Supported")}if(P.editorial_override&&P.editorial_override.length)for(f in P.editorial_override)if(e=P.editorial_override[f],e.data&&e.data.id)a.push(e.data.id);else if(e.data&&e.data.items)for(i in e.data.items)e.data.items[i].id&&a.push(e.data.items[i].id);M?c.sectionInit(m(),{},a):(g.isEmpty(a)||g.isEmpty(P.widget_data.breaking_news)||P.widget_data.breaking_news.forEach(function(b,c,d){h.inArray(b.id,a)>-1&&d.splice(c,1)}),c.sectionInit(m(),P.widget_data.breaking_news,a)),d.initLogic(P)}function k(a){N={top:{items:[],randoms:[]},loadmore:{items:[],randoms:[]}};try{var b={};b=history.state.sections[P.section_name],b&&(N=b,M=a)}catch(a){g.log("Section Cache Not supported")}}function l(a){a||(a=[]);var b,e,f,i;for(b in P.non_news_widgets)e=P.non_news_widgets[b],e.hasOwnProperty("count_group")&&P.count_groups[e.count_group]&&(group=e.count_group,P.count_groups[group].hasOwnProperty("types")?P.count_groups[group].types.push(b):P.count_groups[group].types=[b]);N={items:[],randoms:[]};try{var j=history.state;if(j&&j.items.length&&2===window.performance.navigation.type&&!navigator.userAgent.match("CriOS")){N=j,M=!0;for(f in N.items)e=N.items[f],e.data&&e.data.id&&a.push(e.data.id)}}catch(a){g.log("Cache Not supported")}if(P.editorial_override&&P.editorial_override.length)for(f in P.editorial_override)if(e=P.editorial_override[f],e.data&&e.data.id)a.push(e.data.id);else if(e.data&&e.data.items)for(i in e.data.items)e.data.items[i].id&&a.push(e.data.items[i].id);g.isEmpty(a)||g.isEmpty(P.widget_data.breaking_news)||P.widget_data.breaking_news.forEach(function(b,c,d){h.inArray(b.id,a)>-1&&d.splice(c,1)}),c.init(m(),P.widget_data.breaking_news,a),d.initLogic(P)}function m(){var a,b,c,d,e,f=[];if(P.hasOwnProperty("widget_data")&&P.widget_data.hasOwnProperty("dynamic_spotlight_bars")){for(b in P.widget_data.dynamic_spotlight_bars)if(a=P.widget_data.dynamic_spotlight_bars[b],a.hasOwnProperty("type")&&"v4_spotlight_bar_news"==a.type)for(c in a.articles)e=a.articles[c],e.hasOwnProperty("id")&&f.push(e.id)}else if(P.hasOwnProperty("widget_data")&&P.widget_data.hasOwnProperty("spotlight_bars"))for(b in P.widget_data.spotlight_bars){d=P.widget_data.spotlight_bars[b];for(c in d)e=d[c],e.hasOwnProperty("id")&&f.push(e.id)}return f}function n(){var a=h.Deferred();if(M)h.when(g.getReady()).done(function(b){M=!1,P.section_render?G():(K=!1,F()),P.disable_pluck||WFPComments.retrieveCachedComments(),o(),a.resolve(),f.setupAccountStateElements()});else{var b=P.expecting_news_articles?P.articles_per_refresh:0;h.when(g.getReady(),c.getNews(b)).done(function(c,d){K||d.length||!P.expecting_news_articles?(t(d),o(),P.disable_pluck?B():h.when(WFPComments.retrieveComments()).done(function(){B()}),!P.expecting_news_articles||d.length<b?a.reject():a.resolve(),f.setupAccountStateElements()):a.reject()})}return a.promise()}function o(){var a=b.section_name||b.path;"/"!=b.path?ga("send","pageview",{page:b.path,title:a}):ga("send","pageview")}function p(){var a=null,b=null;b=h("."+P.spotlight_container).last().length?h("."+P.spotlight_container).last().next(P.widget_class):h(P.container+" "+P.widget_class).first();for(var c=0,d=b,e=0;e<P.tiles_between_spotlights;e++)d.length&&(c+=parseInt(d.attr("size"),10),c==P.tiles_between_spotlights&&(a=d)),d=b.nextAll(P.widget_class).eq(e);return a}function q(a,b){h(b).append('<h3><a href="'+a.url+'">'+a.title+"</a></h3>");var d,e,f;for(d in a.articles)e={},f=a.articles[d],f.image?e.type="v4_tile_spotlight_image":e.type="v4_tile_spotlight_no_image",h.extend(f,c.mergeClickNews(f)),e.data=f,"FP Fringe Review"==f.content_type&&(e.data.have_rating=!0),function(a,b){v(b,function(b){return h(a).append(b),b})}(b,e)}function r(){var a,b,c,d;if(P.section_render)for(a in P.widget_data.dynamic_spotlight_bars)b=P.widget_data.dynamic_spotlight_bars[a],d=g.buildElement("div",{class:P.spotlight_container+" empty"}),h(P.container).append(d),void 0!==typeof d&&("v4_spotlight_bar_news"==b.type?q(b,d):!function(a,b){v(b,function(b){return h(a).append(b),b})}(d,b));else{h("."+P.spotlight_container).remove();for(a in P.widget_data.dynamic_spotlight_bars)b=P.widget_data.dynamic_spotlight_bars[a],c=p(),c&&c.length&&(h(c).after('<div class="'+P.spotlight_container+'"></div>'),d=c.next("."+P.spotlight_container),"v4_spotlight_bar_news"==b.type?q(b,d):!function(a,b){v(b,function(b){return h(a).append(b),b})}(d,b))}}function s(){P.hasOwnProperty("widget_data")&&P.widget_data.hasOwnProperty("dynamic_spotlight_bars")&&r()}function t(a){var b=[];d.startBatch();var c=0,e=[];K&&!P.section_render_loadmore&&(b=x(P.editorial_override),b=b.concat(x(P.first_run,!0)),c+=w(b),d.addArrayToBatchCount(b)),e=d.createNewsWidgetBatch(a);var f=Math.ceil(e.length/(P.news_widget_percentage/100)-e.length),g=(c+e.length+f)%3;0!==g&&(f+=3-g);var h=d.createNonNewsWidgetBatch(f);u(e,h),K&&!P.section_render_loadmore&&(s(),P.section_render||(K=!1))}function u(a,b){for(var c=P.news_widget_percentage/100,d=5,e=!1,f=c,g=0,h=0,i=0,j=0;j<a.length+b.length;j++)if(g<a.length&&h<b.length){var k=Math.random()<f||j<d||e;k?(v(a[g]),g++,i=-(1-f)*c,e=!1):(v(b[h]),h++,i=(1-f)*c,e=!0),f+=i}else g<a.length?(v(a[g]),g++):(v(b[h]),h++)}function v(a,b,c){"undefined"==typeof b&&(b=y,c||I(a));var d={};if(a.data&&"string"==typeof a.data)d=P.widget_data[a.data];else if(a.data&&a.data.length)for(var f in a.data){var h=a.data[f];d[h]=P.widget_data[h]}else d=a.data?a.data:{};if(P.override_urls)if(d&&d.hasOwnProperty("url")&&d.url)d.click_url=g.overrideUrls(d.url);else if(d&&d.items&&d.items.length)for(var i in d.items)d.items[i].hasOwnProperty("url")&&d.items[i].url&&(d.items[i].click_url=g.overrideUrls(d.items[i].url));e.display(a.type,d,function(c){return b(c,a.position)})}function w(a){var b=0;for(var c in a){var d=a[c];L.hasOwnProperty(d)?b+=L[d]:b++}return b}function x(a,b){var d,e,f=[];for(d in a){if(e=a[d],e.data&&e.data.image_dimensions&&(e.data.image_info=g.determinePhotoType(e.data.image_dimensions)),e.data&&e.data.id)h.extend(e.data,c.mergeClickNews(e.data));else if(e.data&&e.data.items)for(d in e.data.items)h.extend(e.data.items[d],c.mergeClickNews(e.data.items[d]));
f.push(e.type),e.hasOwnProperty("position")&&e.position.hasOwnProperty("size")?L[e.type]=e.position.size:e.hasOwnProperty("position")&&(e.position.skip_first_tiles=!!b),v(e)}return f}function y(a,b){var c="available",d=!1,e=1;if(h(a).attr("size",e),b)if("fixed"==b.positioning){var f=".position_"+b.tile;if(b.hasOwnProperty("size")){e=b.size,h(a).attr("size",e);for(var g=1;g<b.size;g++)f=P.container+" .position_"+(parseInt(b.tile,10)+g),h(f).remove()}if(f=".position_"+b.tile,h(f).length)return h(a).replaceAll(P.container+" "+f),a}else"random"==b.positioning&&(c="random",b.cached&&(d=b.cached));if("random"==c){var i=h(P.container+" "+P.widget_class+P.widget_preload).length;if(i){var j;j=d?d:b&&b.skip_first_tiles?6+Math.floor(Math.random()*(i-6)):Math.floor(Math.random()*i),H(j),h(a).replaceAll(h(P.container+" "+P.widget_class+P.widget_preload).get(j))}else h(P.container).append(a)}else h(P.container+" "+P.widget_class+P.widget_preload+":first").length?h(a).replaceAll(P.container+" "+P.widget_class+P.widget_preload+":first"):h(P.container).append(a);return a}function z(){h.when(g.getReady()).done(function(a){e.display("v4_top_most_commented",{pluckSection:"News"},A)})}function A(a){return h.when(g.getReady()).done(function(){var b="#"+P.most_commented_id+" ."+P.widget_container_class;h(b).append(a)}),a}function B(){P.section_render?E():C()}function C(){if(N&&N.items&&N.items.length&&!navigator.userAgent.match("CriOS"))try{history.replaceState(N,"Title")}catch(a){g.log("saving cache not supported")}}function D(){if(window.history.state&&!navigator.userAgent.match("CriOS"))try{O=window.history.state,O.scroll_position=h(window).scrollTop(),history.replaceState(O,"Title")}catch(a){g.log("saving section scroll cache not supported")}}function E(){if(N&&(N.top.items.length||N.loadmore.items.length)&&!navigator.userAgent.match("CriOS"))try{O=window.history.state,g.isEmpty(O.sections)&&(O.sections={}),O.sections[P.section_name]=N,history.replaceState(O,"Title")}catch(a){g.log("saving section cache not supported")}}function F(){for(var a=0;a<N.items.length;a++){var b=N.items[a];b.position&&"random"==b.position.positioning&&(b.position.cached=N.randoms.shift()),"v4_tile_my_news"==b.type&&(delete b.data.read_articles,delete b.data.saved_articles),v(b,y,!0)}s()}function G(){N.top.items.forEach(function(a){a.position&&"random"===a.position.positioning&&(a.position.cached=N.top.randoms.shift()),"v4_tile_my_news"===a.type&&(delete a.data.read_articles,delete a.data.saved_articles),v(a,y,!0)}),K&&!P.section_render_loadmore&&s(),N.loadmore.items.forEach(function(a){a.position&&"random"===a.position.positioning&&(a.position.cached=N.top.randoms.shift()),"v4_tile_my_news"===a.type&&(delete a.data.read_articles,delete a.data.saved_articles),v(a,y,!0)})}function H(a){if(P.section_render)try{P.section_render_loadmore?N.loadmore.randoms.push(a):N.top.randoms.push(a)}catch(a){g.log("recordRandomPositions: "+a)}else N.randoms.push(a)}function I(a){if(P.section_render)try{P.section_render_loadmore?N.loadmore.items.push(a):N.top.items.push(a)}catch(a){g.log("recordWidget: "+a)}else N.items.push(a)}var J={init:l,sectionInit:j,displayWidgets:n,setConfig:i,setupTopCommented:z,initSectionWidgetCache:k,commitScrollPosition:D},K=!0,L={},M=!1,N={},O={sections:[],scroll_position:0},P={section_render:!1,section_render_loadmore:!1,container:".tile-container .block",widget_class:".tile",widget_preload:".preload",spotlight_container:"spotlight",spotlight_empty:"empty",widget_container_class:"widget-container",most_commented_id:"mostCommented",news_widget_percentage:95,articles_per_refresh:20,widget_cache_expiry:5,disable_pluck:!1,editorial_override:[],override_urls:!0,expecting_news_articles:!0,first_run:[{type:"v4_tile_double_adweather",data:"v4_current_weather",position:{tile:3,positioning:"fixed"}},{type:"v4_tile_my_news",data:{},position:{tile:9,positioning:"fixed"}},{type:"v4_tile_double_poll_vertical",data:["v4_poll","v4_autos"],position:{positioning:"random"}},{type:"v4_tile_flyertown",data:{},position:{positioning:"random"}}],non_news_widgets:{v4_tile_homes_top_jobs:{min:1,max:1,weight:4,data:["v4_homes","v4_top_jobs"]},v4_tile_ad_filler_news:{min:1,weight:6,data:"v4_filler_news"}},count_groups:{ads:{max:1}}};h.extend(P,a);var Q=P.widget_data&&P.widget_data.dynamic_spotlight_bars?P.widget_data.dynamic_spotlight_bars.length*P.tiles_between_spotlights:0;return P.articles_per_refresh<P.first_run.length+Q&&(P.articles_per_refresh=P.first_run.length+Q),J}(wfp_config,news_config,WFPNewsHandler,WFPPlinkoLogic,WFPWidget,WFPUser,WFPUtils,$),WFPMixinFactory=function(a,b){b?a.call(b):WFPUtils.log("mixin failed to create - undefined")},WFPMixin=function(a){function b(a,b){d[a]=b}function c(a){return d[a]}var d={},e={add:b,get:c};return e}(Class);!function(){function a(a,b){var c=b.id;b.no_comments=!!b.no_comments,b.no_comments||WFPComments.addArticleLookup(c,function(a){b.comment_count=a.commentCount,$(".tile-container").find(".article_"+c+" .commentCount").html(a.commentCount)})}WFPMixin.add("v4_comments",function(){this.addPostRender(function(b){var c,d,e=WFPUtils.dataToArray(this.data);for(c=0;e&&c<e.length;c++)d=e[c],"undefined"!=typeof d.comment_count?WFPComments.addCachedCommentCount(d.id,d.comment_count,function(a,b){$(".tile-container").find(".article_"+a+" .commentCount").html(b)}):a(b,d)})})}(),function(){WFPMixin.add("v4_date",function(){this.addPreRender(function(a){var b,c;a.hasOwnProperty("video")&&a.hasOwnProperty("photo")&&(a=a.video);var d=WFPUtils.dataToArray(a);for(b=0;d&&b<d.length;b++)c=d[b],c.publish_date=WFPUtils.formatDate(c.publish_time),c.hasOwnProperty("original_publish_time")&&c.publish_date!=WFPUtils.formatDate(c.original_publish_time)?c.use_updated_date=!0:c.use_updated_date=!1})})}(),function(){function a(a){var b,d,e=WFPUtils.dataToArray(this.data);for(b=0;b<e.length;b++)d=e[b],c(a,d)}function b(a,b){var c=$(Mustache.render(d,b));return c.find(".go-back-button").on("click",function(a){c.hide(),a.preventDefault()}),$(".read-later",c).on("click",function(a){a.preventDefault(),WFPMyNews.readArticleLater(b),$(this).addClass("saved")}),c.appendTo(a).hide(),c}function c(a,c){a=$(a);var d,e=a.find(".article_"+c.id+" .hover-element");e.on("mouseenter click",function(){d||(d=b(a,c)),d.show()}),a.on("mouseleave",function(a){d&&d.hide()})}var d;WFPUtils.getReady().then(function(){d=document.getElementById("v4_hover_summary").innerHTML}),WFPMixin.add("v4_hover_summary",function(){this.addPreRender(function(a){a.show_hover_element=!0}),this.addPostRender(a)})}(),function(){function a(a){this.data.image_caption&&c(a,this.data)}function b(a,b){var c=$(Mustache.render(d,b));return c.find(".hide").on("click",function(a){c.slideUp(100),a.preventDefault()}),c.appendTo($(".image",a)).hide(),c}function c(a,c){a=$(a);var d,e=a.find(".image");e.on("mouseenter",function(){d||(d=b(a,c)),d.slideDown(100)}),a.on("mouseleave",function(a){d&&d.slideUp(100)}),c.sticky_caption&&(d||(d=b(a,c)),d.slideDown(100))}var d;WFPUtils.getReady().then(function(){d=document.getElementById("v4_photo_caption").innerHTML}),WFPMixin.add("v4_photo_caption",function(){this.addPreRender(function(a){a.show_photo_caption=!0}),this.addPostRender(a)})}(),function(){function a(a,b){$(".read-later",a).on("click",function(a){a.preventDefault(),WFPMyNews.readArticleLater(b),$(this).addClass("saved")})}WFPMixin.add("v4_read_later",function(){this.addPostRender(function(b){for(var c=WFPUtils.dataToArray(this.data),d=0;c&&d<c.length;d++)a(b,c[d])})})}(),function(){function a(a,b){var c=WFPUtils.overrideUrls(b.url);$.ajax({url:WFPUtils.shareThisConfig().url,data:{cb:"WFPUtils.stCallBack",url:c,pubKey:WFPUtils.shareThisConfig().apiKey},type:"GET",crossDomain:!0,dataType:"jsonp",complete:function(){var c=news_config.stCount;b.share_count=c,$(a).find(".article_"+b.id+" .shareCount").html(c),delete news_config.stCount}})}WFPMixin.add("v4_sharethis",function(){WFPUtils.isEmpty(window.wfp_config.section_render)&&this.addPostRender(function(b){var c,d,e=WFPUtils.dataToArray(this.data);for(c=0;e&&c<e.length;c++)d=e[c],a(b,d)})})}(),WFPWidget.add("v4_modal_federal_election_candidate_profile",{data:null,render:function(a){return a.instagram&&(a.instagram=this.fixUrls(a.instagram)),a.facebook&&(a.facebook=this.fixUrls(a.facebook)),a.website&&(a.website=this.fixUrls(a.website)),a.twitter&&(a.twitter=this.fixTwitter(a.twitter)),this.data=a,this._super(this.data)},attach:function(a){this.widget_node=a,$(".cancel, .close",a).click(function(){WFPModal.close()}),WFPUtils.gaEvent("Candidate clicked",this.data.first_name+" "+this.data.last_name)},fixTwitter:function(a){var b=a,c="",d=/^@/;return d.test(a)&&(c="https://www.twitter.com/"+a),{display:b,link:c}},fixUrls:function(a){var b=/^((http|https):\/\/)/;return b.test(a)||(a="http://"+a),a}}),WFPWidget.add("v4_modal_federal_election_quiz",{data:null,unique_id:!1,user_answers:{},user_questions:[],subs:{landing:"v4_modal_federal_election_landing",answer:"v4_modal_federal_election_answer",question:"v4_modal_federal_election_question",results:"v4_modal_federal_election_results"},postinit:function(){for(var a=!1;!a;){var b=Math.floor(9996777213*Math.random()),c="v4_modal_federal_election_quiz"+b;document.getElementById(c)||(this.unique_id=c,a=!0)}},render:function(a){return this.data=a,this.data.unique_id=this.unique_id,this._super(this.data)},attach:function(a){this.widget_node=a,$(".cancel, .close",a).click(function(){$(".electionquiz a").each(function(){$(this).attr("data-default-open")&&$(this).html($(this).attr("data-default-open"))}),WFPModal.close()}),this.doReset(),WFPUtils.gaEvent("Election Quiz Opened",window.location.href)},setup_click_event_functions:function(a){var b=this;$("a",a).each(function(){!function(a){$(a).unbind("click"),$(a).click(function(){"new-question"==$(a).attr("data-page")?b.doQuestion.call(b):"do-answer"==$(a).attr("data-page")?b.doAnswer.call(b,$(a).attr("data-qid"),$(a).attr("data-aid")):"do-results"==$(a).attr("data-page")?b.doResults.call(b):"do-reset"==$(a).attr("data-page")&&b.doReset.call(b)})}(this)})},doQuestion:function(){if(!this.user_questions.length)return void this.doResults.call(this);this.arrayShuffle(this.user_questions);var a=this.user_questions[0];a.has_results=this.objCount(this.user_answers)>0,this.subRender("question",a)},doAnswer:function(a,b){var c=this.data.questions[a],d={},e=[];for(var f in c.answers){var g=c.answers[f];g.party=this.data.parties[g.party_id],g.answer_id==b?(d=g,this.user_answers[a]={answer_id:b,party_id:g.party_id}):e.push(g)}for(var h=0;h<this.user_questions.length;h++)this.user_questions[h].id==a&&this.user_questions.splice(h,1);var i={question:c.question,matched_answer:d,other_answers:e};this.subRender("answer",i)},doResults:function(){var a={},b=0;for(var c in this.user_answers){var d=this.user_answers[c];a.hasOwnProperty(d.party_id)?a[d.party_id]++:a[d.party_id]=1,b++}if(!b)return void this.doQuestion.call(this);var e=this.sortResults(a,b),f=e[0].matched,g={best_match:[],other_matches:[],total:b,tied:!1};for(var c in e){var h=e[c];h.matched==f?(g.best_match.push(h),WFPUtils.gaEvent("Election Quiz Match",h.party.name)):g.other_matches.push(h)}g.best_match.length>1&&(g.tied=!0),this.subRender("results",g),WFPUtils.gaEvent("Election Quiz Results",window.location.href)},sortResults:function(a,b){for(var c=[],d=0,e=!1;!e&&d<100;){d++;var f=0,g=0;for(var h in a)a[h]>f&&(f=a[h],g=h);c.push({party:this.data.parties[g],matched:f,percentage_matched:Math.round(f/b*100)}),delete a[g],e=!0;for(var i in a)e=!1}return c},doReset:function(){this.user_answers={},this.user_questions=[];for(var a in this.data.questions){var b=this.data.questions[a];b.id=a,this.arrayShuffle(b.answers);for(var c in b.answers)b.answers[c].party_id=b.answers[c].party_answers.join();this.user_questions.push(b)}this.arrayShuffle(this.user_questions),this.subRender("landing")},objCount:function(a){var b=0;for(var c in a)b++;return b},arrayShuffle:function(a){for(var b=a.length-1;b>0;b--){var c=Math.floor(Math.random()*(b+1)),d=a[b];a[b]=a[c],a[c]=d}return a},subRender:function(a,b,c){var d=$("#"+this.subs[a]).html();Mustache.parse(d);var e=Mustache.render(d,b),f="#"+this.unique_id+" .partial-content-container";$(f).html(e),"undefined"!=typeof c?c.call(this,this.widget_node):this.setup_click_event_functions.call(this,this.widget_node)}}),WFPWidget.add("v4_modal_finalize_payment",{data:null,render:function(a){return this.data=a,this._super(this.data)},attach:function(a){var b=this.getUrlParameter("payment_type");$.when(WFPUser.finalizePayment(b)).done(function(b){$(".registering-pending",a).hide(),$(".success-message",a).html("<p>Success!</p>").show(),$(".finalized-success",a).show();var c=WFPUser.getUser("paymentRedirect");c||(c="http://www.winnipegfreepress.com"),function(a){setTimeout(function(){WFPUser.deleteUser("paymentRedirect"),WFPUser.deleteUser("v4_user_state"),window.location.href=a},3e3)}(c)}).fail(function(b){$(".registering-pending",a).hide(),$(".error-message",a).html("<p>Something went wrong.</p>").show(),$(".finalized-failure",a).show()})},getUrlParameter:function(a){for(var b=window.location.search.substring(1),c=b.split("&"),d=0;d<c.length;d++){var e=c[d].split("=");if(e[0]==a)return e[1]}return!1}}),WFPWidget.add("v4_modal_general_error",{data:null,render:function(a){return this.data=a,this._super(this.data)},attach:function(a){this.widget_node=a,$(".cancel, .close",a).click(function(){WFPModal.close()})}}),WFPWidget.add("v4_modal_maintenance_mode",{data:null,render:function(a){return this.data=a,this._super(this.data)},attach:function(a){this.widget_node=a,$(".cancel, .close",a).click(function(){WFPModal.close()})}}),WFPWidget.add("v4_modal_payment_page",{data:null,render:function(a){return this.data=a,this._super(this.data)},attach:function(a){!function(a,b){$("form input",a).each(function(){""!==$(this).val()&&$(this).parent().addClass("floater"),function(a,b){$(a).keydown(b.updateText),$(a).change(b.updateText)}(this,b)})}(a,this),this.data&&this.data.hasOwnProperty("redirect_on_close")&&this.data.redirect_on_close?$(".cancel, .close",a).click(function(){window.location.href="/"}):$(".cancel, .close",a).click(function(){WFPModal.close()}),function(a,b,c,d){$(".choose-payment",b).click(function(){var e="credit_card";$(this).hasClass("paypal")&&(e="paypal"),d.createSession(a,b,c,e)})}(this.data.sso_link,a,this.data,this),function(a,b,c,d){$(".submit",b).click(function(){d.submitForm(a,b,c,"session_login",function(){})}),$(document).unbind("keypress"),$(document).keypress(function(e){"13"==e.which&&(e.preventDefault(),d.submitForm(a,b,c))})}(this.data.sso_link,a,this.data,this)},createSession:function(a,b,c,d){$(".error-message").hide(),$(".show-ajax-form").hide(),$(".success-message",b).html("<p>Redirecting you...</p>").show(),c.jsonp="true";var e=$("form").serializeArray(),f={};f.jsonp="true";for(var g in e){var h=e[g];f[h.name]=h.value}f.action="update_payment",f.payment_type=d,f.environment=c.environment;var i=WFPUtils.convertAPIUrl(a,f.action),j=$.ajax({url:i,data:f,dataType:"jsonp",cache:!1,method:"POST"});$.when(j).done(function(a){"false"==a.error&&"valid-account"==a.loginState&&a.payment_page.length?(WFPModal.close(),WFPUser.setUser("paymentRedirect",window.location.href,1),WFPUser.deleteUser("v4_user_state"),window.location.href=a.payment_page):($(".success-message").hide(),"account-already-exists"==a.loginState?($(".error-message").html("<p>You've already attached a paypal account to your login. Please contact our Customer Support at 697-7000 to remove or change your paypal information."),$(".choose-payment.paypal").hide()):$(".error-message").html("<p>An error occurred trying to process your payment.  Please try again."),$(".error-message").show())})},submitForm:function(a,b,c){$(".error-message").hide(),$("form .submit").val("submitting...");var d=$("form").serializeArray(),e={};for(var f in d){var g=d[f];e[g.name]=g.value}e.jsonp="true",e.action="session_login";var h=WFPUtils.convertAPIUrl(a,e.action),i=$.ajax({url:h,data:e,dataType:"jsonp",cache:!1,method:"POST"});$.when(i).done(function(a){"false"==a.error&&"valid-credentials"==a.loginState?($(".success-message",b).html("<p>Account verified! Please choose your payment type below.</p>").show(),$(".password-form",b).hide(),$(".payment-choice",b).show()):"invalid-password"==a.loginState?($(".error-message",b).html("<p>Invalid Password, please try again</p>").show(),$("form .submit").val("Continue")):($(".error-message",b).html("<p>Something went wrong, logging you out, please log fully back in again</p>").show(),function(a,d){setTimeout(function(){$(".error-message",b).hide(),WFPUser.logUserOut(),WFPModal.close();var e={force_login:!1,allow_remind_me:!1};$.when(WFPUser.openLoginPromise(e)).done(function(){WFPModal.close(),$.when(WFPModal.open()).done(function(b){c={sso_link:a,email:d,show_paypal_button:c.show_paypal_button,environment:c.environment},WFPWidget.display("v4_modal_payment_page",c,function(a){return $(b).append(a),b})})})},3e3)}(c.sso_link,c.email))})},updateText:function(a){var b=$(this);setTimeout(function(){var a=b.val();""!==a?b.parent().addClass("floater"):b.parent().removeClass("floater")},0)}}),WFPWidget.add("v4_modal_refund_box",{data:null,render:function(a){return this.data=a,"WFP News"==this.data.site_name?this.data.is_news_article=!0:"Passages"==this.data.site_name&&(this.data.is_obit=!0),this._super(this.data)},attach:function(a){$(".cancel",a).click(function(){WFPModal.close()});var b=this.data;$(".submit",a).click(function(){$(this).val("submitting..."),$(this).unbind("click");var c=$("form input[name=reason]:checked",a).val();"Other"==c&&(c=$("form textarea",a).val());var d={article_id:b.id,title:b.title,url:b.url,type:"Refunded",site:"WFP News",cost:-Math.abs(b.cost),refund_reason:c};!function(a,b,c){$.when(WFPUser.accessUserDB("save_article",b)).done(function(b){b&&b.refund_rejected?"over-refunded-minutes"==b.refund_rejected?$(".error-message",c).html("<p>Refund refused, it has been too long since you read this article</p>").show():"posted-comment"==b.refund_rejected&&$(".error-message",c).html("<p>Refund refused, you posted a comment</p>").show():($(".cancel",c).remove(),$(".submit",c).remove(),$(".success-message",c).html("<p>Refund applied! Redirecting you...</p>").show(),WFPUser.updateBalance(-a.cost),setTimeout(function(){window.location="/"},3e3)),setTimeout(function(){WFPModal.close()},4e3)}).fail(function(a){defer.fail(a),WFPUtil.xhrError("saveArticle fail",a),WFPModal.close()})}(b,d,a)}),$("#extra-info",a).css("display","none"),$(".reason",a).click(function(){"Other"==$("input[name=reason]:checked",a).val()?$("#extra-info",a).slideDown("fast"):$("#extra-info",a).slideUp("fast")})}}),WFPWidget.add("v4_modal_report_error",{maindata:null,render:function(a){return this.data=a,"object"==typeof app_config.article?this.data.article=app_config.article:this.data.article=null,WFPUser.isLoggedIn()?this.data.curUserInfo=WFPUser.getUser("curUserInfo"):this.data.curUserInfo=null,this._super(this.data)},attach:function(a){function b(){$(".V4-report-error",a).show(),$(".V4-report-confirm",a).hide()}function c(b){var c=$(b).attr("name");$(".error-"+c,a).hide()}function d(a){var b={};if($("input[name=contact]:checked").size()>0){var c={};for(var d in a){var e=a[d];c[e.name]=e.value}if("Yes"===c.contact){if(c.email.length&&c.fullname.length&&c.errorDescription.length){var f=/^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;return!f.test(c.email)&&(b.email="Please enter a valid e-mail address",b)}return c.email||(b.email="Please enter your e-mail address"),c.fullname||(b.fullname="Please enter your name"),c.errorDescription||(b.errorDescription="Please provide some description"),b}var g=grecaptcha.getResponse(i),h=!0;return c.errorDescription.length?(""===g||"undefined"===g)&&(b.reCAPTCHA="Confirm that you are a person by checking the box and if prompted entering the displayed text",h=!1,b):(b.errorDescription="Please provide some description",b)}return b.contact="Please provide an option",b}function e(b){$(".error_message",a).hide();for(var c in b)f(c,b[c]);grecaptcha.reset(i)}function f(b,c){if($(".error-"+b,a).length){var d=$(".error-"+b).get(0);c&&$(d).html(c),$(d).css("display","block")}}function g(){$(".V4-report-error",a).hide(),$(".V4-report-confirm",a).show(),setTimeout(function(){WFPModal.close()},2e3)}if(b(),$("#extra-info, #v4-recaptcha-report-error",a).css("display","none"),$(".contact",a).click(function(){"Yes"==$("input[name=contact]:checked",a).val()?($("#v4-recaptcha-report-error").hide(),$(".error-reCAPTCHA",a).hide(),$("#extra-info",a).slideDown("fast")):($("#v4-recaptcha-report-error").show(),$("#extra-info",a).slideUp("fast"))}),$("input, textarea",a).on("change",function(){c(this)}),$(".cancel, .V4-close-link",a).click(function(){WFPModal.close()}),"object"==typeof grecaptcha)var h=function(){""!==grecaptcha.getResponse(i)&&$(".error-reCAPTCHA",a).hide()},i=grecaptcha.render("v4-recaptcha-report-error",{sitekey:"6Ldm0P4SAAAAACRcmJ8q4LtKmNgfBLxuAtDzSSz-",callback:h});$(".submit",a).click(function(){var b="http://"+document.domain+"/handle-report-error/",c=$(".factCheck",a).serializeArray(),f=d(c);if(f)e(f);else{var h={name:"storyURL",value:document.location.href},i={name:"curPath",value:app_config.article.path};c.push(h,i),$.ajax({type:"POST",url:b,data:c,success:function(a){g()}})}})}}),WFPWidget.add("v4_modal_text_size",{data:null,render:function(a){return this.data=a,this._super(this.data)},attach:function(a){WFPUser.isLoggedIn()&&$(".text-wrapper").css("font-size",WFPUser.getUser("font_size",font_size)),$("#font-down",a).click(function(){font_size-2>=8&&($(".font-preview").css("font-size","-=2"),$("#font-size").text(font_size-=2)),font_size<=8&&$("#font-down").addClass("inactive"),font_size<30&&$("#font-up").removeClass("inactive")}),$("#reset",a).click(function(){font_size=16,$(".font-preview").css("font-size",font_size),$("#font-down").removeClass("inactive"),$("#font-up").removeClass("inactive"),$("#font-size").text(font_size=font_size)}),$("#font-up",a).click(function(){font_size+2<=30&&($(".font-preview").css("font-size","+=2"),$("#font-size").text(font_size+=2)),font_size>=30&&$("#font-up").addClass("inactive"),font_size>8&&$("#font-down").removeClass("inactive")}),$(".cancel",a).click(function(){WFPModal.close()}),$(".submit",a).click(function(){$.when(WFPUser.setUserAccountSetting("wfp_font_size",font_size)).done(function(){WFPUser.setUser("font_size",font_size),$(".text-wrapper").css("font-size",font_size),WFPModal.close()})})}}),WFPWidget.add("v4_modal_translate",{data:null,render:function(a){return this.data=a,this._super(this.data)},attach:function(a){$("#google_translate_element").detach().appendTo("#google_translate_placeholder"),$("#google_translate_element").show(),$(".V4-close-link",a).click(function(){$("#google_translate_element").hide(),$("#google_translate_element").detach().appendTo("#slide-menu"),WFPModal.close()})}}),WFPWidget.add("v4_modal_trial_alerts",{data:null,trial_length:30,render:function(a){return a&&a.hasOwnProperty("suppress_payment_links")&&a.suppress_payment_links?a.show_payment_links=!1:a.show_payment_links=!0,this.data=a,this.data.trial_length=this.trial_length,this._super(this.data)},attach:function(a){!function(a,b){$("form input",a).each(function(){""!==$(this).val()&&$(this).parent().addClass("floater"),function(a,b){$(a).keydown(b.updateText),$(a).change(b.updateText)}(this,b)})}(a,this),"SATURDAY"==this.data.account_state&&$(".hide-saturday").hide(),this.data.article_count&&$(".article-view-count").text(this.data.article_count),$("#"+this.data.alert_type,a).show(),function(b){b&&b.hasOwnProperty("redirect_on_close")&&b.redirect_on_close?$(".cancel, .close",a).click(function(){ga("send",{hitType:"event",eventCategory:"Trial End "+b.alert_type+" alert closed and redirected",eventAction:"close button",hitCallback:function(){WFPModal.close(),window.location.href="/"}})}):$(".cancel, .close",a).click(function(){WFPModal.close(),$(this).hasClass("redirect-home")&&ga("send",{hitType:"event",eventCategory:"Trial End "+b.alert_type+" alert closed and redirected",eventAction:"close button",hitCallback:function(){window.location.href="/"}})})}(this.data),function(a){$(".trial-end-allaccess-offsite").click(function(){ga("send",{hitType:"event",eventCategory:"Trial End "+a.alert_type+"click allaccess",eventAction:$(this).text(),hitCallback:function(){window.location.href="/subscribe/"}})})}(this.data);var b=this.data;$(".pay-as-you-go-signup",a).each(function(){WFPUser.applyPaymentLink(this,{redirect_on_close:!0,click_type:"Trial End "+b.alert_type+" click rnpl",click_value:$(this).text()})}),$(".show-ajax-form",a).click(function(){$(".ajax-form",a).show(),$(".trialscreen",a).hide()}),function(a,b,c){$(".submit",b).click(function(){$(this).val("Submitting...");var d=$(".ajax-form form",b).serializeArray(),e={};for(var f in d){var g=d[f];e[g.name]=g.value}e.jsonp="true",e.action="login_messages",e.action_type="synch_accounts";var h=WFPUtils.convertAPIUrl(a,e.action),i=$.ajax({url:h,data:e,dataType:"jsonp",cache:!1,method:"POST"});$.when(i).done(function(){$(".success-message",b).html("<p>Thank you, please allow up to 24 hours for verification</p>").show(),setTimeout(function(){WFPModal.close(),c&&(window.location.href="/")},5e3)})})}(this.data.ajax_link,a,this.data.redirect_on_close)},updateText:function(a){var b=$(this);setTimeout(function(){var a=b.val();""!==a?b.parent().addClass("floater"):b.parent().removeClass("floater")},0)}}),function(){WFPWidget.add("v4_page_my_news",{data:{},element:null,first_run:!0,unique_id:!1,max_articles:20,postinit:function(){for(var a=!1;!a;){var b=Math.floor(9996777213*Math.random()),c="my_news_"+b;document.getElementById(c)||(this.unique_id=c,a=!0)}},render:function(a){var b,c,d,e,f,g,h,i=0,j=0;if(this.data=a||{},this.data.unique_id=this.unique_id,a.logged_in=WFPUser.isLoggedIn(),this.data.read_articles){if(this.data.read_articles||this.data.saved_articles){i=this.max_articles<this.data.read_articles.length?this.max_articles:this.data.read_articles.length,j=this.max_articles<this.data.saved_articles.length?this.max_articles:this.data.saved_articles.length,c={read_articles:i,saved_articles:j},h=0;for(g in c){for(b=[],d=c[g],f=0;f<d;f++)e=this.data[g][f],e.update_time=WFPUtils.formatDate(e.updated_time),e.click_url=WFPUtils.overrideUrls(e.url),e.show_hover_element=!1,b.push(e),e.updated_since_read&&h++;this.data[g]=b}this.data.updated_count=h}}else this.handleArticles.call(this);return this._super(this.data)},handleArticles:function(){!function(a){$.when(WFPMyNews.getUserArticles(!0)).done(function(b){a.data.read_articles=[],a.data.saved_articles=[],a.reRender(b,a),function(a){WFPMyNews.updateArticles(function(b){a.reRender(b,a)})}(a)})}(this)},reRender:function(a,b){var c;return a&&(c=$(this.render(a)),this.addCommentsAndShares(a,c),WFPComments.retrieveComments(),this.first_run?($(b.widget_node).replaceWith(c),this.first_run=!1):(b.widget_node=document.getElementById(b.unique_id),$(b.widget_node).replaceWith(c))),c},addCommentsAndShares:function(a,b){for(var c=[a.read_articles,a.saved_articles],d=0;d<c.length;d++){var e=c[d];if(e)for(var f=0;f<e.length;f++)this.addCommentLookup.call(this,b,e[f]),this.findShares.call(this,b,e[f])}},findShares:function(a,b){var c=WFPUtils.overrideUrls(b.url);!function(a){$.ajax({url:WFPUtils.shareThisConfig().url,data:{cb:"WFPUtils.stCallBack",url:c,pubKey:WFPUtils.shareThisConfig().apiKey},type:"GET",crossDomain:!0,dataType:"jsonp",complete:function(){var c=news_config.stCount;b.share_count=c,$("#"+a.unique_id).find(".article_"+b.id+" .shareCount").html(c),delete news_config.stCount}})}(this)},addCommentLookup:function(a,b){var c=b.id;b.no_comments=!!b.no_comments,b.no_comments||!function(a){WFPComments.addArticleLookup(c,function(d){b.comment_count=d.commentCount,$("#"+a.unique_id).find(".article_"+c+" .commentCount").html(d.commentCount)})}(this)},attach:function(a){this.widget_node=a,$(".login",a).click(function(){WFPUser.openLogin({force_login:!1})})}},[WFPMixin.get("v4_sharethis")])}(),WFPWidget.add("v4_spotlight_bar_autos_topJobs_homes",{data:null,render:function(a){return a.v4_autos&&a.v4_autos.autos.length&&(a.auto=a.v4_autos.autos[Math.floor(Math.random()*a.v4_autos.autos.length)]),a.v4_top_jobs&&a.v4_top_jobs.top_jobs.length&&(a.top_jobs=a.v4_top_jobs.top_jobs),a.v4_homes&&a.v4_homes.homes.length&&(a.home=a.v4_homes.homes[Math.floor(Math.random()*a.v4_homes.homes.length)]),this.data=a,this._super(this.data)},attach:function(a){var b=0;$(".scroll").on("click",function(){b+=100,$(".jobs_list",a).animate({scrollTop:b})})}}),WFPWidget.add("v4_spotlight_bar_bluejays",{data:null,render:function(a){return this.data=a,this._super(this.data)},attach:function(a){WFPUtils.gaEvent("SendToNews video player loaded")}}),WFPWidget.add("v4_spotlight_bar_flyers_passages_eedition",{data:null,render:function(a){return this.data=a,this._super(this.data)},handleFlyertown:function(a){!function(a){var b=$("iframe",a);$("#ws_header",b.contents()).hide()}(a)},attach:function(a){this.handleFlyertown(a);var b=0;$(".scroll").on("click",function(){b+=100,$(".obits_list",a).animate({scrollTop:b})})}}),WFPWidget.add("v4_spotlight_bar_homes_store_autos",{data:null,render:function(a){var b,c=!1,d={},e={};a.v4_autos_news.length&&(b=Math.floor(Math.random()*a.v4_autos_news.length),d=a.v4_autos_news[b]),a.v4_homes_news.length&&(b=Math.floor(Math.random()*a.v4_homes_news.length),e=a.v4_homes_news[b]),d.ogtitle=d.title,e.ogtitle=e.title,d.click_url=d.url,e.click_url=e.url,this.data=a,this.data.v4_autos_news=[d],this.data.v4_homes_news=[e];var f=[],g=a.v4_photo.photo;return g.length>1&&(b=Math.floor(Math.random()*g.length),f[0]=g[b]),this.data.v4_photo=f,($(".tile-container").hasClass("list-view")||$(".tile-container").hasClass("compact-view"))&&(c=!0),this.data.listview=c,this.data.show_hover_element=!0,this._super(this.data)},attach:function(a){this.data.listview}}),WFPWidget.add("v4_spotlight_bar_olympics",{data:null,render:function(a){return this.data=a,this._super(this.data)},attach:function(a){}}),WFPWidget.add("v4_tile_ad_autos_news",{data:null,render:function(a){var b=!1,c={};if(a.length){var d=Math.floor(Math.random()*a.length);c=a[d]}return this.data=c,this.data.ogtitle=c.title,this.data.click_url=this.data.url,this.data.unique_ad_id=WFPUtils.generateUniqueId(),($(".tile-container").hasClass("list-view")||$(".tile-container").hasClass("compact-view"))&&(b=!0),this.data.listview=b,this.data.show_hover_element=!0,this._super(this.data)},attach:function(a){var b=this.data.unique_ad_id,c=this.data.listview;WFPUtils.setupGoogleAd(c,b,".big-box-ad-top")}}),WFPWidget.add("v4_tile_ad_filler_news",{data:null,render:function(a){var b=!1,c={};if(a.length){var d=Math.floor(Math.random()*a.length);c=a[d]}return this.data=c,this.data.ogtitle=c.title,this.data.click_url=this.data.url,this.data.unique_ad_id=WFPUtils.generateUniqueId(),($(".tile-container").hasClass("list-view")||$(".tile-container").hasClass("compact-view"))&&(b=!0),this.data.listview=b,this.data.show_hover_element=!0,this.data.publish_date="",this._super(this.data)},attach:function(a){var b=this.data.unique_ad_id,c=this.data.listview;WFPUtils.setupGoogleAd(c,b,".big-box-ad-top")}}),WFPWidget.add("v4_tile_ad_homes_news",{data:null,render:function(a){var b=!1,c={};if(a.length){var d=Math.floor(Math.random()*a.length);c=a[d]}return this.data=c,this.data.ogtitle=c.title,this.data.click_url=this.data.url,this.data.unique_ad_id=WFPUtils.generateUniqueId(),($(".tile-container").hasClass("list-view")||$(".tile-container").hasClass("compact-view"))&&(b=!0),this.data.listview=b,this.data.show_hover_element=!0,this._super(this.data)},attach:function(a){var b=this.data.unique_ad_id,c=this.data.listview;WFPUtils.setupGoogleAd(c,b,".big-box-ad-top");
}}),function(){WFPWidget.add("v4_tile_article_image",{data:null,render:function(a){var b,c=[];return this.data=a,b=a.image_info,c=WFPUtils.getImageStyle(b),this.data.image_style=c.join(" "),this._super(this.data)},attach:function(a){}})}(),function(){WFPWidget.add("v4_tile_article_list",{data:null,render:function(a){var b,c=[];if(this.data=a,a.items.length>1){var d;for(d=0;d<a.items.length;d++)b=a.items[d].image_info,c=WFPUtils.getImageStyle(b),this.data.items[d].image_style=c.join(" ")}return this._super(this.data)},attach:function(a){}})}(),WFPWidget.add("v4_tile_brightcove",{data:null,render:function(a){return this.data=a,this._super(a)},attach:function(a){}}),function(){WFPWidget.add("v4_tile_doubletop",{data:null,render:function(a){var b,c=[];return this.data=a,a.image_info&&(b=a.image_info,c=WFPUtils.getImageStyle(b),this.data.image_style=c.join(" ")),a.related_items&&a.related_items.length?this.data.related_items_found=!0:this.data.related_items_found=!1,this._super(this.data)},attach:function(a){}})}(),function(){WFPWidget.add("v4_tile_doublewide",{data:null,render:function(a){if(this.data=a,this.data.sticky_caption=!1,this.data.show_hover_element=!1,this.data.tall_image=!1,a.image_info){var b=a.image_info,c=WFPUtils.getImageStyle(b);this.data.image_style=c.join(" "),"portrait_tall"==a.image_info.image_type&&(this.data.tall_image=!0)}return this._super(this.data)}})}(),WFPWidget.add("v4_tile_double_adsports",{data:null,render:function(a){this.data=a,this.data.unique_ad_id=WFPUtils.generateUniqueId();var b=!1;return($(".tile-container").hasClass("list-view")||$(".tile-container").hasClass("compact-view"))&&(b=!0),this.data.listview=b,this._super(this.data)},attach:function(a){var b=this.data.unique_ad_id,c=this.data.listview;WFPUtils.setupGoogleAd(c,b,".big-box-ad-top",".v4_tile_double_adsports")}}),WFPWidget.add("v4_tile_double_adweather",{data:null,render:function(a){this.data=a,this.data.unique_ad_id=WFPUtils.generateUniqueId();var b=!1;return($(".tile-container").hasClass("list-view")||$(".tile-container").hasClass("compact-view"))&&(b=!0),this.data.listview=b,this._super(this.data)},attach:function(a){var b=this.data.unique_ad_id,c=this.data.listview;WFPUtils.setupGoogleAd(c,b,".big-box-ad-top",".v4_tile_double_adweather")}}),WFPWidget.add("v4_tile_double_musicevent",{data:null,render:function(a){return this.data=a,this._super(a)},handleMusicEvents:function(a){!function(a){function b(b){b&&("prev"==b?d--:"next"==b&&d++),d+1>c?d=0:d<0&&(d=c-1),$("li",a).hide(),$("li",a).eq(d).show(),startPage=d+1,endPage=startPage+3,endPage>c&&(endPage=c)}var c=$("li",a).length,d=Math.floor(Math.random()*c);$("li",a).eq(d).show(),$(".event-left",a).click(function(){b("prev")}),$(".event-right",a).click(function(){b("next")})}(a)},attach:function(a){this.handleMusicEvents(a)}}),WFPWidget.add("v4_tile_double_poll_vertical",{data:null,render:function(a){a.v4_poll.hasOwnProperty("answers")&&a.v4_poll.answers.length>10?a.disable_small_widget=!0:a.disable_small_widget=!1,a.v4_poll.answers_array=[];var b=1;for(var c in a.v4_poll.answers)a.v4_poll.answers_array.push({key:b,value:a.v4_poll.answers[c].answer}),b++;return a.v4_autos&&a.v4_autos.autos.length&&(a.auto=a.v4_autos.autos[Math.floor(Math.random()*a.v4_autos.autos.length)]),this.data=a,this._super(a)},attach:function(a){}}),WFPWidget.add("v4_tile_double_reuters",{data:null,render:function(a){return this.data=a,this._super(this.data)},handleReutersTV:function(a){!function(a){var b=setInterval(function(){"undefined"!=typeof reutersTV&&(new reutersTV({adTag:"http://pubads.g.doubleclick.net/gampad/ads?sz=320x240&iu=/3081/ccn_wfp.com/brightcove&impl=s&gdfp_req=1&env=vp&output=xml_vast2&unviewed_position_start=1",fontElClass:"",playerClass:"player",publisherId:"winnipegfreepress.com"}),clearInterval(b))},250)}(a)},attach:function(a){this.handleReutersTV(a)}}),WFPWidget.add("v4_tile_ebooks",{data:null,first_run:!0,render:function(a){return this.data=a||{},this._super(this.data)},attach:function(a){this.widget_node=a;var b,c,d=$.get(user_config.sso_url+"/store/books");$.when(d).done(function(a){a.forEach(function(a,d){0===d?(b=WFPUtils.buildElement("li"),c=WFPUtils.buildElement("img",{src:a.main_image?a.main_image.preview:"",alt:a.name})):(b=WFPUtils.buildElement("li"),c=WFPUtils.buildElement("img",{src:a.main_image?a.main_image.thumb:"",alt:a.name}));var e=WFPUtils.buildElement("a",{href:a.bookstore_url,class:"button",onclick:"ga('send', 'event', 'insiders-click', 'download-ebook', 'element.name');",target:"_blank"});$(e).text(a.name),$(b).append(e),"undefined"!=typeof a.main_image?$(b).append(c):$(b).append('<img src="" alt="">'),$(".ebook-list").append(b)})})}}),WFPWidget.add("v4_tile_events_contests",{data:null,render:function(a){return a.v4_events&&a.v4_events.events.length&&(a.events=a.v4_events.events),a.date=a.v4_events.date,a.v4_contests&&a.v4_contests.contests.length&&(a.contest=a.v4_contests.contests[Math.floor(Math.random()*a.v4_contests.contests.length)]),this.data=a,this._super(a)},handleEvents:function(a){!function(a){function b(b){b&&("prev"==b?d--:"next"==b&&d++),d+1>c?d=0:d<0&&(d=c-1),$("li",a).hide(),$("li",a).eq(d).show(),e=d+1,f=e+3,f>c&&(f=c)}var c=$("li",a).length,d=Math.floor(Math.random()*c);$("li",a).eq(d).show();var e,f;$(".event-left",a).click(function(){b("prev")}),$(".event-right",a).click(function(){b("next")})}(a)},attach:function(a){this.handleEvents(a)}}),WFPWidget.add("v4_tile_video_photo",{data:null,render:function(a){var b,c,d=a.video,e=!1,f={};d.length&&(b=Math.floor(Math.random()*d.length),f.video=d[b],f.cost=d[b].cost,f.id=d[b].id,f.publish_date=d[b].publish_date,f.url=d[b].url);var g=[],h=a.photo;if(h.length>1){for(b=Math.floor(Math.random()*h.length),c=Math.floor(Math.random()*h.length);b==c;)c=Math.floor(Math.random()*h.length);g[0]=h[b],g[1]=h[c]}return f.photo=g,($(".tile-container").hasClass("list-view")||$(".tile-container").hasClass("compact-view"))&&(e=!0),f.listview=e,this.data=f,this._super(this.data)},attach:function(a){this.data.listview}}),WFPWidget.add("v4_tile_exclusive_events",{data:null,render:function(a){return this.data=a||{},this.data.logged_in=WFPUser.isLoggedIn(),this._super(this.data)},attach:function(a){this.widget_node=a,$("a.prev",a).click(function(){$(this).siblings("ul").children().first().appendTo($(this).siblings("ul"))}),$("a.next",a).click(function(){$(this).siblings("ul").children().last().prependTo($(this).siblings("ul"))}),$(".insider-events li",a).each(function(){if($(this).children(".date").length>1){var a=1,b=$(this).children(".date").length,c=$(this);c.children(".date").hide(),c.children(".date").eq(0).slideDown(),setInterval(function(){c.children(".date").fadeOut(),c.children(".date").eq(a).slideDown(),a=(a+1)%b},2e3)}})}}),function(){WFPWidget.add("v4_tile_featured_photo",{data:null,render:function(a){return this.data=a,this.data.sticky_caption=!0,this._super(this.data)}})}(),WFPWidget.add("v4_tile_federal_election_candidates",{data:null,unique_id:!1,first_run:!1,candidates_by_id:{},local_key:"election_candidates_2_",postinit:function(){for(var a=!1;!a;){var b=Math.floor(9996777213*Math.random()),c="v4_tile_federal_election_candidates_"+b;document.getElementById(c)||(this.unique_id=c,a=!0)}},render:function(a){if(this.data=a,this.data.unique_id=this.unique_id,this.data.candidates){this.arrayShuffle(this.data.candidates);for(var b in this.data.candidates)this.candidates_by_id[this.data.candidates[b].user_id]=this.data.candidates[b]}else this.fetchCandidateInfo.call(this);return this._super(this.data)},attach:function(a){var b=this.candidates_by_id;$("a",a).each(function(){$(this).attr("data-id")&&b[$(this).attr("data-id")]&&!function(a,b){$(b).click(function(){var b=!0;WFPModal.open(b).done(function(b){WFPWidget.display("v4_modal_federal_election_candidate_profile",a,function(a){return $(b).append(a),b})})})}(b[$(this).attr("data-id")],this)}),WFPUtils.gaEvent("Candidates Displayed",window.location.href),this.widget_node=a},fetchCandidateInfo:function(){!function(a){var b=a.data.ajax_url+a.data.key;if(WFPUser.getUser(a.local_key+a.data.key))a.data.candidates=WFPUser.getUser(a.local_key+a.data.key),a.reRender.call(a);else{var c={},d=$.ajax({url:b,data:c,dataType:"jsonp",cache:!1,method:"GET"});$.when(d).done(function(b){WFPUser.setUser(a.local_key+a.data.key,b,1/288),a.data.candidates=b,a.reRender.call(a)})}}(this)},reRender:function(){var a;return this.data.candidates&&(a=$(this.render(this.data)),this.first_run?($(this.widget_node).replaceWith(a),this.first_run=!1):(this.widget_node=document.getElementById(this.unique_id),$(this.widget_node).replaceWith(a)),this.widget_node=document.getElementById(this.unique_id),this.attach(this.widget_node)),a},arrayShuffle:function(a){for(var b=a.length-1;b>0;b--){var c=Math.floor(Math.random()*(b+1)),d=a[b];a[b]=a[c],a[c]=d}return a}}),WFPWidget.add("v4_tile_federal_election_quiz",{data:null,data_key:"election_quiz",render:function(a){return this.data=a,this._super(this.data)},attach:function(a){this.widget_node=a;var b=this.data.ajax_url,c=this;$("a",a).each(function(){"quiz"==$(this).attr("data-id")&&!function(a,b){$(a).click(function(){$(a).attr("data-default-open",$(a).html()),$(a).html("Loading..."),c.fetchAndOpenModal(b)})}(this,b)}),window.location.hash&&"#openquiz"==window.location.hash&&($("a",a).each(function(){"quiz"==$(this).attr("data-id")&&($(this).attr("data-default-open",$(this).html()),$(this).html("Loading..."))}),c.fetchAndOpenModal(b)),WFPUtils.gaEvent("Election Quiz Displayed",window.location.href)},fetchAndOpenModal:function(a){var b=this;if(b.data.quiz_data)b.openQuizModal(b.data.quiz_data);else if(WFPUser.getUser(b.data_key))b.openQuizModal(WFPUser.getUser(b.data_key));else{var c={},d=$.ajax({url:a,data:c,dataType:"jsonp",cache:!1,method:"GET"});$.when(d).done(function(a){WFPUser.setUser(b.data_key,a,7),b.openQuizModal(a)})}},openQuizModal:function(a){var b=!0;WFPModal.open(b).done(function(b){WFPWidget.display("v4_modal_federal_election_quiz",a,function(a){return $(b).append(a),b})})}}),WFPWidget.add("v4_tile_feedback",{maindata:null,render:function(a){return this.data=a,this._super(this.data)},attach:function(a){function b(b){$(".V4-error",a).hide(),$(".V4-confirm",a).show(),i(),setTimeout(function(){$(".V4-confirm",a).hide()},3e3)}function c(){$(".V4-error",a).hide(),$(".V4-confirm",a).hide(),e()}function d(a){var b={},c={};for(var d in a){var e=a[d];c[e.name]=e.value}if(c.email.length&&c.name.length&&c.feedback.length){var f=/^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/;return!f.test(c.email)&&(b.email="Please enter a valid e-mail address",b)}return c.email||(b.email="Please enter your e-mail address"),c.name||(b.name="Please enter your name"),c.feedback||(b.feedback="Please provide some feedback"),b}function e(){$("input, select, textarea",a).each(function(){$(this),""===$(this).val()?$(this).parent().removeClass("floater"):$(this).parent().addClass("floater"),$(this).unbind()}).blur(function(){var a=$(this);""===$(this).val()?$(this).parent().removeClass("floater"):($(this).parent().addClass("floater"),f(a))}).focus(function(){$(this).parent().addClass("floater")})}function f(b){var c=$(b).attr("name");$(".error-"+c,a).hide()}function g(b){$(".error_message",a).hide();for(var c in b)h(c,b[c])}function h(b,c){if($(".error-"+b,a).length){var d=$(".error-"+b).get(0);c&&$(d).html(c),$(d).css("display","block")}}function i(){$(".v4_tile_feedback .V4-input-wrap input").val(""),$(".v4_tile_feedback .V4-input-wrap textarea").val("")}c(),$(".submit",a).click(function(){var c="/templates/V4_MPP_Manage_User?action=feedback",e=$(".form_feedback",a).serializeArray(),f=d(e);f?g(f):$.ajax({type:"POST",url:c,data:e,dataType:"json",success:function(a){b(a)},error:function(a,b){console.log(a)}})})}}),WFPWidget.add("v4_tile_flyertown",{data:null,render:function(a){return this.data=a,this._super(this.data)},handleFlyertown:function(a){!function(a){var b=$("iframe",a);$("#ws_header",b.contents()).hide()}(a)},attach:function(a){this.handleFlyertown(a)}}),WFPWidget.add("v4_tile_flyertravel",{data:null,render:function(a){return this.data=a,this._super(a)},attach:function(a){var b,c=this.data;for(b=0;b<c.length;b++){var d=WFPUtils.buildElement("li",{class:"tile-list-small"}),e=WFPUtils.buildElement("h4",{class:"title"}),f=WFPUtils.buildElement("p",{class:"validDate"}),g=WFPUtils.buildElement("p",{class:"pdf"});e.innerHTML="<a href='"+c[b].pdf+"' target='_blank'>"+c[b].title+"</a>",f.innerHTML="<span>"+c[b].startDate+"</span>"+(c[b].endDate?" to <span>"+c[b].endDate+"</span>":""),g.innerHTML="<a href='"+c[b].pdf+"' target='_blank'>Download</a>",d.appendChild(e),d.appendChild(f),d.appendChild(g),$(".travel_flyers",a).append(d)}}}),WFPWidget.add("v4_tile_fringe_reviews",{data:null,render:function(a){return a.genre=["Cabaret","Clown","Dance","Improv","Magic","Musical","Physical Theatre","Play-Comedy","Play-Drama","Play-Dramedy","Puppetry","Sketch","Spoken Word","Stand-up","Storytelling","Unclassifiable"],a.letter=[{id:1,title:"Numbers"},{id:2,title:"A to B"},{id:3,title:"C to D"},{id:4,title:"E to H"},{id:5,title:"I to L"},{id:6,title:"M to O"},{id:7,title:"P to R"},{id:8,title:"S to T"},{id:9,title:"U to Z"},{id:12,title:"Sort all descending"},{id:13,title:"Sort all ascending"}],a.stars=[{id:1,title:"1"},{id:2,title:"2"},{id:3,title:"3"},{id:4,title:"4"},{id:5,title:"5"},{id:6,title:"Sort from 5 to 1"},{id:7,title:"Sort from 1 to 5"}],this._super(a)},attach:function(a){}}),function(){WFPWidget.add("v4_tile_fulltop",{data:null,render:function(a){return this.data=a,a.related_items&&a.related_items.length?this.data.related_items_found=!0:this.data.related_items_found=!1,this._super(this.data)},attach:function(a){}},[WFPMixin.get("v4_date"),WFPMixin.get("v4_comments"),WFPMixin.get("v4_sharethis")])}(),function(){WFPWidget.add("v4_tile_fulltop_alt",{data:null,render:function(a){return this.data=a,a.related_items&&a.related_items.length?this.data.related_items_found=!0:this.data.related_items_found=!1,this._super(this.data)},attach:function(a){}},[WFPMixin.get("v4_date"),WFPMixin.get("v4_comments"),WFPMixin.get("v4_sharethis")])}(),function(){WFPWidget.add("v4_tile_fulltop_spotlight",{data:null,render:function(a){a.image_info=WFPUtils.determinePhotoType(a.image_dimensions);var b,c=[];return this.data=a,a.related_items&&a.related_items.length?(this.data.related_items_found=!0,b=a.image_info,c=WFPUtils.getImageStyle(b),this.data.image_style=c.join(" ")):this.data.related_items_found=!1,this._super(this.data)},attach:function(a){}},[WFPMixin.get("v4_date"),WFPMixin.get("v4_comments")])}(),WFPWidget.add("v4_tile_highschool_results",{data:null,render:function(a){return this.data=a,this._super(a)},attach:function(a){var b="";for(var c in this.data)if("seeall"!==c){var d=WFPUtils.buildElement("div",{class:"rsContent",style:"color:black; overflow-y:scroll"}),e=WFPUtils.buildElement("h5");e.innerHTML=c;var f=WFPUtils.buildElement("div",{class:"container"});if(this.data.hasOwnProperty(c)){var g=this.data[c];for(i=0;i<g.length;i++){var h=WFPUtils.buildElement("ul",{class:"tile-list-small"}),j=WFPUtils.buildElement("li",{class:"homeSchool"}),k=WFPUtils.buildElement("li",{class:"visitingSchool"}),l=WFPUtils.buildElement("li",{class:"league"}),m=WFPUtils.buildElement("li",{class:"startDate"});j.innerHTML=g[i].homeSchool+" "+g[i].homeTeam+"<span>"+g[i].homeScore+"</span>",k.innerHTML=g[i].visitingSchool+" "+g[i].visitingTeam+"<span>"+g[i].visitingScore+"</span>",l.innerHTML=g[i].league+" "+g[i].gender,g[i].active||(l.innerHTML="Final - "+l.innerHTML),m.innerHTML=g[i].startDate+" "+g[i].venue+" at "+g[i].startTime,h.appendChild(j),h.appendChild(k),h.appendChild(l),h.appendChild(m),f.appendChild(h)}}d.appendChild(e),d.appendChild(f),$("#mhsaa-results").append(d)}else b="http://www.mhsaa.ca/schedule/date-"+this.data[c];$(".mhsaa_seeall",a).attr("href",b),$("#mhsaa-results").royalSlider({arrowsNav:!1})}}),WFPWidget.add("v4_tile_highschool_schedule",{data:null,render:function(a){return this.data=a,this._super(a)},attach:function(a){var b="";for(var c in this.data)if("seeall"!==c){var d=WFPUtils.buildElement("div",{class:"rsContent",style:"color:black; overflow-y:scroll"}),e=WFPUtils.buildElement("h5");e.innerHTML=c;var f=WFPUtils.buildElement("div",{class:"container"});if(this.data.hasOwnProperty(c)){var g=this.data[c];for(i=0;i<g.length;i++){var h=WFPUtils.buildElement("ul",{class:"tile-list-small"}),j=WFPUtils.buildElement("li",{class:"homeSchool"}),k=WFPUtils.buildElement("li",{class:"visitingSchool"}),l=WFPUtils.buildElement("li",{class:"league"}),m=WFPUtils.buildElement("li",{class:"startDate"});j.innerHTML=g[i].homeSchool+" "+g[i].homeTeam,k.innerHTML=g[i].visitingSchool+" "+g[i].visitingTeam,l.innerHTML=g[i].league+" "+g[i].gender,m.innerHTML=g[i].startDate+" "+g[i].venue+" at "+g[i].startTime,h.appendChild(j),h.appendChild(k),h.appendChild(l),h.appendChild(m),f.appendChild(h)}}d.appendChild(e),d.appendChild(f),$("#mhsaa-schedule").append(d)}else b="http://www.mhsaa.ca/schedule/date-"+this.data[c];$(".mhsaa_seeall",a).attr("href",b),$("#mhsaa-schedule").royalSlider({arrowsNav:!1})}}),WFPWidget.add("v4_tile_homes_top_jobs",{data:null,render:function(a){return a.v4_top_jobs&&a.v4_top_jobs.top_jobs.length&&(a.top_jobs=a.v4_top_jobs.top_jobs),a.v4_homes&&a.v4_homes.homes.length&&(a.home=a.v4_homes.homes[Math.floor(Math.random()*a.v4_homes.homes.length)]),this.data=a,this._super(a)},handleTopJobs:function(a){!function(a){function b(b){b&&("prev"==b?c--:"next"==b&&c++),c+1>d?c=d-1:c<0?c=0:($(".sub-listing ul",a).hide(),$(".sub-listing ul",a).eq(c).show(),startPage=4*c+1,endPage=startPage+3,endPage>e&&(endPage=e),$(".top-jobs-pagination",a).html(startPage+" - "+endPage+" of "+e))}$(".tile-list-small:first",a).show();var c=0,d=$(".sub-listing ul",a).length,e=$(".sub-listing li",a).length;$(".top-jobs-pagination",a).html("1 - 4 of "+e),$(".previous",a).click(function(){b("prev")}),$(".next",a).click(function(){b("next")})}(a)},attach:function(a){this.handleTopJobs(a)}}),function(){WFPWidget.add("v4_tile_iframe",{data:null,render:function(a){this.data=a;var b=1;this.data.hasOwnProperty("size")&&this.data.size>1&&(b=this.data.size);var c="iframe-two-col";switch(b){case 1:c="iframe-two-col";break;case 2:c="iframe-four-col";break;case 3:c="iframe-six-col"}return this.data.css_class=c,this._super(this.data)}})}(),WFPWidget.add("v4_tile_insider_message",{data:null,render:function(a){return this.data=a||{},this._super(this.data)}}),WFPWidget.add("v4_tile_member_activities",{data:null,first_run:!0,render:function(a){return this.data=a||{},this._super(this.data)},attach:function(a){this.widget_node=a;var b=WFPUser.requestMemberInfo();$.when(b).done(function(a){$(".activity .articleCount").text(a.v4_article_count),$(".activity .emailCount").text(a.email_prefs_count);for(var b=7,c=0;c<a.email_prefs_count&&c!==b;c++){var d=WFPUtils.buildElement("img",{src:"http://media.winnipegfreepress.com/binary/membership_newsletters_white.svg"});$(".activity .act-newsletters .news_images").append(d)}$(".activity .bookCount").text(a.book_download?a.book_download.length:"")}),b=WFPComments.getUser(),$.when(b).done(function(a){var b=a[0].User;b.AvatarPhotoUrl.indexOf("/static/images/no-user-image.gif")>-1?$(".activity .act-user").html("<p>"+b.DisplayName+' <br/><a class="type-persona" href="http://www.winnipegfreepress.com/community/persona.html?userId='+b.MixedUserKey+"&amp;plckUserId="+b.MixedUserKey+"&plckPersonaPage=PersonaProfile\" onclick=\"ga('send', 'event', 'insiders-click', 'upload-avatar', 'Upload Avatar');\">Upload an Avatar</a></p>"):$(".activity .act-user").html('<img src="'+b.AvatarPhotoUrl+'" alt="'+b.DisplayName+' Avatar"><span>'+b.DisplayName+"</span>"),$(".activity .commentCount").html(b.NumberOfComments),$(".activity .comment-link").html('<a class="link" href="http://www.winnipegfreepress.com/community/persona.html?userId='+b.MixedUserKey+"&amp;plckUserId="+b.MixedUserKey+"&plckPersonaPage=PersonaComments\" onclick=\"ga('send', 'event', 'insiders-click', 'view-comments', 'View Comment Profile');\">[ View my Comments Profile ]</a>")})}}),WFPWidget.add("v4_tile_my_news",{data:{},element:null,first_run:!0,unique_id:!1,max_articles:6,postinit:function(){for(var a=!1;!a;){var b=Math.floor(9996777213*Math.random()),c="my_news_"+b;document.getElementById(c)||(this.unique_id=c,a=!0)}},render:function(a){var b,c,d,e,f,g,h,i=0,j=0;if(this.data=a||{},this.data.unique_id=this.unique_id,a.logged_in=WFPUser.isLoggedIn(),this.data.read_articles){if(this.data.read_articles||this.data.saved_articles){this.data.read_articles.length+this.data.saved_articles.length>this.max_articles?0===this.data.read_articles.length?j=this.max_articles<this.data.saved_articles.length?this.max_articles:this.data.saved_articles.length:0===this.data.saved_articles.length?i=this.max_articles<this.data.read_articles.length?this.max_articles:this.data.read_articles.length:(j=this.data.saved_articles.length<Math.ceil(this.max_articles/2)?this.data.saved_articles.length:Math.ceil(this.max_articles/2),i=this.max_articles-j):(i=this.data.read_articles.length,j=this.data.saved_articles.length),c={read_articles:i,saved_articles:j},h=0;for(g in c){for(b=[],d=c[g],f=0;f<d;f++)e=this.data[g][f],e.update_time=WFPUtils.formatDate(e.updated_time),e.click_url=WFPUtils.overrideUrls(e.url),b.push(e),e.updated_since_read&&h++;this.data[g]=b}this.data.updated_count=h}}else this.handleArticles.call(this);return this._super(this.data)},handleArticles:function(){!function(a){$.when(WFPMyNews.getUserArticles()).done(function(b){a.data.read_articles=[],a.data.saved_articles=[],a.reRender(b,a),function(a){WFPMyNews.updateArticles(function(b){a.reRender(b,a)})}(a)})}(this)},reRender:function(a,b){var c;return a&&(c=$(this.render(a)),this.first_run?($(b.widget_node).replaceWith(c),this.first_run=!1):(b.widget_node=document.getElementById(b.unique_id),$(b.widget_node).replaceWith(c))),c},attach:function(a){this.widget_node=a,$(".click-login",a).click(function(){WFPUser.openLogin({force_login:!1})}),$(".click-register",a).click(function(){WFPUser.openRegister({force_login:!1})})}}),function(){WFPWidget.add("v4_tile_passages",{data:null,render:function(a){this.data=a;var b=!1;return this.data.hasOwnProperty("children")&&this.data.children.length<7?(this.data.display_ad_widget=!0,this.data.unique_ad_id=WFPUtils.generateUniqueId(),($(".tile-container").hasClass("list-view")||$(".tile-container").hasClass("compact-view"))&&(b=!0),this.data.listview=b):this.data.display_ad_widget=!1,this._super(this.data)},attach:function(a){if(this.data.display_ad_widget){var b=this.data.unique_ad_id,c=this.data.listview;WFPUtils.setupGoogleAd(c,b,".big-box-ad-top",void 0,"subsections")}}})}(),WFPWidget.add("v4_tile_perks_discounts",{data:null,render:function(a){this.data=a||{};var b=[];for(var c in a)b[c]=a[c];return this.data.item=b,this.data.logged_in=WFPUser.isLoggedIn(),this._super(this.data)},attach:function(a){this.widget_node=a,$("a.prev",a).click(function(){$(this).siblings("ul").children().first().appendTo($(this).siblings("ul"))}),$("a.next",a).click(function(){$(this).siblings("ul").children().last().prependTo($(this).siblings("ul"))})}}),WFPWidget.add("v4_tile_photo",{data:null,render:function(a){var b=!1,c={},d=[],e=a.photo;if(e.length>1){for(var f=Math.floor(Math.random()*e.length),g=Math.floor(Math.random()*e.length);f==g;)g=Math.floor(Math.random()*e.length);for(var h=Math.floor(Math.random()*e.length);f==h||g==h;)h=Math.floor(Math.random()*e.length);d[0]=e[f],d[1]=e[g],d[2]=e[h]}return c.photo=d,($(".tile-container").hasClass("list-view")||$(".tile-container").hasClass("compact-view"))&&(b=!0),c.listview=b,this.data=c,this._super(this.data)},attach:function(a){this.data.listview}}),WFPWidget.add("v4_tile_photo_video",{data:null,render:function(a){var b,c,d=a.video,e=!1,f={},g=[];if(d.length>1){for(b=Math.floor(Math.random()*d.length),c=Math.floor(Math.random()*d.length);b==c;)c=Math.floor(Math.random()*d.length);g[0]=d[b],g[1]=d[c],f.video=g}var h=a.photo;return h.length&&(b=Math.floor(Math.random()*h.length)),f.photo=h[b],($(".tile-container").hasClass("list-view")||$(".tile-container").hasClass("compact-view"))&&(e=!0),f.listview=e,this.data=f,this._super(this.data)},attach:function(a){this.data.listview}}),WFPWidget.add("v4_tile_poll",{data:null,render:function(a){return this.data=a,this._super(this.data)},handleLinks:function(a){!function(a){$("#hide-results",a).click(function(b){b.preventDefault(),$(".results",a).hide(),$(".question",a).show()}),$("#view-results",a).click(function(b){b.preventDefault(),$(".question",a).hide(),$(".results",a).show()});var b="poll-"+$("input[name='pid']").attr("value");"voted"==cookiejar.fetch(b)&&($(".question",a).hide(),$(".results",a).show())}(a)},attach:function(a){this.handleLinks(a)}}),WFPWidget.add("v4_tile_provincial_election_candidate",{data:null,render:function(a){return a.url||(a.url="http://www.winnipegfreepress.com/special/provincial-election/?"),a.party=a.name,a.riding_url=a.url+"division="+a.riding_key,a.candidate_url=a.riding_url+"&candidate="+a.user_id,this.data=a,this._super(this.data)},attach:function(a){this.widget_node=a}}),WFPWidget.add("v4_tile_provincial_election_division",{data:null,render:function(a){return this.data=a,this.data.path="http://www.winnipegfreepress.com/special/provincial-election/?division="+a.key,this.data.section=a.name,this.arrayShuffle(this.data.candidates),this._super(this.data)},attach:function(a){this.widget_node=a},arrayShuffle:function(a){for(var b=a.length-1;b>0;b--){var c=Math.floor(Math.random()*(b+1)),d=a[b];a[b]=a[c],a[c]=d}return a}}),WFPWidget.add("v4_tile_provincial_election_divisions",{data:null,unique_id:!1,render:function(a){return a.url||(a.url="http://www.winnipegfreepress.com/special/provincial-election/?"),this.data=a,this._super(this.data)},attach:function(a){!function(b){$("select.mb-election-divisions",a).change(function(){var a=$("option:selected",this).val();a&&(b=b+"division="+a,window.location=b)})}(this.data.url)}}),WFPWidget.add("v4_tile_video_photo",{data:null,render:function(a){var b,c,d=a.video,e=!1,f={};d.length&&(b=Math.floor(Math.random()*d.length),f.video=d[b],f.cost=d[b].cost,f.id=d[b].id,f.publish_date=d[b].publish_date,f.url=d[b].url);var g=[],h=a.photo;if(h.length>1){for(b=Math.floor(Math.random()*h.length),c=Math.floor(Math.random()*h.length);b==c;)c=Math.floor(Math.random()*h.length);g[0]=h[b],g[1]=h[c]}return f.photo=g,($(".tile-container").hasClass("list-view")||$(".tile-container").hasClass("compact-view"))&&(e=!0),f.listview=e,this.data=f,this._super(this.data)},attach:function(a){this.data.listview}}),WFPWidget.add("v4_tile_publications_ad",{data:null,render:function(a){var b,c,d=a.publications,e=!1,f={},g=[];if(d.length>1){for(b=Math.floor(Math.random()*d.length),c=Math.floor(Math.random()*d.length);b==c;)c=Math.floor(Math.random()*d.length);g[0]=d[b],g[1]=d[c],f.publications=g}return f.unique_ad_id=WFPUtils.generateUniqueId(),($(".tile-container").hasClass("list-view")||$(".tile-container").hasClass("compact-view"))&&(e=!0),f.listview=e,this.data=f,this._super(this.data)},attach:function(a){var b=this.data.listview,c=this.data.unique_ad_id;WFPUtils.setupGoogleAd(b,c,".big-box-ad-top")}}),WFPWidget.add("v4_tile_spillbox",{data:null,render:function(a){var b=0;for(var c in a.sections){for(var d in a.sections[c].articles){$.extend(a.sections[c].articles[d],WFPNewsHandler.convertNewsDataForSite(a.sections[c].articles[d])),a.sections[c].articles[d].image_info=WFPUtils.determinePhotoType(a.sections[c].articles[d].image_dimensions);var e,f=[];e=a.sections[c].articles[d].image_info,f=WFPUtils.getImageStyle(e),a.sections[c].articles[d].image_style=f.join(" ")}b++}return b=b>1?[1]:[],a.section_count=b,this._super(a)},handleTabs:function(a){!function(a){$(".spill-list",a).hide(),$(".spill-sections ul:first-child",a).show(),$(".spill-tabs li:first-child a",a).addClass("active"),$(".spill-tabs li a",a).click(function(b){b.preventDefault();var c=$(this).attr("rel");ga("send","event","Spillbox",$(this).text()),$(".spill-tabs li a",a).each(function(a){$(this).attr("rel")==c&&googletag.pubads().refresh([spillboxAdSlots[a]])}),$(".spill-tabs a",a).removeClass("active"),$(".spill-list",a).hide(),$(this).addClass("active"),$("#"+c).show()})}(a)},loopThroughSections:function(a,b){var c=[];return $.each(b,function(b,d){var e=new $.Deferred,f=d.id+"ad";0===b?!function(c){$.when(WFPUtils.setupSpillboxAd(b,"yes",a,f,".spillbox-big-box-ad","","spillbox")).done(function(a){setTimeout(function(a){c.resolve(a)},0)})}(e):!function(c){$.when(WFPUtils.setupSpillboxAd(b,"no",a,f,".spillbox-big-box-ad","","spillbox")).done(function(a){setTimeout(function(a){c.resolve(a)},0)})}(e),c.push(e)}),$.when.apply($,c).promise()},attach:function(a){this.handleTabs(a),this.loopThroughSections(this.data.listview,this.data.sections)}}),function(){WFPWidget.add("v4_tile_spotlight_image",{data:null,render:function(a){a.image_info=WFPUtils.determinePhotoType(a.image_dimensions);var b,c=[];return this.data=a,b=a.image_info,c=WFPUtils.getImageStyle(b),this.data.image_style=c.join(" "),this._super(this.data)},attach:function(a){if(1==this.data.have_rating){for(var b=this.data.our_rating,c=Math.floor(b),d=0;d<c;d++){var e=WFPUtils.buildElement("img",{src:"http://media.winnipegfreepress.com/designimages/star.gif",alt:"star",width:"14",height:"14",class:"star"});$(".rating",a).append(e)}if(c<b){var f=WFPUtils.buildElement("img",{src:"http://media.winnipegfreepress.com/designimages/half-star.gif",alt:"half-star",width:"14",height:"14",class:"star"});$(".rating",a).append(f)}}}},[])}(),function(){WFPWidget.add("v4_tile_spotlight_no_image",{data:null,render:function(a){return this.data=a,this._super(this.data)},attach:function(a){if(1==this.data.have_rating){for(var b=this.data.our_rating,c=Math.floor(b),d=0;d<c;d++){var e=WFPUtils.buildElement("img",{src:"http://media.winnipegfreepress.com/designimages/star.gif",alt:"star",width:"14",height:"14",class:"star"});$(".rating",a).append(e)}if(c<b){var f=WFPUtils.buildElement("img",{src:"http://media.winnipegfreepress.com/designimages/half-star.gif",alt:"half-star",width:"14",height:"14",class:"star"});$(".rating",a).append(f)}}}},[])}(),function(){WFPWidget.add("v4_tile_subsections",{data:null,render:function(a){this.data=a;var b=!1;return this.data.hasOwnProperty("children")&&this.data.children.length<7?(this.data.display_ad_widget=!0,this.data.unique_ad_id=WFPUtils.generateUniqueId(),($(".tile-container").hasClass("list-view")||$(".tile-container").hasClass("compact-view"))&&(b=!0),this.data.listview=b):this.data.display_ad_widget=!1,this._super(this.data)},attach:function(a){if(this.data.display_ad_widget){var b=this.data.unique_ad_id,c=this.data.listview;WFPUtils.setupGoogleAd(c,b,".big-box-ad-top",void 0,"subsections")}}})}(),WFPWidget.add("v4_tile_video_photo",{data:null,render:function(a){var b,c,d=a.video,e=!1,f={};d.length&&(b=Math.floor(Math.random()*d.length),f.video=d[b],f.cost=d[b].cost,f.id=d[b].id,f.publish_date=d[b].publish_date,f.url=d[b].url);var g=[],h=a.photo;if(h.length>1){for(b=Math.floor(Math.random()*h.length),c=Math.floor(Math.random()*h.length);b==c;)c=Math.floor(Math.random()*h.length);g[0]=h[b],g[1]=h[c]}return f.photo=g,($(".tile-container").hasClass("list-view")||$(".tile-container").hasClass("compact-view"))&&(e=!0),f.listview=e,this.data=f,this._super(this.data)},attach:function(a){this.data.listview}}),WFPWidget.add("v4_top_most_commented",{data:{},element:null,first_run:!0,unique_id:!1,postinit:function(){for(var a=!1;!a;){var b=Math.floor(9996777213*Math.random()),c="my_news_"+b;document.getElementById(c)||(this.unique_id=c,a=!0)}},render:function(a){if(this.data=a,this.data.unique_id=this.unique_id,a.response){var b=["mcDay","mcWeek","mcMonth"];for(var c in a.response){var d=a.response[c];
if(d.ResponseStatus.StatusCode==PluckSDK.ResponseStatusCode.OK){var e=d.DiscoveredContent;a[b[c]]=[];for(var f=0;f<e.length&&f<4;f++){var g=e[f],h=g.Title.replace(" - Winnipeg Free Press",""),i=g.Url.replace("device=mobile","");i=WFPUtils.overrideUrls(i.replace(/\?cx_navSource=[-a-zA-Z0-9]*/,"")),a[b[c]].push({click_url:i,article_title:h})}}}}else this.fetchTopComments(a.pluckSection);return this._super(this.data)},fetchTopComments:function(a){this.first_run&&!function(b){$.when(WFPComments.discoverMostPop(a)).done(function(a){b.first_run=!1,b.reRender.call(b,a)})}(this)},reRender:function(a){this.data.response=a;var b=this.render(this.data);$(this.widget_node).replaceWith(b),this.widget_node=document.getElementById(this.data.unique_id)}}),WFPWidget.add("v4_top_my_news",{data:{},element:null,first_run:!0,unique_id:!1,max_articles:4,postinit:function(){for(var a=!1;!a;){var b=Math.floor(9996777213*Math.random()),c="my_news_"+b;document.getElementById(c)||(this.unique_id=c,a=!0)}},render:function(a){var b,c,d,e,f,g,h,i=0,j=0;if(this.data=a||{},this.data.unique_id=this.unique_id,a.logged_in=WFPUser.isLoggedIn(),this.data.read_articles){if(this.data.read_articles||this.data.saved_articles){i=this.max_articles<this.data.read_articles.length?this.max_articles:this.data.read_articles.length,j=this.max_articles<this.data.saved_articles.length?this.max_articles:this.data.saved_articles.length,c={read_articles:i,saved_articles:j},h=0;for(g in c){for(b=[],d=c[g],f=0;f<d;f++)e=this.data[g][f],e.update_time=WFPUtils.formatDate(e.updated_time),e.click_url=WFPUtils.overrideUrls(e.url),b.push(e),e.updated_since_read&&h++;this.data[g]=b}this.data.updated_count=h}}else this.handleArticles.call(this);return this._super(this.data)},handleArticles:function(){!function(a){$.when(WFPMyNews.getUserArticles()).done(function(b){a.data.read_articles=[],a.data.saved_articles=[],a.reRender(b,a),function(a){WFPMyNews.updateArticles(function(b){a.reRender(b,a)})}(a)})}(this)},reRender:function(a,b){var c;return a&&(c=$(this.render(a)),this.first_run?($(b.widget_node).replaceWith(c),this.first_run=!1):(b.widget_node=document.getElementById(b.unique_id),$(b.widget_node).replaceWith(c))),c},attach:function(a){this.widget_node=a,$(".login",a).click(function(){WFPUser.openLogin({force_login:!1})})}});var WFPComments=function(a,b,c){function d(){u=a.getScript(w.pluck_api_url)}function e(b){var c=a.Deferred();return a.when(u).done(function(){var d=[1,7,30],e=[];for(var f in d){var g=new PluckSDK.DiscoverContentActionRequest;g.Activity=PluckSDK.DiscoveryActivity.Commented,g.Sections=[],g.Sections.push(new PluckSDK.DiscoverySection({Name:b})),g.Type=PluckSDK.ContentType.Article,g.Age=d[f],g.MaximumNumberOfDiscoveries=10,e.push(g)}a.when(k(e)).done(function(a){c.resolve(a)})}),c.promise()}function f(b,c,d){a.when(WFPUtils.getReady()).done(function(){if(a(window).width()>489)var e="pluck/comments";else var e="mobile_comments";pluckAppProxy.embedApp(e,{plckCommentOnKeyType:"article",plckCommentOnKey:b.id,plckDiscoverySection:d},{elem:c}),pluckAppProxy.registerActivityCallback("CommentsRendered",function(){a(".comments_subscribe").show()})})}function g(a,b,c){t.push({articleId:a,commentCount:b,updateFunction:c})}function h(a,b){s.push({articleId:a,updateFunction:b})}function i(){var a;t.forEach(function(b,c){(a=b.updateFunction)(b.articleId,b.commentCount)}),q()}function j(b){var c=a.Deferred();return a.when(u).done(function(){if(s.length>0){var d=l();a.when(k(d)).then(function(a){m(a),c.resolve()},function(){1===b?(WFPUtils.log("Comments attempted and failed"),c.reject()):j(1)})}}),c.promise()}function k(b){var c=a.Deferred();return PluckSDK.SendRequests(b,function(a,b){b?c.reject():c.resolve(a)}),c.promise()}function l(){var a,b,c=[];for(a=0;a<s.length;a++)b=new PluckSDK.ArticleRequest,b.ArticleKey=new PluckSDK.ExternalResourceKey,b.ArticleKey.Key=s[a].articleId,c.push(b);return c}function m(a){var b,c,d,e,f;for(b=0;b<a.length;b++){d={commentCount:0},c=a[b],o(c)&&c.Article?(d.commentCount=c.Article.Comments.NumberOfComments,f=c.Article.ArticleKey.Key):f=c.ResponseStatus.Exceptions[0].Value;var g=n(f);g&&(e=g.updateFunction)(d)}p()}function n(a){var b;for(b=0;b<s.length;b++)if(s[b].articleId==a)return s[b];return null}function o(a){return a.ResponseStatus.StatusCode===PluckSDK.ResponseStatusCode.OK}function p(){s=[]}function q(){t=[]}function r(b,c){var d=a.Deferred();return a.when(u).done(function(){var e=new PluckSDK.UserRequest;e.UserKey=new PluckSDK.UserKey,e.UserKey.Key=b,a.when(k([e])).then(function(a){o(a[0])?d.resolve(a):WFPUtils.log("Error occurred (pluck user might not exist).")},function(){1===c?WFPUtils.log("retrieve pluckuser attempted and failed"):retrievePluckUser(b,1)})}),d.promise()}var s=[],t=[],u=a.Deferred(),v={addArticleLookup:h,addCachedCommentCount:g,retrieveComments:j,retrieveCachedComments:i,displayComments:f,discoverMostPop:e,getUser:r},w={pluck_api_url:"http://pluck.winnipegfreepress.com/ver1.0/Direct/JavascriptSDKProxy"};return a.extend(w,c),c&&!c.disable_pluck&&d(),v}(jQuery,Class,wfp_config),article_config=article_config||{pluckSection:"News"},WFPArticle=function(a,b,c,d,e,f,g){function h(a,b,d,e,h){x=a,y.x_token_id=d,y.client_probe_url=e,y.disable_pluck||q(a),z=b,g.when(WFPUtils.getReady()).done(function(){b?m(a):("Trial"==c.getUser("user_type")&&"paid"==h.url_type&&l(a),"show_page"==h.action&&f.saveArticle(a,!1)),a.no_comments||y.disable_pluck||r(a),s(a,h)})}function i(){g(".progress-bar span.filler-bar").animate({width:"100%"},{duration:y.grace_count,queue:!1,done:function(a){}})}function j(a){c.updateBalance(a.cost),g.when(f.saveArticle(a,!0)).done(function(a){a.response.response&&a.response.response.error&&"Trial account expired"==a.response.response.error&&c.deleteUser("v4_user_state")}),g(".article-amount").text("$"+(a.cost/100).toFixed(2)),g(".progress-message").fadeIn(600,function(){setTimeout(function(){g(".progress-message").fadeOut(600)},2e3)})}function k(a,b){var d={};d.client_id=c.getId(),d.article_id=a.id,d.pay_status=b,g.when(c.accessUserDB("save_mpp_payments",d)).done(function(a){}).fail(function(a){})}function l(a){g.when(f.isArticleRead(a)).done(function(b){b||(i(),function(a){setTimeout(function(){j(a)},y.grace_count)}(a))})}function m(a){i(),function(a){setTimeout(function(){g.when(c.getMicropaymentSession()).done(function(b){n(b,a)})},y.grace_count)}(a)}function n(a,b,d){var e=c.createMPPIdentity(),f={REQUEST_URI:b.id,Cookie:"MPP-SessionId="+a+";AccessToken="+e,"X-TokenId":y.x_token_id},h=g.ajax({url:y.client_probe_url,data:f,dataType:"jsonp"});!function(a,b){g.when(h).done(function(b){j(a),k(a,b.AllowAccess)}).fail(function(){k(a,"error")})}(b,d)}function o(){return x&&(z||p(x.id)>=y.max_free_articles)}function p(a){var b,d={},e=30;c.getUser("anonymous_articles")&&(d=c.getUser("anonymous_articles"),b=g.jStorage.getTTL("anonymous_articles")),d[a]=1,c.setUser("anonymous_articles",d),b?g.jStorage.setTTL("anonymous_articles",b):g.jStorage.setTTL("anonymous_articles",24*e*60*60*1e3);var f=Object.keys(d).length;return f}function q(a){WFPComments.addArticleLookup(a.id,function(a){g(y.comment_count_class).html("Comments: "+a.commentCount);var b;b=0==a.commentCount?"Be the first to comment":1==a.commentCount?"Display 1 comment":"Display "+a.commentCount+" comments",g(y.display_comments_selector).html(b)})}function r(a){if(g("#"+y.comment_button).length){var b=window.location.href,c=b.split("#",1),d=c[0].split("?",1),e=d[0];g("#"+y.comment_button+" button").click(function(){g("#"+y.comment_button).hide(),WFPComments.displayComments(a,y.comment_container,y.pluckSection),"Be the first to comment"==this.innerHTML?_gaq&&_gaq.push(["_trackEvent","CommentsZero",pluckSection,e]):_gaq&&_gaq.push(["_trackEvent","Comments",pluckSection,e])})}}function s(a,b){switch(c.getUser("user_type")){case"PayAsYouGo":case"SATURDAY":u(a,b)}t()}function t(){g(".report").click(function(a){a.preventDefault(),g(this).closest("ul").hasClass("show")&&g(this).closest("ul").removeClass("show").hide(),WFPModal.open().done(function(a){d.display("v4_modal_report_error",{},function(b){return g(a).append(b),a})})})}function u(a,b){v(a,b.previous_purchase)}function v(a,b){if(!b||!b.over_refundable_minutes){g(".refund").click(function(b){b.preventDefault(),g(this).hasClass("inactive")||WFPModal.open().done(function(b){d.display("v4_modal_refund_box",a,function(a){return g(b).append(a),b})})}),setTimeout(function(){g(".refund").removeClass("inactive")},y.grace_count);var c=60*y.comment_refund_timeout_minutes*1e3;b&&b.seconds_left&&(c=1e3*b.seconds_left),setTimeout(function(){g(".refund").addClass("inactive"),g(".refund").unbind("click")},c)}}var w={requirePaywall:o,v2Init:h},x=null,y={comment_container:"comments_container",comment_button:"comments_activation",comment_count_class:".comment-count",display_comments_selector:"#comments_activation button",max_free_articles:4,grace_count:7e3,override_free_articles:!1,x_token_id:null,client_probe_url:null,comment_refund_timeout_minutes:15};g.extend(y,a),b&&b.disable_pluck?y.disable_pluck=!0:y.disable_pluck=!1;var z=!1;return w}(article_config,wfp_config,WFPUser,WFPWidget,WFPNewsHandler,WFPMyNews,$),app_config=app_config||{},WFPApp=function(a,b,c,d,e,f,g,h,i,j,k){function l(){j.init(E),i.myNewsPage()}function m(){k.when(j.init(E)).done(function(a){i.insiderPage()})}function n(){h.init(!0,!0);var a=d;a.force_login=!0,a.hard_redirect="/",window.location.hash&&"#payment"==window.location.hash&&(a.default_to_payment=!0),k.when(WFPUtils.getReady()).done(function(){if(h.isLoggedIn())h.openManageWithFetchInfo(a,!1);else{var b={sso_link:d.sso_link,sso_url:d.sso_url,force_login:!1};k.when(h.openLoginPromise(b)).done(function(){h.openManageWithFetchInfo(a,!1)})}})}function o(){h.init(!0,!0);var a={};k.when(WFPUtils.getReady()).done(function(){k.when(WFPModal.open()).done(function(b){WFPWidget.display("v4_modal_finalize_payment",a,function(a){return k(b).append(a),b})})})}function p(){h.init(!0,!0),k.when(WFPUtils.getReady()).done(function(){h.isLoggedIn()?h.openAccountLinkTrial(!0):k.when(h.openLoginPromise()).done(function(a){h.openAccountLinkTrial(!0)})})}function q(){E.free_with_valid_payment=!0,k.when(j.init(E)).done(function(a){("landing"!=a.url_type||J)&&t(a),J=!0})}function r(){k.when(j.init(E)).done(function(a){d.hasOwnProperty("site_name")?"Store"===d.site_name:(i.init(),WFPUtils.applySubscribeEvents())})}function s(a){E.disable_check_user_state=!!a,k.when(j.init(E)).done(function(a){if(window.wfp_config.spillbox_inited=!1,"landing"!=a.url_type||J){var b=[];t(a),J||(E.article&&b.push(E.article.id),g.init(b),w(!0))}else g.init(),g.setupTopCommented(),E.fetch_news?w():z("top");J=!0})}function t(a){var b=E.article;if(b){b.site_name=E.site_name;var c=a.charge_for_article&&!E.free_with_valid_payment;WFPArticle.v2Init(b,c,E.x_token_id,E.client_probe_url,a)}}function u(a){if(E.is_article_page){var b=[];E.article&&(b=[E.article.id]),g.init(b),v(!1),w(!0)}else g.init(),E.fetch_news?w():z("top");h.init(E.is_article_page&&0!==parseInt(E.article.cost,10)&&!E.maintenance_mode,a),i.init()}function v(a){var b=E.article;b&&(b.site_name=E.site_name,WFPArticle.init(b,E.x_token_id,E.client_probe_url,E.override_free_articles||E.maintenance_mode,a))}function w(a){Date.now=Date.now||function(){return+new Date};var b=Date.now(),c=setInterval(function(){return!y()||Date.now()-b>E.cxense_timeout?(clearInterval(c),f.setNewsSource("click"),void x(a)):void(y()&&(z("top"),clearInterval(c),x(a)))},50)}function x(a){if(a){var b=!0;C(b)}else E.is_columnist_page&&E.columnist_name.length&&f.setNewsSource("cxense_columnist_search",E.columnist_name),A()}function y(){return e&&"insertWidget"in e}function z(a,b){e.setSiteId(E.cxense_site_id),h.getId()&&e.addExternalId({id:h.getIdHash(),type:"wfp"});var c={};c=E.is_article_page?{location:E.article.url}:{location:location.href.replace("://beta.","://www.")},h.getUser("user_type")&&e.setCustomParameters({user_type:h.getUser("user_type")}),e.setCustomParameters({visibility:a}),c.location+="?cx_visibleArea="+a,b&&(c.location+="&cx_scrollCount="+b),e.sendPageViewEvent(c)}function A(){H++,k.when(g.displayWidgets()).done(function(){F++,C()}).fail(function(){B()})}function B(){k(".load-more").hide(),k(".preload").hide()}function C(b){var d=!1;k(window).scroll(function(){d=!0});var e,f;f=setInterval(function(){if(d){d=!1;var h=!1;h=b&&!G&&a&&a.hasOwnProperty("container")&&"WFP General Page"!==c.article.content_type?k(a.container).position().top-k(document).scrollTop()-k(window).height()<E.scroll_trigger_threshold:k(document).height()-k(document).scrollTop()-k(window).height()<E.scroll_trigger_threshold,h&&(G=!0,e&&"pending"==e.state()||(H++,e=g.displayWidgets(),k.when(e).done(function(){y()&&z("bottom",F),H>=I&&WFPUtils.removeWallpaperAds(),H>1&&H<I&&googletag.pubads().refresh([wallpaper])}).fail(function(){B(),clearInterval(f)})))}},250)}var D={init:u,myNews:l,insider:m,finalizePayment:o,passagesInit:q,genericPageInit:r,linkAccounts:p,myAccountWithPayment:n,v2Init:s,checkCxenseAvailable:y,initCxense:z},E={cxense_timeout:4e3,news_source:"cxense",cxense_site_id:"9222350621649330874",scroll_trigger_threshold:650,is_article_page:!1,is_columnist_page:!1,columnist_name:"",fetch_news:!0,x_token_id:"944D180E23DE414E9F102281B264F95A",client_probe_url:"https://emeter-uat.mppapi.io/probes/JSONP",override_free_articles:!1,site_name:"WFP News",maintenance_mode:!1,identity_test_delay:2e3,identity_test_logging:!1,free_with_valid_payment:!1};k.extend(E,c),d.site_name&&(E.site_name=d.site_name),E.maintenance_mode=!!d.maintenance_mode;var F=0,G=!1,H=0,I=3,J=!1;return D}(wfp_config,news_config,app_config,user_config,cX,WFPNewsHandler,WFPPlinko,WFPUser,WFPMyNews,WFPAuth,$),app_config=app_config||{},WFPSections=function(a,b,c,d,e){function f(){var a=[];return $.each(window.history.state.sections,function(b,c){var d=new $.Deferred;"bottom"===b?!function(a){$.when(t(b)).done(function(b){setTimeout(function(b){a.resolve(b)},0)})}(d):!function(a){$.when(q(b)).done(function(b){setTimeout(function(b){a.resolve(b)},0)})}(d),a.push(d)}),$.when.apply($,a).promise()}function g(a){z.disable_check_user_state=!!a,$.when(WFPAuth.init(z)).done(function(){if("scrollRestoration"in window.history&&(history.scrollRestoration="manual"),$(".section_container_breakingnews").show(),n(),k(),o(),E)$.when(f()).then(function(){WFPPlinko.setupTopCommented(),setTimeout(function(){if("undefined"!=typeof window.history.state.scroll_position){var a=window.history.state.scroll_position;$(window).scrollTop(a),F=!0}E=!1},1e3)});else{history.replaceState({},"Title");var a=p(!1);WFPUtils.isEmpty(a)||$.when(q(a)).done(function(){WFPPlinko.setupTopCommented(),F=!0})}$(".section-head:not(.breakingnews)").show()})}function h(a){var b=$.Deferred(),c="v5_section_config_"+a,d={};if(z.use_localStorage&&$.jStorage.storageAvailable()&&!WFPUtils.isEmpty($.jStorage.get(c)))d=$.jStorage.get(c),setTimeout(function(){b.resolve(d)},0);else{var e=$.ajax({url:z.sections_config_url,type:"post",data:"section="+a});!function(a){$.when(e).done(function(b){d=JSON.parse(b),z.use_localStorage&&$.jStorage.set(c,d,{TTL:z.section_localStorage_expired}),setTimeout(function(){a.resolve(d)},0)}).fail(function(b){a.reject(b)})}(b)}return b.promise()}function i(a){window.wfp_config=a.wfp_config,window.news_config=a.news_config;var b=window.wfp_config.widget_data.dynamic_spotlight_bars,c=[];b.length>2&&(c.push(b.shift()),c.push(b.pop()),window.wfp_config.widget_data.dynamic_spotlight_bars=c),WFPPlinko.setConfig(window.wfp_config),WFPNewsHandler.setConfig(window.news_config)}function j(a){window.wfp_config.section_render_loadmore=!1,window.wfp_config.news_widget_percentage=100;var b=!1,c=!1,d=!1,e=["v4_tile_fulltop","v4_tile_fulltop_alt","v4_tile_fulltop_spotlight"],f=[],g=[],h=0,i=0;if(window.wfp_config.editorial_override.forEach(function(a,d){"v4_tile_spillbox"===a.type&&(b=d),e.indexOf(a.type)>=0&&(c=d);var h=a.position;"fixed"===h.positioning&&parseInt(h.tile,10)>10?f.push(a):g.push(a)}),window.wfp_config.first_run.forEach(function(a,b){"v4_tile_double_adweather"===a.type&&(d=b)}),"breakingnews"===a){if(i=z.topsection_preload_tiles,b!==!1){var j=window.wfp_config.editorial_override[b];j.position.tile=11,window.wfp_config.editorial_override[b]=j}}else i=z.section_preload_tiles,window.wfp_config.editorial_override=g;h=WFPUtils.countTilesSize(window.wfp_config.editorial_override),h+=WFPUtils.countTilesSize(window.wfp_config.first_run),window.wfp_config.articles_per_refresh=i-h,c!==!1&&d!==!1&&(window.wfp_config.first_run[d].position.positioning="random"),WFPPlinko.setConfig(window.wfp_config),WFPPlinko.sectionInit(),WFPApp.checkCxenseAvailable()?WFPApp.initCxense("top"):WFPNewsHandler.setNewsSource("click")}function k(){$(".load-more").on("click",function(){var a=$(this).attr("rel");$.when(t(a)).done(function(){"bottom"===a&&(D=!0)})}),$(".section-head .entypo-minus-circled").on("click",function(){var a=$(this).parent().attr("rel");m(a),$(this).next().show(),$(this).hide(),$(".section_container_"+a).slideUp(),$(".section_container_"+a).addClass("closed-by-user"),$(".section_container_"+a).removeClass("open");var b=p(!1);WFPUtils.isEmpty(b)||q(b),$(".load-more-"+a).hide(),"breakingnews"!=a&&$(".section-head."+a+" .section-close-selector").show(),$(".section-head .section_title_"+a).show()}),$(".section-head .entypo-plus-circled").on("click",function(){WFPNewsHandler.setNewsSource("cxense");var a=$(this).parent().attr("rel");$(".section_container_"+a).show(),$(".section_container_"+a).removeClass("closed-by-user"),$(".section-head."+a+" .section-close-selector").hide(),q(a)})}function l(){var a=!1;$(window).scroll(function(){a=!0});var b,c;c=setInterval(function(){if(a&&F){if(a=!1,!b||"pending"!=b.state()){var d=p(!0);if(WFPUtils.isEmpty(d)){var e=$(".load-more-bottom");D&&WFPUtils.isElementInView(e,!0)&&$(document).height()-$(document).scrollTop()-$(window).height()<z.scroll_trigger_threshold&&(b=t("bottom"),$.when(b).done(function(a){}).fail(function(){clearInterval(c)}))}else $(".section_container_"+d).show(),b=q(d),$.when(b).done(function(a){}).fail(function(){clearInterval(c)})}WFPPlinko.commitScrollPosition()}},250)}function m(a){var b=!1;b=WFPUser.isLoggedIn()?WFPUser.getUser("sections_to_hide"):WFPUser.getCookie("sections_to_hide"),!WFPUtils.isEmpty(b)&&b.indexOf("|"+a)>-1&&($(".section_container_"+a).addClass("closed-by-user"),$(".section-head."+a+" .section-close-selector input").prop("checked",!0))}function n(){l(),$(".section-head").each(function(a,b){var c=$(b).attr("rel");"breakingnews"!=c&&$(".section-head."+c+" .section-close-selector").show(),m(c)}),$(".section-head .section-close-selector input").on("change",function(){var a=this,b=$(a).attr("name"),c=b.replace("hide-",""),d=!1;d=WFPUser.isLoggedIn()?WFPUser.getUser("sections_to_hide"):WFPUser.getCookie("sections_to_hide");var e=[];if(WFPUtils.isEmpty(d)||(e=d.split("|")),$(a).prop("checked")===!0)e.push(c);else{var f=[];$.each(e,function(a,b){b!=c&&f.push(b)}),e=f}d=e.join("|"),0!==d.indexOf("|")&&(d="|"+d),WFPUser.isLoggedIn()?WFPUser.setUser("sections_to_hide",d):WFPUser.setCookie("sections_to_hide",d)})}function o(){try{if(!WFPUtils.isEmpty(history.state.sections)){var a=history.state.sections.breakingnews;a&&(a.top.items.length||a.loadmore.items.length)&&2===window.performance.navigation.type&&!navigator.userAgent.match("CriOS")&&(E=!0)}}catch(a){WFPUtils.log("History State Not Supported")}}function p(a){var b=!1;return $(".section-head").each(function(c,d){var e=$(d).attr("rel");if(!$(".section_container_"+e).hasClass("closed-by-user")){var f=!1;if(C?$(".section_container_"+e).size()>0&&$(".section_container_"+e).is(":visible")&&(f=!0):C=!0,!f&&(!a||WFPUtils.isElementInView(d,!1)))return b=e,!1}}),b}function q(a){var b=$.Deferred();if(!$(".section_container_"+a).hasClass("open")){$(".section_container_"+a).addClass("open"),$(".section-head."+a+" .section-close-selector").hide();var c=".section_container_"+a;0!==$(c+" .preload").length?(A++,"breakingnews"!=a&&$(".section-head."+a).show(),$(".section-head."+a+" img.section-loader").show(),$(".load-more-bottom").show(),$.when(h(a)).done(function(d){i(d),window.wfp_config.section_render_loadmore=!1,window.wfp_config.section_name=a,window.wfp_config.container=".section_container_"+a,WFPPlinko.setConfig(window.wfp_config),j(a),function(b){$.when(WFPPlinko.displayWidgets()).done(function(){x(),$(".section-head."+a+" .entypo-plus-circled").hide(),$(c).slideDown(),$(".load-more-"+a).show(),$(".section-head."+a+" .entypo-minus-circled").show(),$(".section-head."+a+" img.section-loader").hide(),b.resolve()})}(b)})):($(".section-head."+a+" .entypo-minus-circled").show(),$(".section-head."+a+" .entypo-plus-circled").hide(),$(c).slideDown(),$(".load-more-"+a).show(),b.resolve()),$(".section-head .section_title_"+a).hide(),$(".section-head."+a+" .section-close-selector input").prop("checked",!1)}return b.promise()}function r(a){window.wfp_config.section_name=a,window.wfp_config.container=".section_container_"+a,window.wfp_config.section_render=!0,window.wfp_config.section_render_loadmore=!0,window.wfp_config.articles_per_refresh=20,window.wfp_config.news_widget_percentage=96,WFPPlinko.setConfig(window.wfp_config)}function s(a){var b=window.history.state.sections[a],c=[];return"undefined"!=typeof b&&(b.top.items.forEach(function(a,b){a.data&&a.data.id&&c.push(a.data.id)}),b.loadmore.items.forEach(function(a,b){a.data&&a.data.id&&c.push(a.data.id)})),c}function t(a){var b=$.Deferred();if(A++,"bottom"===a)if(WFPApp.checkCxenseAvailable()?WFPNewsHandler.setNewsSource("cxense_persisted"):(WFPNewsHandler.setNewsSource("click"),w("Ready for more? Load more news.")),a!==window.wfp_config.section_name)$.when(h("breakingnews")).done(function(c){i(c),r(a),WFPPlinko.sectionInit(),WFPPlinko.initSectionWidgetCache(E),function(a){$.when(WFPPlinko.displayWidgets()).done(function(){x(),$(window.wfp_config.container).slideDown(),a.resolve()})}(b)});else{if(r(a),E)WFPNewsHandler.clearNewsPipeline(a);else{var c=s(a);WFPNewsHandler.sectionInit({},{},c)}WFPPlinko.initSectionWidgetCache(E),$.when(WFPPlinko.displayWidgets()).done(function(){x(),b.resolve()})}else WFPApp.checkCxenseAvailable()?WFPNewsHandler.setNewsSource("cxense"):WFPNewsHandler.setNewsSource("click"),a!==window.wfp_config.section_name?$.when(h(a)).done(function(c){i(c),window.wfp_config.section_name=a,r(a),WFPPlinko.initSectionWidgetCache(E),function(a){$.when(WFPPlinko.displayWidgets()).done(function(){x(),a.resolve()})}(b)}):(r(a),WFPPlinko.initSectionWidgetCache(E),$.when(WFPPlinko.displayWidgets()).done(function(){x(),b.resolve()}));return b.promise()}function u(){if(!WFPSections.stickyLeaderboardInit){WFPSections.stickyLeaderboardInit=!0;var a=$(".top.new .top-ad-box").outerHeight()+$("header").outerHeight();$(window).scrollTop()<$(".top.new .top-ad-box").outerHeight()?($(".fixed.top").css({position:"relative"}),$("header").css({position:"relative",top:"0","margin-top":"0"}),$("#inner-wrap").css({"margin-top":"0"}),$("body").css({"border-top":"none"}),$("#fixedHeaderClose").css("margin-top","0"),$("header").removeClass("unstuck")):$(".top.new .top-ad-box").slideUp(300,function(){$(".fixed.top").css({position:"relative"}),$(".top.new .top-ad-box").show(),$("header").css({position:"fixed",top:"0","margin-top":"0"}),$("#inner-wrap").css({"margin-top":"0"}),$("body").css({"border-top":"none"}),$("#fixedHeaderClose").css("margin-top",$("header").outerHeight()+"px"),$(window).scrollTop()<a?$("header").removeClass("unstuck"):$("header").addClass("unstuck")}),$(window).scroll(function(){$(window).width()>800&&($(window).scrollTop()<$(".top.new .top-ad-box").outerHeight()?($("header").css({position:"relative"}),$("#fixedHeaderClose").css("margin-top","0"),$("header").removeClass("unstuck"),a=$(".top.new").outerHeight()):($(window).scrollTop()<a?$("header").removeClass("unstuck"):$("header").addClass("unstuck"),$("header").css({position:"fixed"}),$("#fixedHeaderClose").css("margin-top",$("header").outerHeight()+"px")))})}}function v(){D=!1}function w(a){$(".load-more-bottom p").text(a)}function x(){E||(A>=B&&WFPUtils.removeWallpaperAds(),A>1&&A<B&&"function"==typeof window.googletag.pubads&&googletag.pubads().refresh([wallpaper]))}var y={init:g,stickyLeaderboard:u,resetBottomScroll:v,setBottomWords:w},z={sections_config_url:"http://dev.www.winnipegfreepress.com/v5sectionsconfig/",topsection_preload_tiles:12,section_preload_tiles:9,scroll_trigger_threshold:650,section_localStorage_expired:18e4,use_localStorage:!0};$.extend(z,c),d.site_name&&(z.site_name=d.site_name);var A=0,B=3,C=!1,D=!0,E=!1,F=!1;return y}(wfp_config,news_config,app_config,user_config,cX);